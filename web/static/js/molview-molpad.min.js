/*! MolView JavaScript Sketcher build on 2016-06-13 */
function indev(a,b,c){return a>b-c&&b+c>a}function radSide(a,b){return angleBetween(a,b)<Math.PI?1:-1}function posRad(a){for(;0>a;)a+=PI2;for(;a>PI2;)a-=PI2;return a}function smallestAngleBetween(a,b){var c=Math.abs(posRad(a)-posRad(b));return PI2-c>c?c:PI2-c}function angleBetween(a,b){return a=posRad(a),b=posRad(b),a>=b?b-a+PI2:b-a}function clampedAngle(a,b,c,d){var e=b.angleTo(c),f=d/PI2;return posRad(Math.round((e-a)*f)/f+a)}function mapArray(a,b){for(var c=0;c<a.length;c++)void 0!==b[a[c]]?a[c]=b[a[c]]:(a.splice(c,1),c--);return a}function transformArrayMult(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]*b);return c}function transformArrayAdd(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]+b);return c}function oneOf(a,b){return-1!==b.indexOf(a)}function getMultiTouchDelta(a){var b=a.originalEvent.targetTouches;if(b.length<=1)return 0;var c=Math.abs(b[0].pageX-b[1].pageX),d=Math.abs(b[0].pageY-b[1].pageY);return Math.sqrt(c*c+d*d)}function sign(a){return a=+a,0===a||isNaN(a)?a:a>0?1:-1}function MPPoint(a,b){this.x=a||0,this.y=b||0}function MPPFO(a){return new MPPoint(a.x,a.y)}function MPLine(a){this.from=void 0!==a?a.from.clone()||new MPPoint:new MPPoint,this.to=void 0!==a?a.to.clone()||new MPPoint:new MPPoint}function MPAtom(a,b){this.mp=a,this.index=b.i,this.center=new MPPoint(b.x||0,b.y||0),this.element=b.element||"C",this.charge=b.charge||0,this.isotope=b.isotope||0,this.bonds=void 0!==b.bonds?b.bonds.slice():[],this.selected=b.selected||!1,this.display="normal",this.valid=!1,this.mp.requestRedraw()}function MPBond(a,b){this.mp=a,this.index=b.i,this.type=b.type||0,this.stereo=b.stereo||MP_STEREO_NONE,this.from=b.from||0,this.to=b.to||0,this.selected=b.selected||!1,this.display="normal",this.hidden=!1,this.valid=!1,this.mp.requestRedraw()}function MolPad(a,b,c){this.loadSettings(),this.tool={type:"bond",data:{type:MP_BOND_SINGLE},selection:[]},this.mol=new MPMolecule(this),this.sel=new MPSelection(this),this.buttons=c,this.container=jQuery(a),this.offset=this.container.offset(),this.devicePixelRatio=b||1,this.setupEventHandling(),this.setupGraphics()}function MPMolecule(a){this.atoms=[],this.bonds=[],this.stack=[],this.reverseStack=[],this.copy={atoms:[],bonds:[],fingerprint:""},this.mp=a}function MPSelection(a){this.cache={atoms:[],bonds:[]},this.mirrorSide=1,this.startAngle=0,this.currentAngle=0,this.mp=a}var JmolAtomColorsHashHex={D:"#111111",H:"#888888",He:"#849b9b",Li:"#c87efa",Be:"#82ab00",B:"#c38a8a",C:"#000000",N:"#304ff7",O:"#ff0d0d",F:"#6dab3c",Ne:"#7b9ca8",Na:"#ab5cf2",Mg:"#61b400",Al:"#a79191",Si:"#b09276",P:"#ff8000",S:"#c39517",Cl:"#1dc51d",Ar:"#63a2b0",K:"#8f40d4",Ca:"#2fc300",Sc:"#969696",Ti:"#94969a",V:"#96969a",Cr:"#8796c3",Mn:"#9c7ac7",Fe:"#e06633",Co:"#db8293",Ni:"#45b645",Cu:"#c78033",Zn:"#7d80b0",Ga:"#bd8c8c",Ge:"#668f8f",As:"#bd80e3",Se:"#e28f00",Br:"#a62929",Kr:"#53a6bc",Rb:"#702eb0",Sr:"#00d000",Y:"#5fa4a4",Zr:"#6ba2a2",Nb:"#61a4a9",Mo:"#4ea9a9",Tc:"#3b9e9e",Ru:"#248f8f",Rh:"#0a7d8c",Pd:"#006985",Ag:"#969696",Cd:"#ae9462",In:"#a67573",Sn:"#668080",Sb:"#9e63b5",Te:"#d47a00",I:"#940094",Xe:"#429eb0",Cs:"#57178f",Ba:"#00c900",La:"#57a4c5",Ce:"#989877",Pr:"#869d7b",Nd:"#7da07d",Pm:"#69a581",Sm:"#5ea883",Eu:"#43b089",Gd:"#31b48d",Tb:"#23b890",Dy:"#17bb92",Ho:"#00c578",Er:"#00c765",Tm:"#00c94e",Yb:"#00bf38",Lu:"#00ab24",Hf:"#42a8dc",Ta:"#4ba2f9",W:"#2194d6",Re:"#267dab",Os:"#266696",Ir:"#175487",Pt:"#9595a0",Au:"#b9981a",Hg:"#9595a9",Tl:"#a6544d",Pb:"#575961",Bi:"#9e4fb5",Po:"#ab5c00",At:"#754f45",Rn:"#428296",Fr:"#420066",Ra:"#007d00",Ac:"#669ce4",Th:"#00b8fc",Pa:"#00a1ff",U:"#008fff",Np:"#0080ff",Pu:"#006bff",Am:"#545cf2",Cm:"#785ce3",Bk:"#8a4fe3",Cf:"#a136d4",Es:"#b31fd4",Fm:"#B31FBA",Md:"#B30DA6",No:"#BD0D87",Lr:"#C70066",Rf:"#CC0059",Db:"#D1004F",Sg:"#D90045",Bh:"#E00038",Hs:"#E6002E",Mt:"#EB0026",Ds:"#9595a0",Rg:"#b9981a",Cn:"#9595a9"},PI2=2*Math.PI;MPPoint.prototype.clone=function(){return new MPPoint(this.x,this.y)},MPPoint.prototype.equals=function(a){return this.x===a.x&&this.y===a.y},MPPoint.prototype.set=function(a,b){this.x=a,this.y=b},MPPoint.prototype.replace=function(a){this.x=a.x,this.y=a.y},MPPoint.prototype.add=function(a){this.x+=a.x,this.y+=a.y},MPPoint.prototype.addX=function(a){this.x+=a},MPPoint.prototype.addY=function(a){this.y+=a},MPPoint.prototype.divide=function(a){this.x/=a,this.y/=a},MPPoint.prototype.divideX=function(a){this.x/=a},MPPoint.prototype.divideY=function(a){this.y/=a},MPPoint.prototype.multiply=function(a){this.x*=a,this.y*=a},MPPoint.prototype.multiplyX=function(a){this.x*=a},MPPoint.prototype.multiplyY=function(a){this.y*=a},MPPoint.prototype.translate=function(a,b){this.x+=a,this.y+=b},MPPoint.prototype.scale=function(a){this.x*=a,this.y*=a},MPPoint.prototype.mirror=function(a,b){if(this.lineSide(a)!==b){var c=a.to.x-a.from.x,d=a.to.y-a.from.y;if(Math.abs(c)<.001)this.x=2*a.from.x-this.x;else{var e=d/c,f=a.from.y-e*a.from.x,g=(this.x+(this.y-f)*e)/(1+e*e);this.x=2*g-this.x,this.y=2*g*e-this.y+2*f}return!0}return!1},MPPoint.prototype.lineSide=function(a){var b=sign((a.to.x-a.from.x)*(this.y-a.from.y)-(a.to.y-a.from.y)*(this.x-a.from.x));return b>0?1:0>b?-1:0},MPPoint.prototype.rotateAroundCenter=function(a,b){var c=this.x-a.x,d=this.y-a.y;this.x=c*Math.cos(-b)-d*Math.sin(-b)+a.x,this.y=c*Math.sin(-b)+d*Math.cos(-b)+a.y},MPPoint.prototype.angleTo=function(a){return Math.atan2(-a.y+this.y,a.x-this.x)},MPPoint.prototype.inCircle=function(a,b){return(this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y)<b*b},MPPoint.prototype.inLineBox=function(a,b,c){var d={},e={};return a.x<b.x?(d.x=a.x,e.x=b.x):(d.x=b.x,e.x=a.x),a.y<b.y?(d.y=a.y,e.y=b.y):(d.y=b.y,e.y=a.y),!(this.x<d.x-c||this.x>e.x+c||this.y<d.y-c||this.y>e.y+c)},MPPoint.prototype.inCircleBox=function(a,b){return!(this.x<a.x-b||this.x>a.x+b||this.y<a.y-b||this.y>a.y+b)},MPPoint.prototype.inRect=function(a){var b=a.x,c=a.y,d=a.width,e=a.height;return 0>d&&(d=-d,b-=d),0>e&&(e=-e,c-=e),this.x>b&&this.x<b+d&&this.y>c&&this.y<c+e},MPPoint.prototype.inPolygon=function(a){for(var b=!1,c=0,d=a.length-1;c<a.length;d=c++)a[c].y>this.y!=a[d].y>this.y&&this.x<(a[d].x-a[c].x)*(this.y-a[c].y)/(a[d].y-a[c].y)+a[c].x&&(b=!b);return b},MPPoint.prototype.lineDistance=function(a,b){var c,d,e=this.x-a.x,f=this.y-a.y,g=b.x-a.x,h=b.y-a.y,i=e*g+f*h,j=g*g+h*h,k=i/j;0>k||a.x===b.x&&a.y===b.y?(c=a.x,d=a.y):k>1?(c=b.x,d=b.y):(c=a.x+k*g,d=a.y+k*h);var l=this.x-c,m=this.y-d;return Math.sqrt(l*l+m*m)},MPPoint.prototype.distanceTo=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))},MPPoint.prototype.fromPointer=function(a){var b=a.originalEvent;return b.targetTouches&&b.targetTouches.length>0?this.set(b.targetTouches[0].pageX,b.targetTouches[0].pageY):this.set(b.pageX,b.pageY),this},MPPoint.prototype.fromRelativePointer=function(a,b){return this.fromPointer(a),this.x=(this.x-b.offset.left)*b.devicePixelRatio,this.y=(this.y-b.offset.top)*b.devicePixelRatio,this.x=(this.x-b.matrix[4])/b.matrix[0],this.y=(this.y-b.matrix[5])/b.matrix[3],this},MPPoint.prototype.fromMultiTouchCenter=function(a){var b=a.originalEvent.targetTouches;if(b.length>1){this.x=b[0].pageX,this.y=b[0].pageY;for(var c=1;c<b.length;c++)this.x+=b[c].pageX,this.y+=b[c].pageY;this.x/=b.length,this.y/=b.length}return this},MPLine.prototype.intersection=function(a){var b=(a.to.y-a.from.y)*(this.to.x-this.from.x)-(a.to.x-a.from.x)*(this.to.y-this.from.y);if(0===b)return{p:void 0,onL1:!1,onL2:!1};var c=this.from.y-a.from.y,d=this.from.x-a.from.x,e=(a.to.x-a.from.x)*c-(a.to.y-a.from.y)*d,f=(this.to.x-this.from.x)*c-(this.to.y-this.from.y)*d;return c=e/b,d=f/b,{p:MPPFO({x:this.from.x+c*(this.to.x-this.from.x),y:this.from.y+c*(this.to.y-this.from.y)}),onL1:c>0&&1>c,onL2:d>0&&1>d}},MPLine.prototype.length=function(){return this.from.distanceTo(this.to)};var MPFragments={benzene:{},cyclopropane:{},cyclobutane:{},cyclopentane:{},cyclohexane:{},cycloheptane:{},length:1,lengthHydrogen:34/55,init:function(){this.benzene=this.generateRing(6,!0),this.cyclopropane=this.generateRing(3,!1),this.cyclobutane=this.generateRing(4,!1),this.cyclopentane=this.generateRing(5,!1),this.cyclohexane=this.generateRing(6,!1),this.cycloheptane=this.generateRing(7,!1)},generateRing:function(a,b){var c=PI2/a,d=.5/Math.sin(c/2)*this.length,e={full:this.createRing(a,b?2:0),toAtom:this.translate(this.createRing(a,b?2:0),d,0),toBond:this.rotate(this.translate(this.createRing(a,b?2:0),d,0),{x:0,y:0},(Math.PI-c)/2)};return e},createRing:function(a,b){var c={atoms:[],bonds:[]},d=PI2/a;c.r=.5/Math.sin(d/2)*this.length;for(var e=0;a>e;e++)c.atoms.push({center:new MPPoint(c.r*Math.cos(Math.PI+d*e),c.r*Math.sin(Math.PI+d*e)),element:"C"}),c.bonds.push({from:e,to:a>e+1?e+1:0,type:0!==b?e%2===2-b?MP_BOND_SINGLE:MP_BOND_DOUBLE:MP_BOND_SINGLE});return c},clone:function(a){for(var b={atoms:[],bonds:[],r:a.r},c=0;c<a.atoms.length;c++)b.atoms.push({center:a.atoms[c].center.clone(),element:a.atoms[c].element});for(var c=0;c<a.bonds.length;c++)b.bonds.push({from:a.bonds[c].from,to:a.bonds[c].to,type:a.bonds[c].type});return b},scale:function(a,b){for(var c=0;c<a.atoms.length;c++)a.atoms[c].center.scale(b);return a},rotate:function(a,b,c){for(var d=0;d<a.atoms.length;d++)a.atoms[d].center.rotateAroundCenter(b,c);return a},translate:function(a,b,c){for(var d=0;d<a.atoms.length;d++)a.atoms[d].center.translate(b,c);return a}};MPAtom.prototype.getX=function(){return this.center.x},MPAtom.prototype.getY=function(){return this.center.y},MPAtom.prototype.getKetcherData=function(){return new chem.Struct.Atom({pp:{x:this.center.x/this.mp.s.bond.length,y:this.center.y/this.mp.s.bond.length},label:this.element,charge:this.charge,isotope:this.isotope})},MPAtom.prototype.getConfig=function(){return{i:this.index,x:this.center.x,y:this.center.y,element:this.element,charge:this.charge,isotope:this.isotope,bonds:this.bonds.slice()}},MPAtom.prototype.toString=function(){for(var a=this.center.x.toString()+","+this.center.y.toString()+","+this.element.toString()+","+this.charge.toString()+","+this.isotope.toString(),b=0;b<this.bonds.length;b++)a+=","+this.mp.mol.bonds[this.bonds[b]].toString();return a},MPAtom.prototype.getChargeLabel=function(){return 0===this.charge?"":-1===this.charge?"−":1===this.charge?"+":(this.charge>1?"+":"-")+Math.abs(this.charge)},MPAtom.prototype.setIndex=function(a){this.index=a},MPAtom.prototype.setCenter=function(a,b){this.center.replace(a,b),this.centerChanged()},MPAtom.prototype.setElement=function(a){this.element="D"===a?"H":a,this.labelChanged()},MPAtom.prototype.setCharge=function(a){this.charge=a,this.labelChanged()},MPAtom.prototype.setIsotope=function(a){this.isotope=a,this.labelChanged()},MPAtom.prototype.setDisplay=function(a){a!==this.display&&(this.display=a,this.mp.requestRedraw())},MPAtom.prototype.equals=function(a){return this.index===a.index},MPAtom.prototype.getSelectedBonds=function(){for(var a=0,b=0;b<this.bonds.length;b++)this.mp.mol.bonds[this.bonds[b]].isSelected()&&a++;return a},MPAtom.prototype.getNeighborBond=function(a){for(var b=0;b<this.bonds.length;b++)if(this.mp.mol.bonds[this.bonds[b]].getOppositeAtom(this.index)===a)return this.bonds[b];return-1},MPAtom.prototype.hasUnselectedNeighbors=function(){for(var a=0;a<this.bonds.length;a++)if(!this.mp.mol.atoms[this.mp.mol.bonds[this.bonds[a]].getOppositeAtom(this.index)].isSelected())return!0;return!1},MPAtom.prototype.isSelected=function(){return this.selected},MPAtom.prototype.isImplicit=function(){if("H"===this.element&&0===this.isotope&&0===this.charge&&1===this.bonds.length){var a=this.mp.mol.bonds[this.bonds[0]];if(a.type===MP_BOND_SINGLE&&a.stereo===MP_STEREO_NONE&&a.isPair("C","H"))return!0}return!1},MPAtom.prototype.isHidden=function(){return"hidden"===this.display},MPAtom.prototype.isVisible=function(){return this.wasVisible===!0},MPAtom.prototype.select=function(a){this.isSelected()!==a&&(this.selected=a,this.mp.sel.update(),this.mp.requestRedraw())},MPAtom.prototype.translate=function(a,b){Math.abs(a)+Math.abs(b)>0&&(this.center.translate(a,b),this.centerChanged())},MPAtom.prototype.mirror=function(a,b){this.center.mirror(a,b)&&this.centerChanged()},MPAtom.prototype.rotateAroundCenter=function(a,b){this.center.rotateAroundCenter(a,b),this.centerChanged()},MPAtom.prototype.getBondCount=function(){for(var a=0,b=0;b<this.bonds.length;b++)a+=this.mp.mol.bonds[this.bonds[b]].type;return a},MPAtom.prototype.addBond=function(a){-1===this.bonds.indexOf(a)&&(this.bonds.push(a),this.bondsChanged())},MPAtom.prototype.removeBond=function(a){var b=this.bonds.indexOf(a);-1!==b&&(this.bonds.splice(b,1),this.bondsChanged())},MPAtom.prototype.mapBonds=function(a){var b=this.bonds.length;this.bonds=mapArray(this.bonds,a),this.bonds.length!==b&&this.bondsChanged()},MPAtom.prototype.replaceBond=function(a,b){var c=this.bonds.indexOf(a),d=this.bonds.indexOf(b);-1!==c&&(-1!==d?this.bonds.splice(a,1):this.bonds[c]=b),this.bondsChanged()},MPAtom.prototype.addNewBond=function(a){var b=new MPAtom(this.mp,{i:this.mp.mol.atoms.length,x:this.getX()+(a.length||this.mp.s.bond.length)*Math.cos(a.a),y:this.getY()-(a.length||this.mp.s.bond.length)*Math.sin(a.a),element:a.element||"C"}),c=new MPBond(this.mp,{i:this.mp.mol.bonds.length,type:a.type||MP_BOND_SINGLE,stereo:a.stereo||MP_STEREO_NONE,from:this.index,to:b.index});return this.mp.mol.atoms.push(b),this.mp.mol.bonds.push(c),b.addBond(c.index),this.addBond(c.index),{atom:b.index,bond:c.index,startAngle:a.a,currentAngle:a.a}},MPAtom.prototype.addImplicitHydrogen=function(){if("C"===this.element){if(2===this.getBondCount()&&2===this.bonds.length){var a=this.mp.mol.bonds[this.bonds[0]].getAngle(this),b=this.mp.mol.bonds[this.bonds[1]].getAngle(this),c=Math.max(a,b)-Math.min(a,b);if(indev(c,Math.PI,this.mp.s.bond.angleDev)){var d=this.calculateNewBondAngle(2);if(0===d)return;return this.addNewBond({a:d[0],length:this.mp.s.bond.lengthHydrogen,element:"H"}),void this.addNewBond({a:d[1],length:this.mp.s.bond.lengthHydrogen,element:"H"})}}for(;this.getBondCount()<4;){this.cmap=this.calculateConnectionMap();var d=this.calculateNewBondAngle();this.addNewBond({a:d,length:this.mp.s.bond.lengthHydrogen,element:"H"})}}},MPAtom.prototype.invalidate=function(){this.valid=!1,this.mp.requestRedraw()},MPAtom.prototype.centerChanged=function(){this.invalidate();for(var a=0;a<this.bonds.length;a++)this.mp.mol.bonds[this.bonds[a]].invalidate(),this.mp.mol.atoms[this.mp.mol.bonds[this.bonds[a]].getOppositeAtom(this.index)].bondsChanged(!0);this.cmap=this.calculateConnectionMap()},MPAtom.prototype.labelChanged=function(){this.invalidate(),this.line=void 0;for(var a=0;a<this.bonds.length;a++)this.mp.mol.bonds[this.bonds[a]].invalidate(),this.mp.mol.atoms[this.mp.mol.bonds[this.bonds[a]].getOppositeAtom(this.index)].bondsChanged()},MPAtom.prototype.bondsChanged=function(a){if(this.invalidate(),this.mp.s.skeletalDisplay)for(var b=0;b<this.bonds.length;b++)this.mp.mol.bonds[this.bonds[b]].invalidate()},MPAtom.prototype.validate=function(){this.valid||(this.valid=!0,this.wasVisible=this.calculateVisibility(),this.cmap=this.calculateConnectionMap(),void 0===this.line&&(this.line=this.calculateCenterLine()))},MPAtom.prototype.drawStateColor=function(){if(!this.isHidden()&&void 0!==this.line){var a=!1;if("hover"===this.display||"active"===this.display||"normal"===this.display&&this.isSelected()||a){var b=a?"incorrect":this.isSelected()?"selected":this.display;this.mp.ctx.beginPath(),this.line.area.point?(this.mp.ctx.arc(this.center.x,this.center.y,this.mp.s.atom.selectionRadiusScaled,0,PI2),this.mp.ctx.fillStyle=this.mp.s.atom[b].color,this.mp.ctx.fill()):(this.mp.ctx.moveTo(this.center.x+this.line.area.left,this.center.y),this.mp.ctx.lineTo(this.center.x+this.line.area.right,this.center.y),this.mp.ctx.strokeStyle=this.mp.s.atom[b].color,this.mp.ctx.stroke())}}},MPAtom.prototype.drawLabel=function(){if(!this.isHidden()&&void 0!==this.line&&this.isVisible())if(this.mp.s.atom.colored&&(this.mp.ctx.fillStyle=JmolAtomColorsHashHex[this.element]||JmolAtomColorsHashHex.C),this.mp.s.atom.miniLabel){var a=this.mp.s.atom.miniLabelSize;this.mp.ctx.fillRect(this.center.x-a/2,this.center.y-a/2,a,a)}else{var b=this.center.x+this.line.text.offsetLeft;this.isotope>0&&(this.mp.setFont("isotope"),this.mp.ctx.fillText(""+this.isotope,b,this.center.y+this.line.text.offsetTop-this.line.text.isotopeHeight),b+=this.line.text.isotopeWidth),this.mp.setFont("element"),this.mp.ctx.fillText(""+this.element,b,this.center.y+this.line.text.offsetTop),b+=this.line.text.labelWidth,0!==this.charge&&(this.mp.setFont("charge"),this.mp.ctx.fillText(this.getChargeLabel(),b,this.center.y+this.line.text.offsetTop-this.line.text.chargeHeight))}},MPAtom.prototype.calculateConnectionMap=function(){if(0===this.bonds.length)return 0;for(var a=[],b=0;b<this.bonds.length;b++)a.push({i:this.bonds[b],a:this.mp.mol.bonds[this.bonds[b]].getAngle(this)});a.sort(function(a,b){return a.a-b.a});for(var c=[],b=0;b<a.length;b++){var d=0===b?a.length-1:b-1,e=b;c.push({from:d,to:e,a:angleBetween(a[d].a,a[e].a)})}return{bondMap:a,sections:c}},MPAtom.prototype.calculateClosestBonds=function(a){for(var b=0;b<this.cmap.bondMap.length;b++)if(this.cmap.bondMap[b].i===a){var c=b+1<this.cmap.bondMap.length?b+1:0,d=b-1>=0?b-1:this.cmap.bondMap.length-1;return{none:!1,upper:this.cmap.bondMap[c].i,lower:this.cmap.bondMap[d].i,upperBisectAngle:(this.cmap.bondMap[c].a+this.cmap.bondMap[b].a)/2,lowerBisectAngle:(this.cmap.bondMap[d].a+this.cmap.bondMap[b].a)/2,upperSectionAngle:angleBetween(this.cmap.bondMap[b].a,this.cmap.bondMap[c].a),lowerSectionAngle:angleBetween(this.cmap.bondMap[d].a,this.cmap.bondMap[b].a)}}return{none:!0}},MPAtom.prototype.calculateNewBondAngle=function(a){if(0===this.bonds.length||void 0===this.cmap)return 0;for(var b=0,c=1;c<this.cmap.sections.length;c++)this.cmap.sections[c].a>this.cmap.sections[b].a&&(b=c);if(void 0===a)return this.cmap.bondMap[this.cmap.sections[b].from].a+this.cmap.sections[b].a/2;for(var d=this.cmap.sections[b].a/(a+1),e=[],c=1;a>=c;c++)e.push(this.cmap.bondMap[this.cmap.sections[b].from].a+c*d);return e},MPAtom.prototype.calculateCenterLine=function(){if(this.mp.s.atom.miniLabel)return{text:{offsetLeft:0,offsetTop:0},area:{point:!0}};var a=this.mp.s.atom.scale,b={};this.mp.setFont("element"),b.labelWidth=this.mp.ctx.measureText(""+this.element).width;var c=b.labelWidth;this.isotope>0&&(this.mp.setFont("isotope"),b.isotopeHeight=this.mp.s.fonts.isotope.fontSize*a,b.isotopeWidth=this.mp.ctx.measureText(""+this.isotope).width+this.mp.s.atom.isotope.padding*a,c+=b.isotopeWidth),0!==this.charge&&(this.mp.setFont("charge"),b.chargeHeight=this.mp.s.fonts.charge.fontSize*a,b.chargeWidth=this.mp.ctx.measureText(""+this.getChargeLabel()).width,b.labelWidth+=this.mp.s.atom.charge.padding*a,c+=b.chargeWidth+this.mp.s.atom.charge.padding*a);var d=this.mp.s.fonts.element.fontSize*a,e=c/2;if(b.offsetLeft=-e,b.offsetTop=d/2,c>this.mp.s.atom.circleClamp){var f=this.mp.s.atom.radius*a-d/2;return{text:b,area:{half:e+f,left:-e+f,right:e-f}}}return{text:b,area:{point:!0}}},MPAtom.prototype.calculateBondVertices=function(a,b){var c=this.mp.mol.atoms[a].center;return this._calculateBondVertices(c,b)},MPAtom.prototype._calculateBondVertices=function(a,b){if(a.x===this.center.x||this.hidden||void 0===this.line){for(var c=[],d=this.isVisible()?this.mp.s.atom.radius:0,e=a.y<this.center.y,f=0;f<b.length;f++)c.push(MPPFO({x:this.center.x+(e?b[f]:-b[f]),y:this.center.y+(e?-d:d)}));return c}if(a.y===this.center.y){for(var c=[],d=this.isVisible()?this.line.area.half||this.mp.s.atom.radius:0,g=a.x>this.center.x,f=0;f<b.length;f++)c.push(MPPFO({x:this.center.x+(g?d:-d),y:this.center.y+(g?b[f]:-b[f])}));return c}if(this.isVisible()){var h=this.center,i=this.center,j=1;this.line.area.left&&a.x<this.center.x?h=new MPPoint(this.center.x+this.line.area.left,this.center.y):this.line.area.right&&a.x>this.center.x&&(h=new MPPoint(this.center.x+this.line.area.right,this.center.y),j=-1);for(var k=Math.abs(h.x-i.x),d=this.mp.s.atom.radius,l=a.x-i.x,m=a.y-i.y,n=Math.sqrt(l*l+m*m),o=l/n,p=m/n,q=j>0?d-o*k:d+o*k,r=o*q,s=p*q,t=i.x+r,u=i.y+s,c=[],f=0;f<b.length;f++)c.push(MPPFO({x:t-p*b[f],y:u+o*b[f]}));return c}if(1===b.length&&0===b[0])return[MPPFO({x:this.center.x,y:this.center.y})];for(var l=a.x-this.center.x,m=a.y-this.center.y,n=Math.sqrt(l*l+m*m),o=l/n,p=m/n,c=[],f=0;f<b.length;f++)c.push(MPPFO({x:-p*b[f],y:o*b[f]}));for(var f=0;f<c.length;f++)c[f].x+=this.center.x,c[f].y+=this.center.y;return c},MPAtom.prototype.calculateVisibility=function(){if(this.isHidden())return!1;if(this.mp.s.skeletalDisplay){if("C"===this.element&&0===this.charge&&0===this.isotope){if(0===this.bonds.length)return!0;if(2===this.bonds.length&&this.mp.mol.bonds[this.bonds[0]].type===this.mp.mol.bonds[this.bonds[1]].type&&this.mp.mol.bonds[this.bonds[0]].stereo===this.mp.mol.bonds[this.bonds[1]].stereo){var a=this.mp.mol.bonds[this.bonds[0]].getAngle(this),b=this.mp.mol.bonds[this.bonds[1]].getAngle(this),c=Math.max(a,b)-Math.min(a,b);return!!indev(c,Math.PI,this.mp.s.bond.angleDev)}return!1}return!0}return!0},MPAtom.prototype.getHandler=function(){return"atom"===this.mp.tool.type?{scope:this,data:{},onPointerDown:function(a,b){this.data={atom:-1,oldElement:this.scope.element},this.scope.setElement(b.tool.data.element)},onPointerMove:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b);c.inCircle(this.scope.center,b.s.atom.minAddRotateLength)||(-1===this.data.atom&&(this.scope.setElement(this.data.oldElement),this.data.startAngle=this.scope.calculateNewBondAngle(),this.data=this.scope.addNewBond({a:this.data.startAngle,type:b.tool.data.type||MP_BOND_SINGLE,stereo:b.tool.data.stereo||MP_STEREO_NONE,element:b.tool.data.element})),this.data.currentAngle=b.mol.rotateAtoms(this.scope.center,c,[this.data.atom],this.data.currentAngle,this.data.startAngle,b.s.rotateSteps))},onPointerUp:function(a,b){-1!==this.data.atom&&b.mol.collapseAtoms([this.data.atom],!0)}}:"bond"===this.mp.tool.type?{scope:this,data:{},onPointerDown:function(a,b){var c=this.scope.calculateNewBondAngle();this.data=this.scope.addNewBond({a:c,type:b.tool.data.type||MP_BOND_SINGLE,stereo:b.tool.data.stereo||MP_STEREO_NONE,element:b.tool.data.element})},onPointerMove:function(a,b){for(var c=(new MPPoint).fromRelativePointer(a,b),d=b.mol.bonds[this.data.bond],e=0;e<b.mol.atoms.length;e++)if(e!==this.scope.index&&e!==this.data.atom&&b.mol.atoms[e].handle(c,"active")){if(d.to!==e){b.mol.atoms[d.to].setDisplay("normal"),b.mol.atoms[d.to].removeBond(d.index),b.mol.atoms[this.data.atom].setDisplay("hidden"),d.setTo(e),b.mol.atoms[e].addBond(d.index);var f=this.scope.getNeighborBond(e);-1!==f&&f!==this.data.bond?f!==this.data.neighbor&&(this.data.neighbor=f,b.mol.bonds[f].setDisplay("hidden")):void 0!==this.data.neighbor&&(b.mol.bonds[this.data.neighbor].setDisplay("normal"),this.data.neighbor=void 0)}return}d.to!==this.data.atom&&(b.mol.atoms[this.data.atom].setDisplay("normal"),void 0!==this.data.neighbor&&(b.mol.bonds[this.data.neighbor].setDisplay("normal"),this.data.neighbor=void 0),b.mol.atoms[d.to].removeBond(d.index),b.mol.atoms[this.data.atom].addBond(d.index),d.setTo(this.data.atom)),c.inCircle(this.scope.center,b.s.atom.minAddRotateLength)||(this.data.currentAngle=b.mol.rotateAtoms(this.scope.center,c,[this.data.atom],this.data.currentAngle,this.data.startAngle,b.s.rotateSteps))},onPointerUp:function(a,b){var c=b.mol.bonds[this.data.bond].to;c!==this.data.atom?(b.mol.atoms[c].addBond(this.data.bond),b.mol.atoms.pop(),void 0!==this.data.neighbor&&(b.mol.bonds.splice(this.data.neighbor,1),b.mol.updateIndices())):b.mol.collapseAtoms([c],!0)}}:"fragment"===this.mp.tool.type?{scope:this,data:{},onPointerDown:function(a,b){var c=this.scope.getBondCount()>2&&"C"===this.scope.element;this.data={frag:MPFragments.translate(MPFragments.scale(MPFragments.translate(MPFragments.clone(b.tool.data.frag.toAtom),c?1:0,0),b.s.bond.length),this.scope.center.x,this.scope.center.y)},b.sel.clear(),b.sel.currentAngle=b.sel.startAngle=this.scope.calculateNewBondAngle(),b.sel.center=this.scope.center.clone(),MPFragments.rotate(this.data.frag,this.scope.center,b.sel.currentAngle);var d=b.mol.createFragment(this.data.frag,!0);if(c){var e=new MPBond(b,{i:b.mol.bonds.length,type:MP_BOND_SINGLE,stereo:MP_STEREO_NONE,from:this.scope.index,to:d.atoms[0],selected:!0});b.mol.bonds.push(e),b.mol.atoms[e.to].addBond(e.index),this.scope.addBond(e.index),this.scope.select(!0)}else b.mol.mergeAtoms(d.atoms[0],this.scope.index)},onPointerMove:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b);c.inCircle(this.scope.center,b.s.atom.minAddRotateLength)||b.sel.rotate(c)},onPointerUp:function(a,b){b.sel.collapse(),b.sel.clear()}}:"charge"===this.mp.tool.type?{scope:this,onPointerDown:function(a,b){this.scope.setCharge(this.scope.charge+b.tool.data.charge)}}:"chain"===this.mp.tool.type?{scope:this,data:{startAngle:0,length:this.mp.s.bond.length*Math.cos(this.mp.s.chain.devAngle),chain:[],ra:void 0},onDraw:function(a){a.ctx.strokeStyle=a.s.chain.strokeStyle,a.ctx.lineWidth=a.s.bond.width*a.s.bond.scale,a.ctx.lineCap=a.s.chain.lineCap,a.ctx.lineJoin=a.s.chain.lineJoin,a.ctx.setLineDash([2*a.s.bond.scale,5*a.s.bond.scale]),a.ctx.beginPath();for(var b=0;b<this.data.chain.length;b++)0===b?a.ctx.moveTo(this.data.chain[b].x,this.data.chain[b].y):a.ctx.lineTo(this.data.chain[b].x,this.data.chain[b].y);if(a.ctx.stroke(),this.data.chain.length>0){a.setFont("chainSize"),a.ctx.fillStyle=a.s.chain.color;var c=""+this.data.size,d=a.ctx.measureText(c).width,e=a.s.atom.scale*a.s.fonts.chainSize.fontSize,f=this.data.chain[this.data.chain.length-1].clone(),g=a.s.atom.scale*a.s.chain.padding+(d>e?d:e);f.x+=g*Math.cos(this.data.a),f.y+=g*Math.sin(-this.data.a),f.x-=d/2,f.y+=e/2,a.ctx.fillText(c,f.x,f.y)}},onPointerDown:function(a,b){this.data.startAngle=this.scope.calculateNewBondAngle(),1===this.scope.bonds.length?this.data.ra=posRad(b.mol.bonds[this.scope.bonds[0]].getAngle(this.scope)+Math.PI):2===this.scope.bonds.length?this.data.ra=posRad(this.scope.calculateNewBondAngle()+Math.PI):this.data.ra=void 0},onPointerMove:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b),d=clampedAngle(this.data.startAngle,this.scope.center,c,b.s.chain.rotateSteps),e=Math.floor(this.scope.center.distanceTo(c)/this.data.length);if(d!==this.data.a||e!==this.data.size){this.data.a=d,this.data.size=e;var f=this.data.a>-Math.PI/2&&this.data.a<Math.PI/2?1:-1,g=this.data.a+f*b.s.chain.devAngle;if(void 0!==this.data.ra){var h=this.data.a-f*b.s.chain.devAngle;smallestAngleBetween(g,this.data.ra)<smallestAngleBetween(h,this.data.ra)&&(g=h)}var i=this.data.length*Math.cos(this.data.a),j=this.data.length*Math.sin(-this.data.a),k=b.s.bond.length*Math.cos(g),l=b.s.bond.length*Math.sin(-g);this.data.chain=[];for(var m=this.scope.center.clone(),n=0;n<this.data.size;n++)n%2===0?this.data.chain.push(MPPFO({x:m.x+k,y:m.y+l})):(m.x+=2*i,m.y+=2*j,this.data.chain.push(m.clone()));this.data.chain.length>0&&this.data.chain.unshift(this.scope._calculateBondVertices(this.data.chain[0],[0])[0]),b.requestRedraw()}},onPointerUp:function(a,b){for(var c=this.scope,d=[],e=1;e<this.data.chain.length;e++){var f=new MPAtom(b,{i:b.mol.atoms.length,x:this.data.chain[e].x,y:this.data.chain[e].y,element:"C"});b.mol.atoms.push(f),d.push(f.index);var g=new MPBond(b,{i:b.mol.bonds.length,from:c.index,to:f.index,type:MP_BOND_SINGLE});b.mol.bonds.push(g),c.addBond(g.index),f.addBond(g.index),c=f}b.mol.collapseAtoms(d,!0)}}:"erase"===this.mp.tool.type?{scope:this,onPointerDown:function(a,b){this.scope.isSelected()?b.sel.remove():b.mol.removeAtom(this.scope.index,!0),b.pointer.handler=void 0}}:{scope:this,data:{},onPointerDown:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b);b.sel.hasCenter()&&(b.sel.startAngle=b.sel.currentAngle=b.sel.center.angleTo(c))},onPointerMove:function(a,b){b.setCursor("move");var c=(new MPPoint).fromRelativePointer(a,b),d=c.x-b.pointer.old.r.x,e=c.y-b.pointer.old.r.y;(Math.sqrt(d*d+e*e)>b.s.draggingThreshold||this.data.moved)&&(this.data.moved=!0,this.scope.isSelected()?b.sel.hasCenter()&&b.sel.centerAtom!==this.scope.index?b.sel.rotate(c):b.sel.translate(d,e):this.scope.translate(c.x-b.pointer.old.r.x,c.y-b.pointer.old.r.y),b.pointer.old.r=c)},onPointerUp:function(a,b){!this.data.moved&&oneOf(b.tool.type,["select","drag"])?(this.scope.select(!this.scope.isSelected()),b.sel.updateRotationCenter()):(this.scope.isSelected()?b.sel.collapse():b.mol.collapseAtoms([this.scope.index],!0),b.sel.updateRotationCenter())}}},MPAtom.prototype.handle=function(a,b){if(void 0===this.line)return!1;var c=this.mp.s.atom.selectionRadiusScaled;if(this.line.area.point){if(a.inCircleBox(this.center,c)&&a.inCircle(this.center,c))return this.setDisplay(b),!0}else{var d=new MPPoint(this.center.x+this.line.area.left,this.center.y),e=new MPPoint(this.center.x+this.line.area.right,this.center.y);if(a.inLineBox(d,e,c)&&a.lineDistance(d,e)<=c)return this.setDisplay(b),!0}return this.setDisplay("normal"),!1},MPAtom.prototype.handleRectSelect=function(a){this.select(this.center.inRect(a))},MPAtom.prototype.handlePolygonSelect=function(a){this.select(this.center.inPolygon(a))};var MP_BOND_SINGLE=1,MP_BOND_DOUBLE=2,MP_BOND_TRIPLE=3,MP_BOND_WEDGEHASH=4,MP_BOND_CIS=5,MP_STEREO_NONE=0,MP_STEREO_UP=1,MP_STEREO_DOWN=6,MP_STEREO_CIS_TRANS=3,MP_STEREO_EITHER=4;MPBond.prototype.getKetcherData=function(){return new chem.Struct.Bond({type:this.type,stereo:this.stereo,begin:this.from,end:this.to})},MPBond.prototype.getConfig=function(){return{i:this.index,type:this.type,stereo:this.stereo,from:this.from,to:this.to}},MPBond.prototype.toString=function(){return this.type.toString()+this.stereo.toString()+this.to-this.from},MPBond.prototype.getLine=function(){return new MPLine({from:this.mp.mol.atoms[this.from].center,to:this.mp.mol.atoms[this.to].center})},MPBond.prototype.getAngle=function(a){return this.mp.mol.atoms[this.from].equals(a)?this.mp.mol.atoms[this.from].center.angleTo(this.mp.mol.atoms[this.to].center):this.mp.mol.atoms[this.to].center.angleTo(this.mp.mol.atoms[this.from].center)},MPBond.prototype.setIndex=function(a){this.index=a},MPBond.prototype.setType=function(a){this.type=a,this.changed()},MPBond.prototype.setStereo=function(a){this.stereo=a,this.changed()},MPBond.prototype.setFrom=function(a){this.from=a,this.changed()},MPBond.prototype.setTo=function(a){this.to=a,this.changed()},MPBond.prototype.setDisplay=function(a){a!==this.display&&(this.display=a,this.mp.requestRedraw())},MPBond.prototype.replaceAtom=function(a,b){this.from===a&&this.to!==b?this.from=b:this.to===a&&this.from!==b&&(this.to=b),this.changed()},MPBond.prototype.compare=function(a){return a.i===this.index&&a.type===this.type&&a.stereo===this.stereo&&a.from===this.from&&a.to===this.to},MPBond.prototype.equals=function(a){return a.from===this.from&&a.to===this.to},MPBond.prototype.isSelected=function(){return this.selected},MPBond.prototype.isHidden=function(){return"hidden"===this.display||this.hidden},MPBond.prototype.isPair=function(a,b){var c=this.mp.mol.atoms[this.from].element,d=this.mp.mol.atoms[this.to].element;return c===a&&d===b||c===b&&d===a},MPBond.prototype.hasAtom=function(a){return this.from===a||this.to===a},MPBond.prototype.getOppositeAtom=function(a){return this.from===a?this.to:this.from},MPBond.prototype.select=function(a){this.isSelected()!==a&&(this.selected=a,this.mp.sel.update(),this.mp.requestRedraw())},MPBond.prototype.invalidate=function(){this.valid=!1,this.mp.requestRedraw()},MPBond.prototype.changed=function(){this.invalidate(),this.mp.mol.atoms[this.from].bondsChanged(),this.mp.mol.atoms[this.to].bondsChanged()},MPBond.prototype.drawStateColor=function(){if(!this.isHidden()&&void 0!==this.line&&("hover"===this.display||"active"===this.display||"normal"===this.display&&this.isSelected())){var a=this.isSelected()?"selected":this.display;this.mp.ctx.beginPath();var b=this.line.from,c=this.line.to;this.mp.mol.atoms[this.from].isSelected()&&(b=this.mp.mol.atoms[this.from].center),this.mp.mol.atoms[this.to].isSelected()&&(c=this.mp.mol.atoms[this.to].center),
this.mp.ctx.moveTo(b.x,b.y),this.mp.ctx.lineTo(c.x,c.y),this.mp.ctx.strokeStyle=this.mp.s.bond[a].color,this.mp.ctx.stroke()}},MPBond.prototype.drawBond=function(){if(!this.isHidden()&&void 0!==this.line){var a=(this.mp.s.bond.scale,this.mp.ctx);if(this.mp.s.bond.colored&&!this.mp.s.atom.miniLabel&&(a.strokeStyle=this.cache.bondColor,this.stereo===MP_STEREO_UP&&(a.fillStyle=this.cache.bondColor)),this.mp.getScale()<this.mp.s.bond.singleOnlyScale)a.beginPath(),a.moveTo(this.line.from.x,this.line.from.y),a.lineTo(this.line.to.x,this.line.to.y),a.stroke();else if(this.stereo===MP_STEREO_CIS_TRANS&&this.type===MP_BOND_DOUBLE)a.beginPath(),a.moveTo(this.cache.ctd.from[0].x,this.cache.ctd.from[0].y),a.lineTo(this.cache.ctd.to[0].x,this.cache.ctd.to[0].y),a.moveTo(this.cache.ctd.from[1].x,this.cache.ctd.from[1].y),a.lineTo(this.cache.ctd.to[1].x,this.cache.ctd.to[1].y),a.stroke();else if(this.stereo===MP_STEREO_UP)a.beginPath(),a.moveTo(this.cache.wedge.far[0].x,this.cache.wedge.far[0].y),a.lineTo(this.cache.wedge.near[0].x,this.cache.wedge.near[0].y),a.lineTo(this.line.to.x,this.line.to.y),a.lineTo(this.cache.wedge.near[1].x,this.cache.wedge.near[1].y),a.closePath(),a.fill(),a.stroke();else if(this.stereo===MP_STEREO_DOWN){a.beginPath();for(var b=0;b<this.cache.hashLines.length;b++)a.moveTo(this.cache.hashLines[b].from.x,this.cache.hashLines[b].from.y),a.lineTo(this.cache.hashLines[b].to.x,this.cache.hashLines[b].to.y);a.stroke()}else if(this.type===MP_BOND_SINGLE)a.beginPath(),a.moveTo(this.line.from.x,this.line.from.y),a.lineTo(this.line.to.x,this.line.to.y),a.stroke();else if(this.type===MP_BOND_DOUBLE||this.type===MP_BOND_TRIPLE){a.beginPath();for(var b=0;b<this.cache.bond.from.length;b++)a.moveTo(this.cache.bond.from[b].x,this.cache.bond.from[b].y),a.lineTo(this.cache.bond.to[b].x,this.cache.bond.to[b].y);this.type===MP_BOND_TRIPLE&&(a.moveTo(this.line.from.x,this.line.from.y),a.lineTo(this.line.to.x,this.line.to.y)),a.stroke()}}},MPBond.prototype.validate=function(){if(!this.valid)if(this.valid=!0,this.mp.mol.atoms[this.from].center.distanceTo(this.mp.mol.atoms[this.to].center)<=((this.mp.mol.atoms[this.from].isVisible()?1:0)+(this.mp.mol.atoms[this.to].isVisible()?1:0))*this.mp.s.atom.radius)this.hidden=!0;else{this.hidden=!1;var a=this.mp.s.bond.scale;if(this.cache={},this.line={from:this.mp.mol.atoms[this.from].calculateBondVertices(this.to,[0])[0],to:this.mp.mol.atoms[this.to].calculateBondVertices(this.from,[0])[0]},this.line.center=new MPPFO({x:(this.line.from.x+this.line.to.x)/2,y:(this.line.from.y+this.line.to.y)/2}),this.mp.s.bond.colored){var b=this.mp.mol.atoms[this.from],c=this.mp.mol.atoms[this.to];this.stereo===MP_STEREO_UP?this.cache.bondColor=JmolAtomColorsHashHex.C:b.element===c.element?this.cache.bondColor=JmolAtomColorsHashHex[b.element]||JmolAtomColorsHashHex.C:(this.cache.bondColor=this.mp.ctx.createLinearGradient(b.getX(),b.getY(),c.getX(),c.getY()),this.cache.bondColor.addColorStop(this.mp.s.bond.gradient.from,JmolAtomColorsHashHex[b.element]||JmolAtomColorsHashHex.C),this.cache.bondColor.addColorStop(this.mp.s.bond.gradient.to,JmolAtomColorsHashHex[c.element]||JmolAtomColorsHashHex.C))}else this.cache.bondColor=this.mp.s.bond.color;if(this.mp.getScale()>=this.mp.s.bond.singleOnlyScale)if(this.stereo===MP_STEREO_CIS_TRANS&&this.type===MP_BOND_DOUBLE){var d=transformArrayMult(this.mp.s.bond.delta[MP_BOND_CIS],-this.mp.s.bond.deltaScale);this.cache.ctd={from:this.mp.mol.atoms[this.from].calculateBondVertices(this.to,d),to:this.mp.mol.atoms[this.to].calculateBondVertices(this.from,d)}}else if(this.stereo===MP_STEREO_UP){if(this.cache.wedge={far:this.mp.mol.atoms[this.from].calculateBondVertices(this.to,[0]),near:this.mp.mol.atoms[this.to].calculateBondVertices(this.from,transformArrayMult(this.mp.s.bond.delta[MP_BOND_WEDGEHASH],-this.mp.s.bond.deltaScale))},!this.mp.mol.atoms[this.to].isVisible()){var e=this.mp.mol.atoms[this.to].calculateClosestBonds(this.index);if(!e.none){if(this.mp.mol.bonds[e.lower].type==MP_BOND_SINGLE){var f=this.mp.mol.bonds[e.lower].getLine().intersection(new MPLine({from:this.cache.wedge.far[0],to:this.cache.wedge.near[0]}));void 0!==f.p&&this.line.to.distanceTo(f.p)<this.mp.s.bond.wedgeFitMaxD&&(this.cache.wedge.near[0]=f.p||this.cache.wedge.near[0])}if(this.mp.mol.bonds[e.upper].type==MP_BOND_SINGLE){var g=this.mp.mol.bonds[e.upper].getLine().intersection(new MPLine({from:this.cache.wedge.far[0],to:this.cache.wedge.near[1]}));void 0!==g.p&&this.line.to.distanceTo(g.p)<this.mp.s.bond.wedgeFitMaxD&&(this.cache.wedge.near[1]=g.p||this.cache.wedge.near[1])}}}}else if(this.stereo===MP_STEREO_DOWN){var h=this.mp.mol.atoms[this.from].calculateBondVertices(this.to,[0]),i=this.mp.mol.atoms[this.to].calculateBondVertices(this.from,transformArrayMult(this.mp.s.bond.delta[MP_BOND_WEDGEHASH],-this.mp.s.bond.deltaScale)),j=i[0].x-h[0].x,k=i[0].y-h[0].y,l=i[1].x-h[0].x,m=i[1].y-h[0].y,n=Math.sqrt(j*j+k*k),o=this.mp.s.bond.width*a,p=this.mp.s.bond.hashLineSpace*a;for(this.cache.hashLines=[];n-p-o>0;){var q=(n-p-o)/n;n*=q,j*=q,k*=q,l*=q,m*=q,this.cache.hashLines.push({from:{x:h[0].x+j,y:h[0].y+k},to:{x:h[0].x+l,y:h[0].y+m}})}}else if(this.type===MP_BOND_DOUBLE||this.type===MP_BOND_TRIPLE){var d=[],r=1,s=this.mp.mol.atoms[this.from].calculateClosestBonds(this.index),t=this.mp.mol.atoms[this.to].calculateClosestBonds(this.index),u=!1,v=!1,w=this.mp.s.skeletalDisplay&&(!this.mp.mol.atoms[this.from].isVisible()||!this.mp.mol.atoms[this.to].isVisible())&&!(1===this.mp.mol.atoms[this.from].bonds.length&&(this.mp.mol.atoms[this.from].isVisible()&&this.mp.mol.atoms[this.to].bonds.length>2||1===this.mp.mol.atoms[this.to].bonds.length))&&!(1===this.mp.mol.atoms[this.to].bonds.length&&(this.mp.mol.atoms[this.to].isVisible()&&this.mp.mol.atoms[this.from].bonds.length>2||1===this.mp.mol.atoms[this.from].bonds.length));if(w){var x=this.line.from.distanceTo(this.line.to),y=x,z=0;s.upperSectionAngle<Math.PI?(this.mp.mol.atoms[this.from].isVisible()||(y-=8/Math.tan(s.upperSectionAngle/2)),z+=Math.abs(this.mp.s.bond.bestBisect-s.upperSectionAngle/2)):z+=Math.abs(this.mp.s.bond.bestBisect-Math.PI/2),t.lowerSectionAngle<Math.PI?(this.mp.mol.atoms[this.to].isVisible()||(y-=8/Math.tan(t.lowerSectionAngle/2)),z+=Math.abs(this.mp.s.bond.bestBisect-t.lowerSectionAngle/2)):z+=Math.abs(this.mp.s.bond.bestBisect-Math.PI/2);var A=x,B=0;if(s.lowerSectionAngle<Math.PI?(this.mp.mol.atoms[this.from].isVisible()||(A-=8/Math.tan(s.lowerSectionAngle/2)),B+=Math.abs(this.mp.s.bond.bestBisect-s.lowerSectionAngle/2)):B+=Math.abs(this.mp.s.bond.bestBisect-Math.PI/2),t.upperSectionAngle<Math.PI?(this.mp.mol.atoms[this.to].isVisible()||(A-=8/Math.tan(t.upperSectionAngle/2)),B+=Math.abs(this.mp.s.bond.bestBisect-t.upperSectionAngle/2)):B+=Math.abs(this.mp.s.bond.bestBisect-Math.PI/2),Math.abs(s.upperSectionAngle-t.upperSectionAngle)+Math.abs(s.lowerSectionAngle-t.lowerSectionAngle)<this.mp.s.bond.angleDev){var C=this.mp.mol.atoms[this.from].center.angleTo(this.mp.mol.atoms[this.to].center);r=C>-Math.PI/2+this.mp.s.bond.angleDev&&C<=Math.PI/2+this.mp.s.bond.angleDev?1:-1}else(z>B||y<this.mp.s.atom.radius&&A>this.mp.s.atom.radius)&&(r=-1);u=(this.type===MP_BOND_TRIPLE||1===r)&&y>this.mp.s.atom.radius,v=(this.type===MP_BOND_TRIPLE||-1===r)&&A>this.mp.s.atom.radius}this.type===MP_BOND_DOUBLE?(d=this.mp.s.bond.delta[MP_BOND_DOUBLE],w&&(d=transformArrayAdd(d,-r*d[0]))):this.type===MP_BOND_TRIPLE&&(d=this.mp.s.bond.delta[MP_BOND_TRIPLE]),d=transformArrayMult(d,-this.mp.s.bond.deltaScale);var D=transformArrayMult(d,-1);this.cache.bond={from:this.mp.mol.atoms[this.from].calculateBondVertices(this.to,d),to:this.mp.mol.atoms[this.to].calculateBondVertices(this.from,D)},this.mp.mol.atoms[this.from].isVisible()||s.none||((!w||v)&&s.lowerSectionAngle<Math.PI&&(this.cache.bond.from[0]=this.refineBondVetex(w,s.lowerBisectAngle,this.line.from,this.cache.bond.from[0],this.cache.bond.to[0],this.mp.mol.bonds[s.lower].getLine())),(!w||u)&&s.upperSectionAngle<Math.PI&&(this.cache.bond.from[1]=this.refineBondVetex(w,s.upperBisectAngle,this.line.from,this.cache.bond.from[1],this.cache.bond.to[1],this.mp.mol.bonds[s.upper].getLine()))),this.mp.mol.atoms[this.to].isVisible()||t.none||((!w||v)&&t.upperSectionAngle<Math.PI&&(this.cache.bond.to[0]=this.refineBondVetex(w,t.upperBisectAngle,this.line.to,this.cache.bond.to[0],this.cache.bond.from[0],this.mp.mol.bonds[t.upper].getLine())),(!w||u)&&t.lowerSectionAngle<Math.PI&&(this.cache.bond.to[1]=this.refineBondVetex(w,t.lowerBisectAngle,this.line.to,this.cache.bond.to[1],this.cache.bond.from[1],this.mp.mol.bonds[t.lower].getLine())))}}},MPBond.prototype.refineBondVetex=function(a,b,c,d,e,f){var g;return a?g=new MPLine({from:c,to:MPPFO({x:c.x+Math.cos(b),y:c.y+Math.sin(-b)})}).intersection(new MPLine({from:d,to:e})):(g=f.intersection(new MPLine({from:d,to:e})),(!g.onL1||c.distanceTo(g.p)>f.length()/2)&&(g.p=void 0)),void 0!==g.p?g.p:d},MPBond.prototype.getHandler=function(){return"bond"===this.mp.tool.type?{scope:this,onPointerDown:function(a,b){if(b.tool.data.type)this.scope.setType(b.tool.data.type===MP_BOND_TRIPLE?MP_BOND_TRIPLE:this.scope.type===MP_BOND_TRIPLE||this.scope.stereo!==MP_STEREO_NONE?b.tool.data.type:this.scope.type===MP_BOND_SINGLE?MP_BOND_DOUBLE:MP_BOND_SINGLE),this.scope.setStereo(MP_STEREO_NONE);else if(b.tool.data.stereo)if(this.scope.setType(MP_BOND_SINGLE),this.scope.stereo===b.tool.data.stereo){var c=this.scope.from;this.scope.setFrom(this.scope.to),this.scope.setTo(c)}else this.scope.setStereo(b.tool.data.stereo)}}:"fragment"===this.mp.tool.type&&void 0!==this.mp.tool.data.frag.toBond?{scope:this,data:{},onPointerDown:function(a,b){var c=((new MPPoint).fromRelativePointer(a,b),b.mol.atoms[this.scope.from].center),d=b.mol.atoms[this.scope.to].center,e=c.angleTo(d);this.data.frag=MPFragments.rotate(MPFragments.translate(MPFragments.scale(MPFragments.clone(b.tool.data.frag.toBond),b.s.bond.length),c.x,c.y),c,e);var f=b.mol.createFragment(this.data.frag,!0);f.atoms=mapArray(f.atoms,b.mol.mergeAtoms(f.atoms[0],this.scope.from).amap),f.atoms=mapArray(f.atoms,b.mol.mergeAtoms(f.atoms[f.atoms.length-1],this.scope.to).amap);for(var g=0,h=0;h<f.atoms.length;h++)g+=b.mol.atoms[f.atoms[h]].center.lineSide(this.scope.getLine());b.sel.mirrorSide=g>0?1:-1;for(var i=b.mol.countCollapses(f.atoms),h=0;h<f.atoms.length;h++)b.mol.atoms[f.atoms[h]].center.mirror(this.scope.getLine(),-b.sel.mirrorSide);var j=b.mol.countCollapses(f.atoms);if(i===f.atoms.length&&j===f.atoms.length)return this.data.lock=!0,this.scope.select(!1),b.mol.atoms[this.scope.from].select(!1),b.mol.atoms[this.scope.to].select(!1),void b.sel.remove();if(j>i){for(var h=0;h<f.atoms.length;h++)b.mol.atoms[f.atoms[h]].center.mirror(this.scope.getLine(),b.sel.mirrorSide);this.data.lock=j===f.atoms.length}else b.sel.mirrorSide=-b.sel.mirrorSide,this.data.lock=i===f.atoms.length},onPointerMove:function(a,b){if(!this.data.lock){var c=(new MPPoint).fromRelativePointer(a,b);b.sel.mirror(this.scope.getLine(),c)}},onPointerUp:function(a,b){b.sel.collapse(),b.sel.clear()}}:"erase"===this.mp.tool.type?{scope:this,onPointerDown:function(a,b){this.scope.isSelected()?b.sel.remove():b.mol.removeBond(this.scope.index),b.pointer.handler=void 0}}:{scope:this,data:{},onPointerMove:function(a,b){b.setCursor("move");var c=(new MPPoint).fromRelativePointer(a,b),d=c.x-b.pointer.old.r.x,e=c.y-b.pointer.old.r.y;(Math.sqrt(d*d+e*e)>b.s.draggingThreshold||this.data.moved)&&(this.data.moved=!0,this.scope.isSelected()&&b.sel.cache.atoms.length>0?b.sel.translate(d,e):(b.mol.atoms[this.scope.from].translate(d,e),b.mol.atoms[this.scope.to].translate(d,e)),b.pointer.old.r=c)},onPointerUp:function(a,b){if(!this.data.moved&&oneOf(b.tool.type,["select","drag"])){var c=!this.scope.isSelected();this.scope.select(c),0===b.sel.cache.atoms.length&&(b.mol.atoms[this.scope.from].select(c),b.mol.atoms[this.scope.to].select(c)),b.sel.updateRotationCenter()}else this.scope.isSelected()?b.sel.collapse():b.mol.collapseAtoms([this.scope.from,this.scope.to],!0),b.sel.updateRotationCenter()}}},MPBond.prototype.handle=function(a,b){if(void 0===this.line)return!1;var c=this.mp.s.bond.radiusScaled;return a.inLineBox(this.line.from,this.line.to,c)&&a.lineDistance(this.line.from,this.line.to)<=c?(this.setDisplay(b),!0):(this.setDisplay("normal"),!1)},MPBond.prototype.handleRectSelect=function(a){void 0!==this.line&&this.select(this.line.center.inRect(a))},MPBond.prototype.handlePolygonSelect=function(a){void 0!==this.line&&this.select(this.line.center.inPolygon(a))},MolPad.prototype.loadSettings=function(){this.s={maxStackSize:100,zoomType:MP_ZOOM_TO_POINTER,zoomSpeed:.2,minZoom:.01,skeletalDisplay:!0,relativePadding:.15,draggingThreshold:2,rotateSteps:12,fonts:{element:{fontStyle:"bold",fontFamily:"sans-serif",fontSize:12},charge:{fontStyle:"bold",fontFamily:"sans-serif",fontSize:8},isotope:{fontStyle:"bold",fontFamily:"sans-serif",fontSize:8},chainSize:{fontStyle:"normal",fontFamily:"sans-serif",fontSize:12}},atom:{hover:{color:"#bfb"},active:{color:"#8f8"},incorrect:{color:"#f66"},selected:{color:"#8f8"},charge:{padding:1},isotope:{padding:1},scale:1,minScale:1/1.5,radius:12,selectionRadius:15,color:"#111",colored:!0,lineCap:"round",circleClamp:15,minAddRotateLength:15,maxMiniLabelScale:.2,miniLabelSize:25,miniLabel:!1},bond:{gradient:{from:.4,to:.6},color:"#111",colored:!0,hover:{color:"#bfb"},active:{color:"#8f8"},selected:{color:"#8f8"},delta:[[],[0],[-4,4],[-8,8],[-6,6],[0,8]],length:55,lengthHydrogen:34,radius:8,lineCap:"round",lineJoin:"round",width:1.5,scale:1,minScale:1/1.5,minDeltaScale:.25,singleOnlyScale:.2,hashLineSpace:2,wedgeFitMaxD:20,bestBisect:Math.PI/4,angleDev:Math.PI/30},chain:{rotateSteps:12,devAngle:Math.PI/6,padding:2,color:"#f50",strokeStyle:"#f50",lineCap:"round",lineJoin:"round"},select:{fillStyle:"rgba(255, 85, 0, 0.3)",strokeStyle:"#f50",lineWidth:2,lineCap:"round",lineJoin:"round"}}};var MP_ZOOM_TO_COG=0,MP_ZOOM_TO_POINTER=1;MolPad.prototype.setTool=function(a,b){this.tool.type=a,this.tool.data=b},MolPad.prototype.onChange=function(a){this.changeCallback=a},MolPad.prototype.clear=function(a){this.mol.clear(),this.sel.update(),this.scaleAbsolute(1/this.matrix[0],this.width()/2,this.height()/2),this.redraw(!0),this.mol.updateCopy()},MolPad.prototype.changed=function(){jQuery(this.buttons.undo).toggleClass("tool-button-disabled",0===this.mol.stack.length),jQuery(this.buttons.redo).toggleClass("tool-button-disabled",0===this.mol.reverseStack.length),void 0!==this.changeCallback&&this.changeCallback()},MolPad.prototype.undo=function(a){this.dismissHandler(),this.mol.undo(a)&&this.changed()},MolPad.prototype.redo=function(){this.dismissHandler(),this.mol.redo()&&this.changed()},MolPad.prototype.setSkeletalDisplay=function(a){a!==this.s.skeletalDisplay&&(this.dismissHandler(),this.s.skeletalDisplay=a,a?this.mol.removeImplicitHydrogen():this.mol.addImplicitHydrogen(),this.mol.invalidateAll(),this.clearRedrawRequest(),this.mol.updateCopy())},MolPad.prototype.setColored=function(a){this.s.atom.colored=this.s.bond.colored=a,this.s.fonts.isotope.fontStyle=this.s.fonts.element.fontStyle=this.s.fonts.charge.fontStyle=a?"bold":"normal",this.redraw(!0)},MolPad.prototype.toDataURL=function(){return this.canvas.toDataURL("image/png")},MolPad.prototype.loadMOL=function(a,b){this.mol.loadMOL(a),(this.s.skeletalDisplay||b)&&this.mol.removeImplicitHydrogen(),this.center(),this.mol.updateCopy()},MolPad.prototype.getMOL=function(){return this.mol.getMOL()},MolPad.prototype.getSMILES=function(){return this.mol.getSMILES()},MPMolecule.prototype.clear=function(){this.atoms=[],this.bonds=[]},MPMolecule.prototype.invalidateAll=function(){for(var a=0;a<this.atoms.length;a++)this.atoms[a].invalidate();for(var a=0;a<this.bonds.length;a++)this.bonds[a].invalidate()},MPMolecule.prototype.validateAll=function(){for(var a=0;a<this.atoms.length;a++)this.atoms[a].validate();for(var a=0;a<this.bonds.length;a++)this.bonds[a].validate()},MPMolecule.prototype.exec=function(a,b,c){if(b)for(var d=0;d<this.atoms.length;d++)if(a.call(this.mp,this.atoms[d]))return;if(c)for(var d=0;d<this.bonds.length;d++)if(a.call(this.mp,this.bonds[d]))return},MPMolecule.prototype.loadMOL=function(a){this.clear();var b=chem.Molfile.parseCTFile(a.split("\n")),c=this;b.atoms.each(function(a,b){var d=new MPAtom(c.mp,{i:a,x:b.pp.x*c.mp.s.bond.length,y:b.pp.y*c.mp.s.bond.length,element:b.label,charge:b.charge,isotope:b.isotope});c.atoms.push(d)}),b.bonds.each(function(a,b){var d=new MPBond(c.mp,{i:a,type:b.type,stereo:b.stereo,from:b.begin,to:b.end});c.bonds.push(d),c.atoms[b.begin].bonds.push(d.index),c.atoms[b.end].bonds.push(d.index)})},MPMolecule.prototype.getMOL=function(){return(new chem.MolfileSaver).saveMolecule(this.getKetcherData())},MPMolecule.prototype.getSMILES=function(){if(0===this.atoms.length)throw new Error("No atoms found");return(new chem.SmilesSaver).saveMolecule(this.getKetcherData())},MPMolecule.prototype.getKetcherData=function(){for(var a=new chem.Struct,b=0;b<this.atoms.length;b++)a.atoms.add(this.atoms[b].getKetcherData());for(var b=0;b<this.bonds.length;b++)a.bonds.add(this.bonds[b].getKetcherData());return a.initHalfBonds(),a.initNeighbors(),a.markFragments(),a},MPMolecule.prototype.getPlainData=function(){for(var a={atoms:[],bonds:[]},b=0;b<this.atoms.length;b++)a.atoms.push(this.atoms[b].getConfig());for(var b=0;b<this.bonds.length;b++)a.bonds.push(this.bonds[b].getConfig());return a},MPMolecule.prototype.loadPlainData=function(a){this.clear();for(var b=0;b<a.atoms.length;b++)this.atoms.push(new MPAtom(this.mp,a.atoms[b]));for(var b=0;b<a.bonds.length;b++)this.bonds.push(new MPBond(this.mp,a.bonds[b]));this.mp.redraw(!0)},MPMolecule.prototype.getFingerprint=function(){for(var a=[],b=0;b<this.atoms.length;b++)a.push(this.atoms[b].toString());return a.sort(),a.join("")},MPMolecule.prototype.isChanged=function(){return this.getFingerprint()!==this.copy.fingerprint},MPMolecule.prototype.createFragment=function(a,b){for(var c={atoms:[],bonds:[]},d=0;d<a.atoms.length;d++){var e=new MPAtom(this.mp,{i:this.atoms.length,x:a.atoms[d].center.x,y:a.atoms[d].center.y,element:a.atoms[d].element,selected:b});this.atoms.push(e),c.atoms.push(e.index)}for(var d=0;d<a.bonds.length;d++){var f=new MPBond(this.mp,{i:this.bonds.length,type:a.bonds[d].type,stereo:MP_STEREO_NONE,from:c.atoms[a.bonds[d].from],to:c.atoms[a.bonds[d].to],selected:b});this.bonds.push(f),c.bonds.push(f.index),this.atoms[f.from].addBond(f.index),this.atoms[f.to].addBond(f.index)}return b&&this.mp.sel.update(),c},MPMolecule.prototype.rotateAtoms=function(a,b,c,d,e,f,g){var h=d;if(h=void 0!==f?clampedAngle(e,a,b,f):a.angleTo(b),h!==d||g){for(var i=0;i<c.length;i++)this.atoms[c[i]].rotateAroundCenter(a,h-d);return h}return d},MPMolecule.prototype.mergeAtoms=function(a,b,c){var d=this.atoms[a],e=this.atoms[b];c&&e.center.replace(d.center),e.select(d.isSelected()||e.isSelected());for(var f=0;f<d.bonds.length;f++){var g=e.getNeighborBond(this.bonds[d.bonds[f]].getOppositeAtom(a));-1===g?(this.bonds[d.bonds[f]].replaceAtom(a,b),e.addBond(d.bonds[f])):(this.bonds[g].select(this.bonds[d.bonds[f]].isSelected()||this.bonds[g].isSelected()),this.bonds[d.bonds[f]].type===MP_BOND_SINGLE&&this.bonds[g].setType(MP_BOND_SINGLE))}return"C"===e.element&&e.setElement(d.element),this.atoms.splice(a,1),this.updateIndices()},MPMolecule.prototype.collapseAtoms=function(a,b){for(var c=0;c<a.length;c++)for(var d=0;d<this.atoms.length;d++)if(-1===a.indexOf(d)){var e=(this.atoms[a[c]].isVisible()||this.atoms[d].isVisible()?2:1)*this.mp.s.atom.selectionRadiusScaled;if(this.atoms[a[c]].center.inCircle(this.atoms[d].center,e)){var f=this.mergeAtoms(d,a[c],b);a=mapArray(a,f.amap);break}}},MPMolecule.prototype.countCollapses=function(a){for(var b=0,c=0;c<a.length;c++)for(var d=0;d<this.atoms.length;d++)-1===a.indexOf(d)&&this.atoms[a[c]].center.inCircle(this.atoms[d].center,this.mp.s.atom.radiusScaled)&&b++;return b},MPMolecule.prototype.removeAtom=function(a,b){var c=[];if(b)for(var d=0;d<this.atoms[a].bonds.length;d++){var e=this.bonds[this.atoms[a].bonds[d]].getOppositeAtom(a);"H"==this.atoms[e].element&&1==this.atoms[e].bonds.length&&c.push(e)}c.push(a),c.sort(function(a,b){return a-b}).reverse();for(var d=0;d<c.length;d++)this.atoms.splice(c[d],1);return this.updateIndices()},MPMolecule.prototype.removeBond=function(a){var b=this.bonds[a].from,c=this.bonds[a].to;return 1===this.atoms[b].bonds.length&&(this.atoms.splice(b,1),c>b&&c--),1===this.atoms[c].bonds.length&&this.atoms.splice(c,1),this.bonds.splice(a,1),this.updateIndices()},MPMolecule.prototype.updateIndices=function(){for(var a={},b={},c=0;c<this.atoms.length;c++)a[this.atoms[c].index]=c,this.atoms[c].index=c,this.atoms[c].valid=!1;for(var c=0;c<this.bonds.length;c++){var d=this.bonds[c],e=a[d.from],f=a[d.to];void 0!==e&&void 0!==f?(b[d.index]=c,d.index=c,d.from=e,d.to=f,d.valid=!1):(this.bonds.splice(c,1),c--)}for(var c=0;c<this.atoms.length;c++)this.atoms[c].mapBonds(b);return this.mp.sel.update(),{amap:a,bmap:b}},MPMolecule.prototype.getBBox=function(){if(0===this.atoms.length)return{x:0,y:0,width:1,height:1};for(var a=void 0,b=void 0,c=0;c<this.atoms.length;c++){var d=this.atoms[c].calculateCenterLine(),e=this.atoms[c].center.x+(d.area.point?0:d.area.left),f=this.atoms[c].center.x+(d.area.point?0:d.area.right),g=this.atoms[c].center.y;void 0===a?a={x:e,y:g}:(a.x>e&&(a.x=e),a.y>g&&(a.y=g)),void 0===b?b={x:f,y:g}:(b.x<f&&(b.x=f),b.y<g&&(b.y=g))}var h=this.mp.s.atom.radius;return{x:a.x-h,y:a.y-h,width:b.x-a.x+2*h,height:b.y-a.y+2*h}},MPMolecule.prototype.updateCopy=function(){var a=this.getFingerprint();a!==this.copy.fingerprint&&(this.reverseStack=[],this.stack.push(this.copy),this.stack.length>this.mp.s.maxStackSize&&this.stack.shift(),this.copy=this.getPlainData(),this.copy.fingerprint=a,this.mp.changed())},MPMolecule.prototype.undo=function(a){return this.stack.length>0?(a||this.reverseStack.push(this.copy),this.copy=this.stack.pop(),this.loadPlainData(this.copy),!0):!1},MPMolecule.prototype.redo=function(){return this.reverseStack.length>0?(this.stack.push(this.copy),this.copy=this.reverseStack.pop(),this.loadPlainData(this.copy),!0):!1},MPMolecule.prototype.removeImplicitHydrogen=function(){for(var a=[],b=0;b<this.atoms.length;b++)this.atoms[b].isImplicit()&&a.push(b);for(var b=0;b<a.length;b++)this.atoms.splice(a[b]-b,1);this.updateIndices()},MPMolecule.prototype.addImplicitHydrogen=function(){for(var a=0;a<this.atoms.length;a++)this.atoms[a].addImplicitHydrogen()},MPSelection.prototype.hasCenter=function(){return"object"==typeof this.center},MPSelection.prototype.update=function(){this.cache.atoms=[],this.cache.bonds=[];for(var a=0;a<this.mp.mol.atoms.length;a++)this.mp.mol.atoms[a].isSelected()&&this.cache.atoms.push(a);for(var a=0;a<this.mp.mol.bonds.length;a++)this.mp.mol.bonds[a].isSelected()&&this.cache.bonds.push(a)},MPSelection.prototype.translate=function(a,b){for(var c=0;c<this.cache.atoms.length;c++)this.mp.mol.atoms[this.cache.atoms[c]].translate(a,b)},MPSelection.prototype.rotate=function(a){this.currentAngle=this.mp.mol.rotateAtoms(this.center,a,this.cache.atoms,this.currentAngle,this.startAngle,this.mp.s.rotateSteps)},MPSelection.prototype.mirror=function(a,b){var c=b.lineSide(a);if(c!==this.mirrorSide&&0!==c){this.mirrorSide=c;for(var d=0;d<this.cache.atoms.length;d++)this.mp.mol.atoms[this.cache.atoms[d]].mirror(a,c)}},MPSelection.prototype.clear=function(){this.mp.mol.exec(function(a){a.selected=!1},!0,!0),this.center=void 0,this.update(),this.mp.requestRedraw()},MPSelection.prototype.collapse=function(){this.mp.mol.collapseAtoms(this.cache.atoms.slice())},MPSelection.prototype.remove=function(){for(;this.cache.atoms.length>0;)this.mp.mol.removeAtom(this.cache.atoms[0]);for(;this.cache.bonds.length>0;)this.mp.mol.removeBond(this.cache.bonds[0])},MPSelection.prototype.updateRotationCenter=function(){for(var a=[],b=0;b<this.cache.atoms.length;b++)this.mp.mol.atoms[this.cache.atoms[b]].hasUnselectedNeighbors()&&a.push(this.cache.atoms[b]);1===a.length&&this.cache.atoms.length>1?(this.center=this.mp.mol.atoms[a[0]].center,this.centerAtom=a[0]):this.center=void 0},MolPad.prototype.setupGraphics=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.container.width()*this.devicePixelRatio,this.canvas.height=this.container.height()*this.devicePixelRatio,this.canvas.style.width=this.container.width()+"px",this.canvas.style.height=this.container.height()+"px",this.container.append(this.canvas),this.redrawRequest=!1,this.matrix=[1,0,0,1,0,0],this.ctx=this.canvas.getContext("2d"),this.updated=!1,this.pendingFrame=!1},MolPad.prototype.resize=function(){this.canvas.width=this.container.width()*this.devicePixelRatio,this.canvas.height=this.container.height()*this.devicePixelRatio,this.canvas.style.width=this.container.width()+"px",this.canvas.style.height=this.container.height()+"px",this.offset=this.container.offset(),this.center()},MolPad.prototype.requestRedraw=function(){this.redrawRequest=!0},MolPad.prototype.clearRedrawRequest=function(){return this.redrawRequest?(this.redrawRequest=!1,this.redraw(),!0):!1},MolPad.prototype.update=function(){var a=this.s.atom.scale;this.s.atom.miniLabel=this.getScale()<=this.s.atom.maxMiniLabelScale,this.s.atom.scale=this.getScale()<this.s.atom.minScale?this.s.atom.minScale/this.getScale():1,this.s.bond.deltaScale=this.getScale()<this.s.bond.minDeltaScale?this.s.bond.minDeltaScale/this.getScale():1,this.s.bond.scale=this.getScale()<this.s.bond.minScale?this.s.bond.minScale/this.getScale():1,this.s.atom.radiusScaled=this.s.atom.radius*this.s.atom.scale,this.s.atom.selectionRadiusScaled=this.s.atom.selectionRadius*this.s.atom.scale,this.s.bond.radiusScaled=this.s.bond.radius*this.s.bond.scale,this.s.atom.scale!==a&&(this.mol.invalidateAll(),this.mol.exec(function(a){a.line=void 0},!0,!1))},MolPad.prototype.setCursor=function(a){this.container.css("cursor",a)},MolPad.prototype.setFont=function(a){var b=this.s.fonts[a].fontStyle+" "+Math.round(this.s.fonts[a].fontSize*this.s.atom.scale*96/72)+"px "+this.s.fonts[a].fontFamily;b!==this.ctx.font&&(this.ctx.font=b)},MolPad.prototype.draw=function(){this.pendingFrame=!1,this.updated||(this.updated=!0,this.update()),this.mol.validateAll(),this.ctx.clearRect(0,0,this.width(),this.height()),this.ctx.save(),this.ctx.transform(this.matrix[0],this.matrix[1],this.matrix[2],this.matrix[3],this.matrix[4],this.matrix[5]),this.ctx.lineWidth=2*this.s.bond.radiusScaled,this.ctx.lineCap=this.s.bond.lineCap;for(var a=0;a<this.mol.bonds.length;a++)this.mol.bonds[a].drawStateColor();this.ctx.lineWidth=2*this.s.atom.selectionRadiusScaled,this.ctx.lineCap=this.s.atom.lineCap;for(var a=0;a<this.mol.atoms.length;a++)this.mol.atoms[a].drawStateColor();this.ctx.fillStyle=this.ctx.strokeStyle=this.s.bond.color,this.ctx.lineWidth=this.s.bond.width*this.s.bond.scale,this.ctx.lineCap=this.s.bond.lineCap,this.ctx.lineJoin=this.s.bond.lineJoin;for(var a=0;a<this.mol.bonds.length;a++)this.mol.bonds[a].drawBond();this.ctx.fillStyle=this.ctx.strokeStyle=this.s.atom.color;for(var a=0;a<this.mol.atoms.length;a++)this.mol.atoms[a].drawLabel();this.pointer.handler&&this.pointer.handler.onDraw&&this.pointer.handler.onDraw(this),this.ctx.restore()},MolPad.prototype.redraw=function(a){a&&(this.updated=!1),this.pendingFrame||(this.pendingFrame=!0,requestAnimationFrame(this.draw.bind(this)))},MolPad.prototype.center=function(){if(0!==this.mol.atoms.length){this.resetMatrix();var a=this.mol.getBBox(),b=this.width()/a.width,c=this.height()/a.height;c>b?(this.scale(b),this.translate(-a.x*b,-a.y*b+(this.height()-a.height*b)/2)):(this.scale(c),this.translate(-a.x*c+(this.width()-a.width*c)/2,-a.y*c));var d=1-2*this.s.relativePadding;this.scaleAbsolute(d,this.width()/2,this.height()/2),this.redraw(!0)}},MolPad.prototype.width=function(){return this.canvas.width},MolPad.prototype.height=function(){return this.canvas.height},MolPad.prototype.translate=function(a,b){this.matrix[4]+=a,this.matrix[5]+=b},MolPad.prototype.scale=function(a){this.matrix[0]*=a,this.matrix[3]*=a},MolPad.prototype.getScale=function(){return this.matrix[0]},MolPad.prototype.scaleAbsolute=function(a,b,c){this.matrix[0]*=a,this.matrix[3]*=a,this.matrix[4]-=(b-this.matrix[4])*(a-1),this.matrix[5]-=(c-this.matrix[5])*(a-1)},MolPad.prototype.resetMatrix=function(){this.matrix=[1,0,0,1,0,0]},MolPad.prototype.setupEventHandling=function(){this.keys={ctrl:!1},this.pointer={old:{p:new MPPoint,r:new MPPoint,c:new MPPoint,d:0},handler:void 0,touches:0,touchGrab:!1};var a=this;this.container.on("DOMMouseScroll mousewheel",function(b){b.preventDefault(),b.originalEvent.detail?a.onScroll(b.originalEvent.detail/3,b):b.originalEvent.wheelDelta&&a.onScroll(b.originalEvent.wheelDelta/120,b)}),this.container.on("contextmenu",function(a){return!1}),this.container.on("mousedown touchstart",function(b){a.onPointerDown(b),a.clearRedrawRequest()}),this.container.on("mousemove",function(b){a.onMouseMoveInContainer(b),a.clearRedrawRequest()}),this.container.on("mouseout",function(b){a.onMouseOut(b),a.clearRedrawRequest()}),jQuery(window).on("mousemove touchmove",function(b){a.onPointerMove(b),a.clearRedrawRequest()}),jQuery(window).on("mouseup touchend touchcancel",function(b){a.onPointerUp(b),a.clearRedrawRequest()}),jQuery(window).on("blur",function(b){a.onBlur(b)}),navigator.platform.toLowerCase().indexOf("mac")>=0?(jQuery(document).bind("keydown","meta+z",function(b){b.preventDefault(),a.undo()}),jQuery(document).bind("keydown","meta+y",function(b){b.preventDefault(),a.redo()}),jQuery(document).bind("keydown","meta+shift+z",function(b){b.preventDefault(),a.redo()})):(jQuery(document).bind("keydown","ctrl+z",function(b){b.preventDefault(),a.undo()}),jQuery(document).bind("keydown","ctrl+y",function(b){b.preventDefault(),a.redo()}),jQuery(document).bind("keydown","ctrl+shift+z",function(b){b.preventDefault(),a.redo()})),jQuery(document).on("keydown",function(b){a.keys.ctrl=b.ctrlKey,46===b.keyCode&&(a.sel.remove(),a.clearRedrawRequest())}),jQuery(document).on("keyup",function(b){a.keys.ctrl=b.ctrlKey})},MolPad.prototype.onScroll=function(a,b){var c=1+this.s.zoomSpeed*a;this.matrix[0]*c<this.s.minZoom&&(c=this.s.minZoom/this.matrix[0]);var d=(new MPPoint).fromPointer(b);if(d.x-=this.offset.left,d.y-=this.offset.top,this.s.zoomType===MP_ZOOM_TO_COG){for(var e=new MPPoint,f=0;f<this.mol.atoms.length;f++)e.add(this.mol.atoms[f].center);e.divide(this.mol.atoms.length),e.multiplyX(this.matrix[0]),e.multiplyY(this.matrix[3]),e.addX(this.matrix[4]),e.addY(this.matrix[5]),e.divide(this.devicePixelRatio),this.scaleAbsolute(c,e.x,e.y)}else this.scaleAbsolute(c,d.x,d.y);this.redraw(!0)},MolPad.prototype.onPointerDown=function(a){a.preventDefault(),a.stopImmediatePropagation();var b=a.originalEvent;if("mousedown"===a.type){if(0===this.pointer.touches)this.pointer.touchGrab=!1;else if(this.pointer.touchGrab)return}else"touchstart"===a.type&&(this.pointer.touchGrab=!0,this.pointer.touches=b.targetTouches.length||1);this.pointer.old.p.fromPointer(a),this.pointer.old.r.fromRelativePointer(a,this),this.pointer.handler=void 0,oneOf(this.tool.type,["erase","select","drag"])||this.sel.clear(),b.targetTouches&&b.targetTouches.length>1?(this.pointer.handler&&this.pointer.handler.onPointerUp&&this.pointer.handler.onPointerUp(a,this),this.mol.isChanged()?this.mol.loadPlainData(this.mol.copy):this.resetEventDisplay(),this.pointer.old.c.fromMultiTouchCenter(a),this.pointer.old.d=getMultiTouchDelta(a),this.pointer.handler=this.multiTouchHandler):1===a.which||b.targetTouches&&1===b.targetTouches.length?(this.handleEvent(this.pointer.old.r,"active",function(a){this.pointer.handler=a.getHandler(this)}),void 0===this.pointer.handler&&(this.pointer.handler=this.getHandler())):2!==a.which&&3!==a.which||(this.pointer.handler=this.mouseDragHandler),this.pointer.handler&&this.pointer.handler.onPointerDown&&this.pointer.handler.onPointerDown(a,this)},MolPad.prototype.onMouseMoveInContainer=function(a){
this.pointer.touchGrab||void 0===this.pointer.handler&&this.hoverHandler.onPointerMove(a,this)},MolPad.prototype.onMouseOut=function(a){void 0===this.pointer.handler&&(this.resetEventDisplay(),this.setCursor("default"))},MolPad.prototype.onPointerMove=function(a){"mousemove"===a.type&&this.pointer.touchGrab||this.pointer.handler&&this.pointer.handler.onPointerMove&&(a.preventDefault(),this.pointer.handler.onPointerMove(a,this))},MolPad.prototype.onPointerUp=function(a){if("mouseup"!==a.type||!this.pointer.touchGrab){var b=a.originalEvent;this.pointer.handler?(this.pointer.handler.onPointerUp&&this.pointer.handler.onPointerUp(a,this),this.pointer.handler.scope?(this.setCursor("pointer"),this.resetEventDisplay(),this.pointer.handler.scope.setDisplay("mouseup"===a.type?"hover":"normal")):this.setCursor("default")):this.setCursor("default"),b.targetTouches?b.targetTouches.length>1?(this.pointer.old.d=getMultiTouchDelta(a),this.pointer.old.c=(new MPPoint).fromMultiTouchCenter(a)):1===b.targetTouches.length?(this.pointer.old.p=(new MPPoint).fromPointer(a),this.pointer.old.r.fromRelativePointer(a,this),void 0!==this.pointer.handler&&(this.pointer.handler=this.mouseDragHandler)):(this.pointer.handler=void 0,this.mol.updateCopy()):(this.pointer.handler=void 0,this.mol.updateCopy())}},MolPad.prototype.onBlur=function(a){this.keys.ctrl=!1,this.dismissHandler()},MolPad.prototype.handleEvent=function(a,b,c){for(var d=!1,e=0;e<this.mol.atoms.length;e++)d?this.mol.atoms[e].setDisplay("normal"):this.mol.atoms[e].handle(a,b)&&(d=!0,c.call(this,this.mol.atoms[e]));for(var e=0;e<this.mol.bonds.length;e++)d?this.mol.bonds[e].setDisplay("normal"):this.mol.bonds[e].handle(a,b)&&(d=!0,c.call(this,this.mol.bonds[e]))},MolPad.prototype.dismissHandler=function(){this.resetEventDisplay(),this.sel.clear(),this.setCursor("default"),this.pointer.touches=0,this.pointer.handler=void 0,this.clearRedrawRequest(),this.mol.updateCopy()},MolPad.prototype.resetEventDisplay=function(){this.mol.exec(function(a){a.setDisplay("normal")},!0,!0)},MolPad.prototype.hoverHandler={onPointerMove:function(a,b){b.setCursor("default");var c=(new MPPoint).fromRelativePointer(a,b);b.handleEvent(c,"hover",function(a){b.setCursor("pointer")})}},MolPad.prototype.mouseDragHandler={data:{},onPointerMove:function(a,b){b.setCursor("move");var c=(new MPPoint).fromPointer(a);this.data.moved=!0,c.equals(b.pointer.old)||(b.translate((c.x-b.pointer.old.p.x)*b.devicePixelRatio,(c.y-b.pointer.old.p.y)*b.devicePixelRatio),b.pointer.old.p=c,b.requestRedraw())},onPointerUp:function(a,b){this.data.moved||b.sel.clear(),b.setCursor("default")}},MolPad.prototype.multiTouchHandler={onPointerMove:function(a,b){if(a.originalEvent.targetTouches.length<=1)return void b.dismissHandler();var c=(new MPPoint).fromMultiTouchCenter(a),d=getMultiTouchDelta(a);b.translate((c.x-b.pointer.old.c.x)*b.devicePixelRatio,(c.y-b.pointer.old.c.y)*b.devicePixelRatio),b.scaleAbsolute(d/b.pointer.old.d,(c.x-b.offset.left)*b.devicePixelRatio,(c.y-b.offset.top)*b.devicePixelRatio),b.pointer.old.c=c,b.pointer.old.d=d,b.pointer.old.p.fromPointer(a),b.redraw(!0)}},MolPad.prototype.selectionToolHandler={data:{},onDraw:function(a){if(a.ctx.fillStyle=a.s.select.fillStyle,a.ctx.strokeStyle=a.s.select.strokeStyle,a.ctx.lineWidth=a.s.select.lineWidth/a.getScale(),a.ctx.lineCap=a.s.select.lineCap,a.ctx.lineJoin=a.s.select.lineJoin,a.ctx.setLineDash([2/a.getScale(),5/a.getScale()]),a.ctx.beginPath(),"rect"===a.tool.data.type&&this.data.rect)a.ctx.rect(this.data.rect.x,this.data.rect.y,this.data.rect.width,this.data.rect.height),a.ctx.fill(),a.ctx.stroke();else if("lasso"===a.tool.data.type&&this.data.points){for(var b=0;b<this.data.points.length;b++)0===b?a.ctx.moveTo(this.data.points[b].x,this.data.points[b].y):a.ctx.lineTo(this.data.points[b].x,this.data.points[b].y);a.ctx.mozFillRule="evenodd",a.ctx.msFillRule="evenodd",a.ctx.fillRule="evenodd",a.ctx.fill("evenodd"),a.ctx.stroke()}},onPointerDown:function(a,b){b.setCursor("pointer"),this.data={};var c=(new MPPoint).fromRelativePointer(a,b);b.keys.ctrl?this.data.selAdd={atoms:b.sel.cache.atoms.slice(),bonds:b.sel.cache.bonds.slice()}:(b.sel.clear(),this.data.selAdd={atoms:[],bonds:[]}),"rect"===b.tool.data.type?this.data.rect={x:c.x,y:c.y,width:0,height:0}:this.data.points=[c.clone()]},onPointerMove:function(a,b){b.setCursor("default");var c=(new MPPoint).fromRelativePointer(a,b);if("rect"===b.tool.data.type){this.data.rect.width=c.x-this.data.rect.x,this.data.rect.height=c.y-this.data.rect.y;var d=this.data.rect;b.mol.exec(function(a){a.handleRectSelect(d)},!0,!0)}else{this.data.points.push(c);var e=this.data.points;b.mol.exec(function(a){a.handlePolygonSelect(e)},!0,!0)}for(var f=0;f<this.data.selAdd.atoms.length;f++)b.mol.atoms[this.data.selAdd.atoms[f]].select(!0);for(var f=0;f<this.data.selAdd.bonds.length;f++)b.mol.bonds[this.data.selAdd.bonds[f]].select(!0);b.requestRedraw()},onPointerUp:function(a,b){b.sel.updateRotationCenter(),b.requestRedraw()}},MolPad.prototype.getHandler=function(){return"atom"===this.tool.type?{onPointerDown:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b),d=new MPAtom(b,{i:b.mol.atoms.length,x:c.x,y:c.y,element:b.tool.data.element});b.mol.atoms.push(d),b.pointer.handler.scope=d}}:"bond"===this.tool.type?{onPointerDown:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b),d=new MPAtom(b,{i:b.mol.atoms.length,x:c.x-b.s.bond.length/2,y:c.y,element:"C",selected:!0});b.mol.atoms.push(d);var e=new MPAtom(b,{i:b.mol.atoms.length,x:c.x+b.s.bond.length/2,y:c.y,element:"C",selected:!0});b.mol.atoms.push(e);var f=new MPBond(b,{i:b.mol.bonds.length,from:d.index,to:e.index,type:b.tool.data.type,stereo:b.tool.data.stereo,selected:!0});b.mol.bonds.push(f),d.addBond(f.index),e.addBond(f.index),b.pointer.handler.scope=f,b.sel.update(),b.sel.center=c.clone(),b.sel.currentAngle=b.sel.startAngle=.5*Math.PI},onPointerMove:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b);b.sel.rotate(c)},onPointerUp:function(a,b){b.sel.clear()}}:"fragment"===this.tool.type?{onPointerDown:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b),d=MPFragments.translate(MPFragments.scale(MPFragments.clone(b.tool.data.frag.full),b.s.bond.length),c.x,c.y);b.mol.createFragment(d,!0),b.sel.center=c.clone(),b.sel.currentAngle=b.sel.startAngle=0},onPointerMove:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b);b.sel.rotate(c)},onPointerUp:function(a,b){b.sel.clear()}}:"chain"===this.tool.type?{onPointerDown:function(a,b){var c=(new MPPoint).fromRelativePointer(a,b),d=new MPAtom(b,{i:b.mol.atoms.length,x:c.x,y:c.y,element:"C"});b.mol.atoms.push(d),b.pointer.handler=d.getHandler()}}:"select"===this.tool.type?this.selectionToolHandler:this.mouseDragHandler};