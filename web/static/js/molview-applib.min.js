/*! MolView JavaScript App libraries build on 2016-06-13 */
function hexToRGB(a){return{r:parseInt(a.substring(1,3),16),g:parseInt(a.substring(3,5),16),b:parseInt(a.substring(5,7),16)}}function rgbCompToHex(a){a=a.toFixed(),a=Math.max(Math.min(a,255),0);var b=a.toString(16);return b.length<2&&(b="0"+b),b}function rgbToHex(a){return"#"+rgbCompToHex(a.r)+rgbCompToHex(a.g)+rgbCompToHex(a.b)}function rgbRescale(a,b){var c=.21*a.r+.72*a.g+.07*a.b;return b>=c?a:{r:(a.r*b/c).toFixed()-0,g:(a.g*b/c).toFixed()-0,b:(a.b*b/c).toFixed()-0}}!function(a){function b(b){if("string"==typeof b.data&&(b.data={keys:b.data}),b.data&&b.data.keys&&"string"==typeof b.data.keys){var c=b.handler,d=b.data.keys.toLowerCase().split(" ");b.handler=function(b){if(this===b.target||!(/textarea|select/i.test(b.target.nodeName)||a.hotkeys.options.filterTextInputs&&a.inArray(b.target.type,a.hotkeys.textAcceptingInputTypes)>-1)){var e="keypress"!==b.type&&a.hotkeys.specialKeys[b.which],f=String.fromCharCode(b.which).toLowerCase(),g="",h={};a.each(["alt","ctrl","shift"],function(a,c){b[c+"Key"]&&e!==c&&(g+=c+"+")}),b.metaKey&&!b.ctrlKey&&"meta"!==e&&(g+="meta+"),b.metaKey&&"meta"!==e&&g.indexOf("alt+ctrl+shift+")>-1&&(g=g.replace("alt+ctrl+shift+","hyper+")),e?h[g+e]=!0:(h[g+f]=!0,h[g+a.hotkeys.shiftNums[f]]=!0,"shift+"===g&&(h[a.hotkeys.shiftNums[f]]=!0));for(var i=0,j=d.length;j>i;i++)if(h[d[i]])return c.apply(this,arguments)}}}}a.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},textAcceptingInputTypes:["text","password","number","email","url","range","date","month","week","time","datetime","datetime-local","search","color","tel"],options:{filterTextInputs:!0}},a.each(["keydown","keyup","keypress"],function(){a.event.special[this]={add:b}})}(jQuery||this.jQuery||window.jQuery),function(a){if(a.URL=a.URL||a.webkitURL,a.Blob&&a.URL)try{return void new Blob}catch(b){}var c=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||function(a){var b=function(a){return Object.prototype.toString.call(a).match(/^\[object\s(.*)\]$/)[1]},c=function(){this.data=[]},d=function(a,b,c){this.data=a,this.size=a.length,this.type=b,this.encoding=c},e=c.prototype,f=d.prototype,g=a.FileReaderSync,h=function(a){this.code=this[this.name=a]},i="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),j=i.length,k=a.URL||a.webkitURL||a,l=k.createObjectURL,m=k.revokeObjectURL,n=k,o=a.btoa,p=a.atob,q=a.ArrayBuffer,r=a.Uint8Array,s=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;for(d.fake=f.fake=!0;j--;)h.prototype[i[j]]=j+1;return k.createObjectURL||(n=a.URL=function(a){var b,c=document.createElementNS("http://www.w3.org/1999/xhtml","a");return c.href=a,"origin"in c||("data:"===c.protocol.toLowerCase()?c.origin=null:(b=a.match(s),c.origin=b&&b[1])),c}),n.createObjectURL=function(a){var b,c=a.type;return null===c&&(c="application/octet-stream"),a instanceof d?(b="data:"+c,"base64"===a.encoding?b+";base64,"+a.data:"URI"===a.encoding?b+","+decodeURIComponent(a.data):o?b+";base64,"+o(a.data):b+","+encodeURIComponent(a.data)):l?l.call(k,a):void 0},n.revokeObjectURL=function(a){"data:"!==a.substring(0,5)&&m&&m.call(k,a)},e.append=function(a){var c=this.data;if(r&&(a instanceof q||a instanceof r)){for(var e="",f=new r(a),i=0,j=f.length;j>i;i++)e+=String.fromCharCode(f[i]);c.push(e)}else if("Blob"===b(a)||"File"===b(a)){if(!g)throw new h("NOT_READABLE_ERR");var k=new g;c.push(k.readAsBinaryString(a))}else a instanceof d?"base64"===a.encoding&&p?c.push(p(a.data)):"URI"===a.encoding?c.push(decodeURIComponent(a.data)):"raw"===a.encoding&&c.push(a.data):("string"!=typeof a&&(a+=""),c.push(unescape(encodeURIComponent(a))))},e.getBlob=function(a){return arguments.length||(a=null),new d(this.data.join(""),a,"raw")},e.toString=function(){return"[object BlobBuilder]"},f.slice=function(a,b,c){var e=arguments.length;return 3>e&&(c=null),new d(this.data.slice(a,e>1?b:this.data.length),c,this.encoding)},f.toString=function(){return"[object Blob]"},f.close=function(){this.size=0,delete this.data},c}(a);a.Blob=function(a,b){var d=b?b.type||"":"",e=new c;if(a)for(var f=0,g=a.length;g>f;f++)Uint8Array&&a[f]instanceof Uint8Array?e.append(a[f].buffer):e.append(a[f]);var h=e.getBlob(d);return!h.slice&&h.webkitSlice&&(h.slice=h.webkitSlice),h};var d=Object.getPrototypeOf||function(a){return a.__proto__};a.Blob.prototype=d(new a.Blob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);var saveAs=saveAs||function(a){if(!("undefined"==typeof a||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e="download"in d,f=function(a){var b=new MouseEvent("click");a.dispatchEvent(b)},g=/constructor/i.test(a.HTMLElement),h=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},i="application/octet-stream",j=4e4,k=function(a){var b=function(){"string"==typeof a?c().revokeObjectURL(a):a.remove()};setTimeout(b,j)},l=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){h(f)}}},m=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob([String.fromCharCode(65279),a],{type:a.type}):a},n=function(b,h,j){j||(b=m(b));var n,o=this,p=b.type,q=p===i,r=function(){l(o,"writestart progress write writeend".split(" "))},s=function(){if(q&&g&&a.FileReader){var d=new FileReader;return d.onloadend=function(){var b=d.result;a.location.href="data:attachment/file"+b.slice(b.search(/[,;]/)),o.readyState=o.DONE,r()},d.readAsDataURL(b),void(o.readyState=o.INIT)}if(n||(n=c().createObjectURL(b)),q)a.location.href=n;else{var e=a.open(n,"_blank");e||(a.location.href=n)}o.readyState=o.DONE,r(),k(n)};return o.readyState=o.INIT,e?(n=c().createObjectURL(b),void setTimeout(function(){d.href=n,d.download=h,f(d),r(),k(n),o.readyState=o.DONE})):void s()},o=n.prototype,p=function(a,b,c){return new n(a,b||a.name||"download",c)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(a,b,c){return b=b||a.name||"download",c||(a=m(a)),navigator.msSaveOrOpenBlob(a,b)}:(o.abort=function(){},o.readyState=o.INIT=0,o.WRITING=1,o.DONE=2,o.error=o.onwritestart=o.onprogress=o.onwrite=o.onabort=o.onerror=o.onwriteend=null,p)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs}),Array.prototype.each=function(a,b){for(var c=0,d=this.length>>>0;d>c;c++)if(c in this&&a.call(b,this[c],c,this)===!1)return},Array.prototype.clone=function(){return Array.prototype.slice.call(this,0)},Array.prototype.find=function(){var a;return this.each(function(b,c){return iterator.call(context,b,c,this)?(a=b,!1):!0},this),a},Array.prototype.findAll=function(){var a=[];return this.each(function(b,c){iterator.call(context,b,c,this)&&a.push(b)},this),a},Number.prototype.toPaddedString=function(a){var b=this+"";return b.length>=a?b:new Array(a-b.length+1).join("0")+b},window.util||(util={});var EventMap={mousemove:"mousemove",mousedown:"mousedown",mouseup:"mouseup"};if(Array.prototype.swap=function(a,b){var c=this[a];this[a]=this[b],this[b]=c},util.each=function(a,b,c){util.assert(!util.isNullOrUndefined(a),"array must be defined");for(var d=0;d<a.length;++d)b.call(c,a[d],d)},util.map_each=function(a,b,c){util.assert(!util.isNullOrUndefined(a),"map must be defined");for(var d in a)b.call(c,d,a[d])},util.find=function(a,b,c){for(var d=0;d<a.length;++d)if(b.call(c,a[d],d))return d;return-1},util.findAll=function(a,b,c){for(var d=[],e=0;e<a.length;++e)b.call(c,a[e],e)&&d.push(a[e]);return d},util.array=function(a){for(var b=[],c=a.length;--c>=0;)b[c]=a[c];return b},util.isEmpty=function(a){for(var b in a)return!1;return!0},util.stopEventPropagation=function(a){if("stopPropagation"in a)a.stopPropagation();else{if(!("cancelBubble"in a))throw Error("Browser unrecognized");a.cancelBubble=!0}},util.preventDefault=function(a){return"preventDefault"in a&&a.preventDefault(),Prototype.Browser.IE&&(a.returnValue=!1,a.keyCode=0),!1},util.setElementTextContent=function(a,b){if("textContent"in a)a.textContent=b;else{if(!("innerText"in a))throw Error("Browser unrecognized");a.innerText=b}},util.getElementTextContent=function(a){if("textContent"in a)return a.textContent;if("innerText"in a)return a.innerText;throw Error("Browser unrecognized")},util.stringPadded=function(a,b,c){a+="";for(var d="";a.length+d.length<b;)d+=" ";return c?a+d:d+a},util.idList=function(a){var b=[];for(var c in a)b.push(c);return b},util.mapArray=function(a,b){for(var c=[],d=0;d<a.length;++d)c.push(b[a[d]]);return c},util.arrayMax=function(a){return Math.max.apply(Math,a)},util.arrayMin=function(a){return Math.min.apply(Math,a)},util.map=function(a,b,c){for(var d=[],e=0;e<a.length;++e)d.push(b.call(c,a[e]));return d},util.apply=function(a,b){for(var c=0;c<a.length;++c)a[c]=b(a[c])},util.isUndefined=function(a){return"undefined"==typeof a},util.ifDef=function(a,b,c,d){a[c]=util.isUndefined(b[c])?d:b[c]},util.ifDefList=function(a,b,c,d){a[c]=util.isUndefined(b[c])||null===b[c]?d:util.array(b[c])},util.identityMap=function(a){for(var b={},c=0;c<a.length;++c)b[a[c]]=a[c];return b},util.strip=function(a){return a.replace(/\s*$/,"").replace(/^\s*/,"")},util.stripRight=function(a){return a.replace(/\s*$/,"")},util.stripQuotes=function(a){return'"'===a[0]&&'"'===a[a.length-1]?a.substr(1,a.length-2):a},util.paddedFloat=function(a,b,c){var d=a.toFixed(c).replace(",",".");if(d.length>b)throw new Error("number does not fit");return util.stringPadded(d,b)},util.paddedInt=function(a,b){var c=a.toFixed(0);if(c.length>b)throw new Error("number does not fit");return util.stringPadded(c,b)},util.arrayAddIfMissing=function(a,b){for(var c=0;c<a.length;++c)if(a[c]===b)return!1;return a.push(b),!0},util.assert=function(a,b){if(!a)throw new Error(b?"Assertion failed: "+b:"Assertion failed")},util.isNull=function(a){return null===a},util.isNullOrUndefined=function(a){return util.isUndefined(a)||util.isNull(a)},util.arrayRemoveByValue=function(a,b){util.assert(!util.isUndefined(a)&&!util.isNull(a),"array must be defined");for(var c=a.indexOf(b),d=0;c>=0;)a.splice(c,1),d+=1,c=a.indexOf(b);return d},util.listNextRotate=function(a,b){return a[(a.indexOf(b)+1)%a.length]},util.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},window.util||(util={}),util.assertDefined=function(a){util.assert(!util.isNullOrUndefined(a))},util.Vec2=function(a,b){if(0==arguments.length)this.x=0,this.y=0;else if(1==arguments.length)this.x=parseFloat(a.x),this.y=parseFloat(a.y);else{if(2!=arguments.length)throw new Error("util.Vec2(): invalid arguments");this.x=parseFloat(a),this.y=parseFloat(b)}},util.Vec2.ZERO=new util.Vec2(0,0),util.Vec2.UNIT=new util.Vec2(1,1),util.Vec2.segmentIntersection=function(a,b,c,d){var e=(a.x-c.x)*(b.y-c.y)-(a.y-c.y)*(b.x-c.x),f=(a.x-d.x)*(b.y-d.y)-(a.y-d.y)*(b.x-d.x),g=(c.x-a.x)*(d.y-a.y)-(c.y-a.y)*(d.x-a.x),h=(c.x-b.x)*(d.y-b.y)-(c.y-b.y)*(d.x-b.x);return 0>=e*f&&0>=g*h},util.Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},util.Vec2.prototype.equals=function(a){return util.assertDefined(a),this.x==a.x&&this.y==a.y},util.Vec2.prototype.add=function(a){return util.assertDefined(a),new util.Vec2(this.x+a.x,this.y+a.y)},util.Vec2.prototype.add_=function(a){util.assertDefined(a),this.x+=a.x,this.y+=a.y},util.Vec2.prototype.sub=function(a){return util.assertDefined(a),new util.Vec2(this.x-a.x,this.y-a.y)},util.Vec2.prototype.scaled=function(a){return util.assertDefined(a),new util.Vec2(this.x*a,this.y*a)},util.Vec2.prototype.negated=function(){return new util.Vec2(-this.x,-this.y)},util.Vec2.prototype.yComplement=function(a){return a=a||0,new util.Vec2(this.x,a-this.y)},util.Vec2.prototype.addScaled=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Vec2(this.x+a.x*b,this.y+a.y*b)},util.Vec2.prototype.normalized=function(){return this.scaled(1/this.length())},util.Vec2.prototype.normalize=function(){var a=this.length();return 1e-6>a?!1:(this.x/=a,this.y/=a,!0)},util.Vec2.prototype.turnLeft=function(){return new util.Vec2(-this.y,this.x)},util.Vec2.prototype.coordStr=function(){return this.x.toString()+" , "+this.y.toString()},util.Vec2.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},util.Vec2.dist=function(a,b){return util.assertDefined(a),util.assertDefined(b),util.Vec2.diff(a,b).length()},util.Vec2.max=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Vec2(Math.max(a.x,b.x),Math.max(a.y,b.y))},util.Vec2.min=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Vec2(Math.min(a.x,b.x),Math.min(a.y,b.y))},util.Vec2.prototype.max=function(a){return util.assertDefined(a),new util.Vec2.max(this,a)},util.Vec2.prototype.min=function(a){return util.assertDefined(a),new util.Vec2.min(this,a)},util.Vec2.prototype.ceil=function(){return new util.Vec2(Math.ceil(this.x),Math.ceil(this.y))},util.Vec2.prototype.floor=function(){return new util.Vec2(Math.floor(this.x),Math.floor(this.y))},util.Vec2.sum=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Vec2(a.x+b.x,a.y+b.y)},util.Vec2.dot=function(a,b){return util.assertDefined(a),util.assertDefined(b),a.x*b.x+a.y*b.y},util.Vec2.cross=function(a,b){return util.assertDefined(a),util.assertDefined(b),a.x*b.y-a.y*b.x},util.Vec2.prototype.rotate=function(a){util.assertDefined(a);var b=Math.sin(a),c=Math.cos(a);return this.rotateSC(b,c)},util.Vec2.prototype.rotateSC=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Vec2(this.x*b-this.y*a,this.x*a+this.y*b)},util.Vec2.angle=function(a,b){return util.assertDefined(a),util.assertDefined(b),Math.atan2(util.Vec2.cross(a,b),util.Vec2.dot(a,b))},util.Vec2.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},util.Vec2.diff=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Vec2(a.x-b.x,a.y-b.y)},util.Vec2.lc=function(){for(var a=new util.Vec2,b=0;b<arguments.length/2;++b)a=a.addScaled(arguments[2*b],arguments[2*b+1]);return a},util.Vec2.lc2=function(a,b,c,d){return util.assertDefined(a),util.assertDefined(c),util.assertDefined(b),util.assertDefined(d),new util.Vec2(a.x*b+c.x*d,a.y*b+c.y*d)},util.Vec2.centre=function(a,b){return new util.Vec2.lc2(a,.5,b,.5)},util.Box2Abs=function(){1==arguments.length&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),2==arguments.length&&arguments[0]instanceof util.Vec2&&arguments[1]instanceof util.Vec2?(this.p0=arguments[0],this.p1=arguments[1]):4==arguments.length?(this.p0=new util.Vec2(arguments[0],arguments[1]),this.p1=new util.Vec2(arguments[2],arguments[3])):0==arguments.length?(this.p0=new util.Vec2,this.p1=new util.Vec2):new Error("util.Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")},util.Box2Abs.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},util.Box2Abs.fromRelBox=function(a){return util.assertDefined(a),new util.Box2Abs(a.x,a.y,a.x+a.width,a.y+a.height)},util.Box2Abs.prototype.clone=function(){return new util.Box2Abs(this.p0,this.p1)},util.Box2Abs.union=function(a,b){return util.assertDefined(a),util.assertDefined(b),new util.Box2Abs(util.Vec2.min(a.p0,b.p0),util.Vec2.max(a.p1,b.p1))},util.Box2Abs.prototype.extend=function(a,b){return util.assertDefined(a),b=b||a,new util.Box2Abs(this.p0.sub(a),this.p1.add(b))},util.Box2Abs.prototype.include=function(a){return util.assertDefined(a),new util.Box2Abs(this.p0.min(a),this.p1.max(a))},util.Box2Abs.prototype.contains=function(a,b){return b=(b||0)-0,util.assertDefined(a),a.x>=this.p0.x-b&&a.x<=this.p1.x+b&&a.y>=this.p0.y-b&&a.y<=this.p1.y+b},util.Box2Abs.prototype.translate=function(a){return util.assertDefined(a),new util.Box2Abs(this.p0.add(a),this.p1.add(a))},util.Box2Abs.prototype.transform=function(a,b){return util.assert(!util.isNullOrUndefined(a)),new util.Box2Abs(a.call(b,this.p0),a.call(b,this.p1))},util.Box2Abs.prototype.sz=function(){return this.p1.sub(this.p0)},util.Box2Abs.prototype.centre=function(){return util.Vec2.centre(this.p0,this.p1)},util.Box2Abs.prototype.pos=function(){return this.p0},util.Vec2.shiftRayBox=function(a,b,c){util.assertDefined(a),util.assertDefined(b),util.assertDefined(c);var d=[c.p0,new util.Vec2(c.p1.x,c.p0.y),c.p1,new util.Vec2(c.p0.x,c.p1.y)],e=d.map(function(b){return b.sub(a)});b=b.normalized();for(var f=e.map(function(a){return util.Vec2.cross(a,b)}),g=e.map(function(a){return util.Vec2.dot(a,b)}),h=-1,i=-1,j=0;4>j;++j)f[j]>0?(0>h||g[h]<g[j])&&(h=j):(0>i||g[i]<g[j])&&(i=j);if(0>i||0>h)return 0;var k,l;return g[h]>g[i]?(k=i,l=h):(k=h,l=i),g[k]+Math.abs(f[k])*(g[l]-g[k])/(Math.abs(f[k])+Math.abs(f[l]))},window.util||(util={}),util.Set={empty:function(){return{}},single:function(a){var b={};return util.Set.add(b,a),b},size:function(a){var b=0;for(var c in a)a[c]!==Object.prototype[c]&&b++;return b},contains:function(a,b){return"undefined"!=typeof a[b]&&a[b]!==Object.prototype[b]},subset:function(a,b){for(var c in a)if(a[c]!==Object.prototype[c]&&b[c]!==a[c])return!1;return!0},intersection:function(a,b){var c={};for(var d in a)a[d]!==Object.prototype[d]&&b[d]===a[d]&&util.Set.add(c,d);return c},disjoint:function(a,b){for(var c in a)if(a[c]!==Object.prototype[c]&&b[c]===a[c])return!1;return!0},eq:function(a,b){return util.Set.subset(a,b)&&util.Set.subset(b,a)},each:function(a,b,c){for(var d in a)a[d]!==Object.prototype[d]&&b.call(c,a[d])},filter:function(a,b,c){var d={};for(var e in a)a[e]!==Object.prototype[e]&&b.call(c,a[e])&&(d[a[e]]=a[e]);return d},pick:function(a){for(var b in a)if(a[b]!==Object.prototype[b])return a[b];return null},list:function(a){var b=[];for(var c in a)a[c]!==Object.prototype[c]&&b.push(a[c]);return b},add:function(a,b){a[b]=b},mergeIn:function(a,b){util.Set.each(b,function(b){util.Set.add(a,b)})},remove:function(a,b){var c=a[b];return delete a[b],c},clone:function(a){var b={};return util.Set.mergeIn(b,a),b},fromList:function(a){var b={};if(a)for(var c=0;c<a.length;++c)b[a[c]-0]=a[c]-0;return b},keySetInt:function(a){var b={};return a.each(function(a){b[a-0]=a-0}),b},find:function(a,b,c){for(var d in a)if(a[d]!==Object.prototype[d]&&b.call(c,a[d]))return d;return null}},window.util||(util={}),util.Map=function(a){if("undefined"!=typeof a&&a.constructor!==Object)throw Error("Passed object is not an instance of 'Object'!");this._obj=a||{},this._count=0},util.Map.prototype.each=function(a,b){for(var c in this._obj){var d=parseInt(c),e=this._obj[c];isNaN(d)||(c=d),a.call(b,c,e)}},util.Map.prototype.map=function(a,b){var c=new util.Map;return this.each(function(d,e){c.set(d,a.call(b,d,e))},this),c},util.Map.prototype.find=function(a,b){for(var c in this._obj){var d=parseInt(c),e=this._obj[c];if(isNaN(d)||(c=d),a.call(b,c,e))return c}},util.Map.prototype.findAll=function(a,b){var c=[];for(var d in this._obj){var e=parseInt(d),f=this._obj[d];isNaN(e)||(d=e),a.call(b,d,f)&&c.push(d)}return c},util.Map.prototype.keys=function(){var a=[];for(var b in this._obj)a.push(b);return a},util.Map.prototype.ikeys=function(){var a=[];for(var b in this._obj)a.push(b-0);return a},util.Map.prototype.set=function(a,b){if(this._count+=("undefined"!=typeof b?1:0)-("undefined"!=typeof this._obj[a]?1:0),"undefined"==typeof b){var c=this._obj[a];return delete this._obj[a],c}return this._obj[a]=b},util.Map.prototype.get=function(a){return this._obj[a]!==Object.prototype[a]?this._obj[a]:void 0},util.Map.prototype.has=function(a){return this._obj[a]!==Object.prototype[a]},util.Map.prototype.unset=function(a){return this.set(a,void 0)},util.Map.prototype.update=function(a){for(var b in a)this.set(b,a[b])},util.Map.prototype.clear=function(){this._obj={},this._count=0},util.Map.prototype.count=function(){return this._count},util.Map.prototype.idList=function(){return util.idList(this._obj)},util.Map.prototype.keyOf=function(a){for(var b in this._obj)if(this._obj[b]===a)return b},!window.util||!util.Map)throw new Error("Map should be defined first");if(util.Pool=function(){this._map=new util.Map,this._nextId=0},util.Pool.prototype.newId=function(){return this._nextId++},util.Pool.prototype.add=function(a){var b=this._nextId++;return this._map.set(b,a),b},util.Pool.prototype.set=function(a,b){this._map.set(a,b)},util.Pool.prototype.get=function(a){return this._map.get(a)},util.Pool.prototype.has=function(a){return this._map.has(a)},util.Pool.prototype.remove=function(a){return this._map.unset(a)},util.Pool.prototype.clear=function(){this._map.clear()},util.Pool.prototype.keys=function(){return this._map.keys()},util.Pool.prototype.ikeys=function(){return this._map.ikeys()},util.Pool.prototype.each=function(a,b){this._map.each(a,b)},util.Pool.prototype.map=function(a,b){return this._map.map(a,b)},util.Pool.prototype.find=function(a,b){return this._map.find(a,b)},util.Pool.prototype.count=function(){return this._map.count()},util.Pool.prototype.keyOf=function(a){return this._map.keyOf(a)},!window.util||!util.Vec2)throw new Error("Vec2 should be defined first");if(window.chem||(chem={}),chem.Element=function(a,b,c,d,e,f,g){this.label=a,this.period=b,this.group=c,this.putHydrogenOnTheLeft=d,this.color=e||"#000000",this.labelColor=rgbToHex(rgbRescale(hexToRGB(this.color),150)),this.xpos=g||c,this.ypos=f||b;var h=("0x"+this.color.substring(1,3)-0)/255,i=("0x"+this.color.substring(3,5)-0)/255,j=("0x"+this.color.substring(5,7)-0)/255,k=.299*h+.587*i+.114*j;k>.6&&(h*=.6/k,i*=.6/k,j*=.6/k),h=Math.ceil(Math.min(255*h,255)).toString(16),i=Math.ceil(Math.min(255*i,255)).toString(16),j=Math.ceil(Math.min(255*j,255)).toString(16),h=1==h.length?"0"+h:h,i=1==i.length?"0"+i:i,j=1==j.length?"0"+j:j,this.color="#"+h+i+j},chem.Element.elements=new util.Map({1:new chem.Element("H",1,1,!1,"#000000",1,1),2:new chem.Element("He",1,8,!1,"#d9ffff",1,18),3:new chem.Element("Li",2,1,!1,"#cc80ff",2,1),4:new chem.Element("Be",2,2,!1,"#c2ff00",2,2),5:new chem.Element("B",2,3,!1,"#ffb5b5",2,13),6:new chem.Element("C",2,4,!1,"#000000",2,14),7:new chem.Element("N",2,5,!1,"#304ff7",2,15),8:new chem.Element("O",2,6,!0,"#ff0d0d",2,16),9:new chem.Element("F",2,7,!0,"#8fe04f",2,17),10:new chem.Element("Ne",2,8,!1,"#b3e3f5",2,18),11:new chem.Element("Na",3,1,!1,"#ab5cf2",3,1),12:new chem.Element("Mg",3,2,!1,"#8aff00",3,2),13:new chem.Element("Al",3,3,!1,"#bfa6a6",3,13),14:new chem.Element("Si",3,4,!1,"#f0c7a1",3,14),15:new chem.Element("P",3,5,!1,"#ff8000",3,15),16:new chem.Element("S",3,6,!0,"#d9a61a",3,16),17:new chem.Element("Cl",3,7,!0,"#1fd01f",3,17),18:new chem.Element("Ar",3,8,!1,"#80d1e3",3,18),19:new chem.Element("K",4,1,!1,"#8f40d4",4,1),20:new chem.Element("Ca",4,2,!1,"#3dff00",4,2),21:new chem.Element("Sc",4,3,!1,"#e6e6e6",4,3),22:new chem.Element("Ti",4,4,!1,"#bfc2c7",4,4),23:new chem.Element("V",4,5,!1,"#a6a6ab",4,5),24:new chem.Element("Cr",4,6,!1,"#8a99c7",4,6),25:new chem.Element("Mn",4,7,!1,"#9c7ac7",4,7),26:new chem.Element("Fe",4,8,!1,"#e06633",4,8),27:new chem.Element("Co",4,8,!1,"#f08fa1",4,9),28:new chem.Element("Ni",4,8,!1,"#4fd14f",4,10),29:new chem.Element("Cu",4,1,!1,"#c78033",4,11),30:new chem.Element("Zn",4,2,!1,"#7d80b0",4,12),31:new chem.Element("Ga",4,3,!1,"#c28f8f",4,13),32:new chem.Element("Ge",4,4,!1,"#668f8f",4,14),33:new chem.Element("As",4,5,!1,"#bd80e3",4,15),34:new chem.Element("Se",4,6,!0,"#ffa100",4,16),35:new chem.Element("Br",4,7,!0,"#a62929",4,17),36:new chem.Element("Kr",4,8,!1,"#5cb8d1",4,18),37:new chem.Element("Rb",5,1,!1,"#702eb0",5,1),38:new chem.Element("Sr",5,2,!1,"#00ff00",5,2),39:new chem.Element("Y",5,3,!1,"#94ffff",5,3),40:new chem.Element("Zr",5,4,!1,"#94e0e0",5,4),41:new chem.Element("Nb",5,5,!1,"#73c2c9",5,5),42:new chem.Element("Mo",5,6,!1,"#54b5b5",5,6),43:new chem.Element("Tc",5,7,!1,"#3b9e9e",5,7),44:new chem.Element("Ru",5,8,!1,"#248f8f",5,8),45:new chem.Element("Rh",5,8,!1,"#0a7d8c",5,9),46:new chem.Element("Pd",5,8,!1,"#006985",5,10),47:new chem.Element("Ag",5,1,!1,"#bfbfbf",5,11),48:new chem.Element("Cd",5,2,!1,"#ffd98f",5,12),49:new chem.Element("In",5,3,!1,"#a67573",5,13),50:new chem.Element("Sn",5,4,!1,"#668080",5,14),51:new chem.Element("Sb",5,5,!1,"#9e63b5",5,15),52:new chem.Element("Te",5,6,!1,"#d47a00",5,16),53:new chem.Element("I",5,7,!0,"#940094",5,17),54:new chem.Element("Xe",5,8,!1,"#429eb0",5,18),55:new chem.Element("Cs",6,1,!1,"#57178f",6,1),56:new chem.Element("Ba",6,2,!1,"#00c900",6,2),57:new chem.Element("La",6,3,!1,"#70d4ff",6,3),58:new chem.Element("Ce",6,3,!1,"#ffffc7",8,4),59:new chem.Element("Pr",6,3,!1,"#d9ffc7",8,5),60:new chem.Element("Nd",6,3,!1,"#c7ffc7",8,6),61:new chem.Element("Pm",6,3,!1,"#a3ffc7",8,7),62:new chem.Element("Sm",6,3,!1,"#8fffc7",8,8),63:new chem.Element("Eu",6,3,!1,"#61ffc7",8,9),64:new chem.Element("Gd",6,3,!1,"#45ffc7",8,10),65:new chem.Element("Tb",6,3,!1,"#30ffc7",8,11),66:new chem.Element("Dy",6,3,!1,"#1fffc7",8,12),67:new chem.Element("Ho",6,3,!1,"#00ff9c",8,13),68:new chem.Element("Er",6,3,!1,"#00e675",8,14),69:new chem.Element("Tm",6,3,!1,"#00d452",8,15),70:new chem.Element("Yb",6,3,!1,"#00bf38",8,16),71:new chem.Element("Lu",6,3,!1,"#00ab24",8,17),72:new chem.Element("Hf",6,4,!1,"#4dc2ff",6,4),73:new chem.Element("Ta",6,5,!1,"#4da6ff",6,5),74:new chem.Element("W",6,6,!1,"#2194d6",6,6),75:new chem.Element("Re",6,7,!1,"#267dab",6,7),76:new chem.Element("Os",6,8,!1,"#266696",6,8),77:new chem.Element("Ir",6,8,!1,"#175487",6,9),78:new chem.Element("Pt",6,8,!1,"#d1d1e0",6,10),79:new chem.Element("Au",6,1,!1,"#ffd124",6,11),80:new chem.Element("Hg",6,2,!1,"#b8b8d1",6,12),81:new chem.Element("Tl",6,3,!1,"#a6544d",6,13),82:new chem.Element("Pb",6,4,!1,"#575961",6,14),83:new chem.Element("Bi",6,5,!1,"#9e4fb5",6,15),84:new chem.Element("Po",6,6,!1,"#ab5c00",6,16),85:new chem.Element("At",6,7,!1,"#754f45",6,17),86:new chem.Element("Rn",6,8,!1,"#428296",6,18),87:new chem.Element("Fr",7,1,!1,"#420066",7,1),88:new chem.Element("Ra",7,2,!1,"#007d00",7,2),89:new chem.Element("Ac",7,3,!1,"#70abfa",7,3),90:new chem.Element("Th",7,3,!1,"#00baff",9,4),91:new chem.Element("Pa",7,3,!1,"#00a1ff",9,5),92:new chem.Element("U",7,3,!1,"#008fff",9,6),93:new chem.Element("Np",7,3,!1,"#0080ff",9,7),94:new chem.Element("Pu",7,3,!1,"#006bff",9,8),95:new chem.Element("Am",7,3,!1,"#545cf2",9,9),96:new chem.Element("Cm",7,3,!1,"#785ce3",9,10),97:new chem.Element("Bk",7,3,!1,"#8a4fe3",9,11),98:new chem.Element("Cf",7,3,!1,"#a136d4",9,12),99:new chem.Element("Es",7,3,!1,"#b31fd4",9,13),100:new chem.Element("Fm",7,3,!1,"#B31FBA",9,14),101:new chem.Element("Md",7,3,!1,"#B30DA6",9,15),102:new chem.Element("No",7,3,!1,"#BD0D87",9,16),103:new chem.Element("Lr",7,3,!1,"#C70066",9,17),104:new chem.Element("Rf",7,4,!1,"#CC0059",7,4),105:new chem.Element("Db",7,5,!1,"#D1004F",7,5),106:new chem.Element("Sg",7,6,!1,"#D90045",7,6),107:new chem.Element("Bh",7,7,!1,"#E00038",7,7),108:new chem.Element("Hs",7,8,!1,"#E6002E",7,8),109:new chem.Element("Mt",7,8,!1,"#EB0026",7,9),110:new chem.Element("Ds",7,8,!1,"#9595a0",7,10),111:new chem.Element("Rg",7,1,!1,"#b9981a",7,11),112:new chem.Element("Cn",7,2,!1,"#9595a9",7,12)}),chem.Element.labelMap=null,chem.Element.getElementByLabel=function(a){return this.labelMap||(this.labelMap={},this.elements.each(function(a,b){this.labelMap[b.label]=a-0},this)),this.labelMap.hasOwnProperty(a)?this.labelMap[a]:null},!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");if(chem.Struct=function(){this.atoms=new util.Pool,this.bonds=new util.Pool,this.sgroups=new util.Pool,this.halfBonds=new util.Map,this.loops=new util.Pool,this.isChiral=!1,this.isReaction=!1,this.rxnArrows=new util.Pool,this.rxnPluses=new util.Pool,this.frags=new util.Pool,this.rgroups=new util.Map,this.name="",this.sGroupForest=new chem.SGroupForest(this)},chem.Struct.prototype.hasRxnProps=function(){return this.atoms.find(function(a,b){return b.hasRxnProps()},this)>=0||this.bonds.find(function(a,b){return b.hasRxnProps()},this)>=0},chem.Struct.prototype.hasRxnArrow=function(){return this.rxnArrows.count()>0},chem.Struct.prototype.addRxnArrowIfNecessary=function(){var a=!this.hasRxnArrow()&&this.hasRxnProps();return a&&this.rxnArrows.add(new chem.Struct.RxnArrow),a},chem.Struct.prototype.getSGroupsInAtomSet=function(a){var b=new Hash;util.each(a,function(a){var c=util.Set.list(this.atoms.get(a).sgs);c.each(function(a){var c=b.get(a);util.isUndefined(c)?c=1:c++,b.set(a,c)},this)},this);var c=[];return b.each(function(a){var b=parseInt(a.key),d=this.sgroups.get(b),e=chem.SGroup.getAtoms(this,d);a.value==e.length&&c.push(b)},this),c},chem.Struct.prototype.isBlank=function(){return 0==this.atoms.count()&&0==this.rxnArrows.count()&&0==this.rxnPluses.count()&&!this.isChiral},chem.Struct.prototype.toLists=function(){var a={},b=[];this.atoms.each(function(c,d){a[c]=b.length,b.push(d)});var c=[];return this.bonds.each(function(b,d){var e=new chem.Struct.Bond(d);e.begin=a[d.begin],e.end=a[d.end],c.push(e)}),{atoms:b,bonds:c}},chem.Struct.prototype.clone=function(a,b,c,d){var e=new chem.Struct;return this.mergeInto(e,a,b,c,!1,d)},chem.Struct.prototype.getScaffold=function(){var a=util.Set.empty();return this.atoms.each(function(b){util.Set.add(a,b)},this),this.rgroups.each(function(b,c){c.frags.each(function(b,c){this.atoms.each(function(b,d){d.fragment==c&&util.Set.remove(a,b)},this)},this)},this),this.clone(a)},chem.Struct.prototype.getFragmentIds=function(a){var b=util.Set.empty();return this.atoms.each(function(c,d){d.fragment==a&&util.Set.add(b,c)},this),b},chem.Struct.prototype.getFragment=function(a){return this.clone(this.getFragmentIds(a))},chem.Struct.prototype.mergeInto=function(a,b,c,d,e,f){b=b||util.Set.keySetInt(this.atoms),c=c||util.Set.keySetInt(this.bonds),c=util.Set.filter(c,function(a){var c=this.bonds.get(a);return util.Set.contains(b,c.begin)&&util.Set.contains(b,c.end)},this);var g={};this.atoms.each(function(a,c){util.Set.contains(b,a)&&(g[c.fragment]=1)});var h={};this.frags.each(function(b,c){g[b]&&(h[b]=a.frags.add(c.clone()))}),this.rgroups.each(function(b,c){var d=e;if(d||(c.frags.each(function(a,b){g[b]&&(d=!0)}),d)){var f=a.rgroups.get(b);f?c.frags.each(function(a,b){g[b]&&f.frags.add(h[b])}):a.rgroups.set(b,c.clone(h))}}),"undefined"!=typeof f&&null!==f||(f={}),this.atoms.each(function(c,d){util.Set.contains(b,c)&&(f[c]=a.atoms.add(d.clone(h)))});var i={};return this.bonds.each(function(b,d){util.Set.contains(c,b)&&(i[b]=a.bonds.add(d.clone(f)))}),this.sgroups.each(function(c,d){var e;for(e=0;e<d.atoms.length;++e)if(!util.Set.contains(b,d.atoms[e]))return;d=chem.SGroup.clone(d,f,i);var g=a.sgroups.add(d);for(d.id=g,e=0;e<d.atoms.length;++e)util.Set.add(a.atoms.get(d.atoms[e]).sgs,g);a.sGroupForest.insert(d.id)}),a.isChiral=this.isChiral,d||(a.isReaction=this.isReaction,this.rxnArrows.each(function(b,c){a.rxnArrows.add(c.clone())}),this.rxnPluses.each(function(b,c){a.rxnPluses.add(c.clone())})),a},chem.Struct.prototype.findBondId=function(a,b){var c=-1;return this.bonds.find(function(d,e){return e.begin==a&&e.end==b||e.begin==b&&e.end==a?(c=d,
!0):!1},this),c},chem.Struct.ATOM={RADICAL:{NONE:0,SINGLET:1,DOUPLET:2,TRIPLET:3}},chem.Struct.radicalElectrons=function(a){if(a-=0,a==chem.Struct.ATOM.RADICAL.NONE)return 0;if(a==chem.Struct.ATOM.RADICAL.DOUPLET)return 1;if(a==chem.Struct.ATOM.RADICAL.SINGLET||a==chem.Struct.ATOM.RADICAL.TRIPLET)return 2;throw new Error("Unknown radical value")},chem.Struct.BOND={TYPE:{SINGLE:1,DOUBLE:2,TRIPLE:3,AROMATIC:4,SINGLE_OR_DOUBLE:5,SINGLE_OR_AROMATIC:6,DOUBLE_OR_AROMATIC:7,ANY:8},STEREO:{NONE:0,UP:1,EITHER:4,DOWN:6,CIS_TRANS:3},TOPOLOGY:{EITHER:0,RING:1,CHAIN:2},REACTING_CENTER:{NOT_CENTER:-1,UNMARKED:0,CENTER:1,UNCHANGED:2,MADE_OR_BROKEN:4,ORDER_CHANGED:8,MADE_OR_BROKEN_AND_CHANGED:12}},chem.Struct.FRAGMENT={NONE:0,REACTANT:1,PRODUCT:2,AGENT:3},chem.Struct.Atom=function(a){var b=chem.Struct.Atom.attrGetDefault;if(!(a&&"label"in a))throw new Error("Label must be specified!");this.label=a.label,this.fragment=util.isUndefined(a.fragment)?-1:a.fragment,util.ifDef(this,a,"isotope",b("isotope")),util.ifDef(this,a,"radical",b("radical")),util.ifDef(this,a,"charge",b("charge")),util.ifDef(this,a,"rglabel",b("rglabel")),util.ifDef(this,a,"attpnt",b("attpnt")),util.ifDef(this,a,"explicitValence",b("explicitValence")),this.valence=0,this.implicitH=0,util.isUndefined(a.pp)?this.pp=new util.Vec2:this.pp=new util.Vec2(a.pp),this.sgs={},util.ifDef(this,a,"ringBondCount",b("ringBondCount")),util.ifDef(this,a,"substitutionCount",b("substitutionCount")),util.ifDef(this,a,"unsaturatedAtom",b("unsaturatedAtom")),util.ifDef(this,a,"hCount",b("hCount")),util.ifDef(this,a,"aam",b("aam")),util.ifDef(this,a,"invRet",b("invRet")),util.ifDef(this,a,"exactChangeFlag",b("exactChangeFlag")),util.ifDef(this,a,"rxnFragmentType",-1),this.atomList=util.isUndefined(a.atomList)||null==a.atomList?null:new chem.Struct.AtomList(a.atomList),this.neighbors=[],this.badConn=!1},chem.Struct.Atom.getAttrHash=function(a){var b=new Hash;for(var c in chem.Struct.Atom.attrlist)"undefined"!=typeof a[c]&&b.set(c,a[c]);return b},chem.Struct.Atom.attrGetDefault=function(a){if(a in chem.Struct.Atom.attrlist)return chem.Struct.Atom.attrlist[a];throw new Error("Attribute unknown")},chem.Struct.Atom.attrlist={label:"C",isotope:0,radical:0,charge:0,explicitValence:-1,ringBondCount:0,substitutionCount:0,unsaturatedAtom:0,hCount:0,atomList:null,invRet:0,exactChangeFlag:0,rglabel:null,attpnt:null,aam:0},chem.Struct.Atom.prototype.clone=function(a){var b=new chem.Struct.Atom(this);return a&&this.fragment in a&&(b.fragment=a[this.fragment]),b},chem.Struct.Atom.prototype.isQuery=function(){return null!=this.atomList||"A"==this.label||this.attpnt||this.hCount},chem.Struct.Atom.prototype.pureHydrogen=function(){return"H"==this.label&&0==this.isotope},chem.Struct.Atom.prototype.isPlainCarbon=function(){return"C"==this.label&&0==this.isotope&&0==this.radical&&0==this.charge&&this.explicitValence<0&&0==this.ringBondCount&&0==this.substitutionCount&&0==this.unsaturatedAtom&&0==this.hCount&&!this.atomList},chem.Struct.Atom.prototype.isPseudo=function(){return!this.atomList&&!this.rglabel&&!chem.Element.getElementByLabel(this.label)},chem.Struct.Atom.prototype.hasRxnProps=function(){return!(!this.invRet&&!this.exactChangeFlag&&util.isNull(this.attpnt)&&!this.aam)},chem.Struct.AtomList=function(a){if(!(a&&"notList"in a&&"ids"in a))throw new Error("'notList' and 'ids' must be specified!");this.notList=a.notList,this.ids=a.ids},chem.Struct.AtomList.prototype.labelList=function(){for(var a=[],b=0;b<this.ids.length;++b)a.push(chem.Element.elements.get(this.ids[b]).label);return a},chem.Struct.AtomList.prototype.label=function(){var a="["+this.labelList().join(",")+"]";return this.notList&&(a="!"+a),a},chem.Struct.AtomList.prototype.equals=function(a){return this.notList==a.notList&&(this.ids||[]).sort().toString()==(a.ids||[]).sort().toString()},chem.Struct.Bond=function(a){if(!(a&&"begin"in a&&"end"in a&&"type"in a))throw new Error("'begin', 'end' and 'type' properties must be specified!");this.begin=a.begin,this.end=a.end,this.type=a.type,util.ifDef(this,a,"stereo",chem.Struct.BOND.STEREO.NONE),util.ifDef(this,a,"topology",chem.Struct.BOND.TOPOLOGY.EITHER),util.ifDef(this,a,"reactingCenterStatus",0),this.hb1=null,this.hb2=null,this.len=0,this.center=new util.Vec2,this.sb=0,this.sa=0,this.angle=0},chem.Struct.Bond.attrlist={type:chem.Struct.BOND.TYPE.SINGLE,stereo:chem.Struct.BOND.STEREO.NONE,topology:chem.Struct.BOND.TOPOLOGY.EITHER,reactingCenterStatus:0},chem.Struct.Bond.getAttrHash=function(a){var b=new Hash;for(var c in chem.Struct.Bond.attrlist)"undefined"!=typeof a[c]&&b.set(c,a[c]);return b},chem.Struct.Bond.attrGetDefault=function(a){if(a in chem.Struct.Bond.attrlist)return chem.Struct.Bond.attrlist[a];throw new Error("Attribute unknown")},chem.Struct.Bond.prototype.hasRxnProps=function(){return!!this.reactingCenterStatus},chem.Struct.Bond.prototype.getCenter=function(a){var b=a.atoms.get(this.begin).pp,c=a.atoms.get(this.end).pp;return util.Vec2.lc2(b,.5,c,.5)},chem.Struct.Bond.prototype.getDir=function(a){var b=a.atoms.get(this.begin).pp,c=a.atoms.get(this.end).pp;return c.sub(b).normalized()},chem.Struct.Bond.prototype.clone=function(a){var b=new chem.Struct.Bond(this);return a&&(b.begin=a[b.begin],b.end=a[b.end]),b},chem.Struct.Bond.prototype.findOtherEnd=function(a){if(a==this.begin)return this.end;if(a==this.end)return this.begin;throw new Error("Bond end not found")},chem.HalfBond=function(a,b,c){if(3!=arguments.length)throw new Error("Invalid parameter number!");this.begin=a-0,this.end=b-0,this.bid=c-0,this.dir=new util.Vec2,this.norm=new util.Vec2,this.ang=0,this.p=new util.Vec2,this.loop=-1,this.contra=-1,this.next=-1,this.leftSin=0,this.leftCos=0,this.leftNeighbor=0,this.rightSin=0,this.rightCos=0,this.rightNeighbor=0},chem.Struct.prototype.initNeighbors=function(){this.atoms.each(function(a,b){b.neighbors=[]}),this.bonds.each(function(a,b){var c=this.atoms.get(b.begin),d=this.atoms.get(b.end);c.neighbors.push(b.hb1),d.neighbors.push(b.hb2)},this)},chem.Struct.prototype.bondInitHalfBonds=function(a,b){b=b||this.bonds.get(a),b.hb1=2*a,b.hb2=2*a+1,this.halfBonds.set(b.hb1,new chem.HalfBond(b.begin,b.end,a)),this.halfBonds.set(b.hb2,new chem.HalfBond(b.end,b.begin,a));var c=this.halfBonds.get(b.hb1),d=this.halfBonds.get(b.hb2);c.contra=b.hb2,d.contra=b.hb1},chem.Struct.prototype.halfBondUpdate=function(a){var b=this.halfBonds.get(a),c=this.atoms.get(b.begin).pp,d=this.atoms.get(b.end).pp,e=util.Vec2.diff(d,c).normalized();b.dir=util.Vec2.dist(d,c)>1e-4?e:new util.Vec2(1,0),b.norm=b.dir.turnLeft(),b.ang=b.dir.oxAngle(),b.loop<0&&(b.loop=-1)},chem.Struct.prototype.initHalfBonds=function(){this.halfBonds.clear(),this.bonds.each(this.bondInitHalfBonds,this)},chem.Struct.prototype.setHbNext=function(a,b){this.halfBonds.get(this.halfBonds.get(a).contra).next=b},chem.Struct.prototype.halfBondSetAngle=function(a,b){var c=this.halfBonds.get(a),d=this.halfBonds.get(b);d.rightCos=c.leftCos=util.Vec2.dot(d.dir,c.dir),d.rightSin=c.leftSin=util.Vec2.cross(d.dir,c.dir),c.leftNeighbor=b,d.rightNeighbor=a},chem.Struct.prototype.atomAddNeighbor=function(a){var b=this.halfBonds.get(a),c=this.atoms.get(b.begin),d=0;for(d=0;d<c.neighbors.length&&!(this.halfBonds.get(c.neighbors[d]).ang>b.ang);++d);c.neighbors.splice(d,0,a);var e=c.neighbors[(d+1)%c.neighbors.length],f=c.neighbors[(d+c.neighbors.length-1)%c.neighbors.length];this.setHbNext(f,a),this.setHbNext(a,e),this.halfBondSetAngle(a,f),this.halfBondSetAngle(e,a)},chem.Struct.prototype.atomSortNeighbors=function(a){var b=this.atoms.get(a),c=this;b.neighbors=b.neighbors.sort(function(a,b){return c.halfBonds.get(a).ang-c.halfBonds.get(b).ang},this);var d;for(d=0;d<b.neighbors.length;++d)this.halfBonds.get(this.halfBonds.get(b.neighbors[d]).contra).next=b.neighbors[(d+1)%b.neighbors.length];for(d=0;d<b.neighbors.length;++d)this.halfBondSetAngle(b.neighbors[(d+1)%b.neighbors.length],b.neighbors[d])},chem.Struct.prototype.sortNeighbors=function(a){util.each(a,function(a){this.atomSortNeighbors(a)},this)},chem.Struct.prototype.atomUpdateHalfBonds=function(a){for(var b=this.atoms.get(a).neighbors,c=0;c<b.length;++c){var d=b[c];this.halfBondUpdate(d),this.halfBondUpdate(this.halfBonds.get(d).contra)}},chem.Struct.prototype.updateHalfBonds=function(a){util.each(a,function(a){this.atomUpdateHalfBonds(a)},this)},chem.Struct.prototype.sGroupsRecalcCrossBonds=function(){this.sgroups.each(function(a,b){b.xBonds=[],b.neiAtoms=[]},this),this.bonds.each(function(a,b){var c=this.atoms.get(b.begin),d=this.atoms.get(b.end);util.Set.each(c.sgs,function(c){if(!util.Set.contains(d.sgs,c)){var e=this.sgroups.get(c);e.xBonds.push(a),util.arrayAddIfMissing(e.neiAtoms,b.end)}},this),util.Set.each(d.sgs,function(d){if(!util.Set.contains(c.sgs,d)){var e=this.sgroups.get(d);e.xBonds.push(a),util.arrayAddIfMissing(e.neiAtoms,b.begin)}},this)},this)},chem.Struct.prototype.sGroupDelete=function(a){for(var b=this.sgroups.get(a),c=0;c<b.atoms.length;++c)util.Set.remove(this.atoms.get(b.atoms[c]).sgs,a);this.sGroupForest.remove(a),this.sgroups.remove(a)},chem.Struct.itemSetPos=function(a,b){a.pp=b},chem.Struct.prototype._itemSetPos=function(a,b,c,d){chem.Struct.itemSetPos(this[a].get(b),c,d)},chem.Struct.prototype._atomSetPos=function(a,b,c){this._itemSetPos("atoms",a,b,c)},chem.Struct.prototype._rxnPlusSetPos=function(a,b,c){this._itemSetPos("rxnPluses",a,b,c)},chem.Struct.prototype._rxnArrowSetPos=function(a,b,c){this._itemSetPos("rxnArrows",a,b,c)},chem.Struct.prototype.getCoordBoundingBox=function(a){var b=null,c=function(a){b?(b.min=util.Vec2.min(b.min,a),b.max=util.Vec2.max(b.max,a)):b={min:a,max:a}},d="undefined"==typeof a;return this.atoms.each(function(b,e){(d||util.Set.contains(a,b))&&c(e.pp)}),d&&(this.rxnPluses.each(function(a,b){c(b.pp)}),this.rxnArrows.each(function(a,b){c(b.pp)})),!b&&d&&(b={min:new util.Vec2(0,0),max:new util.Vec2(1,1)}),b},chem.Struct.prototype.getCoordBoundingBoxObj=function(){var a=null,b=function(b){a?(a.min=util.Vec2.min(a.min,b),a.max=util.Vec2.max(a.max,b)):a={min:new util.Vec2(b),max:new util.Vec2(b)}};return this.atoms.each(function(a,c){b(c.pp)}),a},chem.Struct.prototype.getBondLengthData=function(){var a=0,b=0;return this.bonds.each(function(c,d){a+=util.Vec2.dist(this.atoms.get(d.begin).pp,this.atoms.get(d.end).pp),b++},this),{cnt:b,totalLength:a}},chem.Struct.prototype.getAvgBondLength=function(){var a=this.getBondLengthData();return a.cnt>0?a.totalLength/a.cnt:-1},chem.Struct.prototype.getAvgClosestAtomDistance=function(){var a,b,c,d=0,e=0,f=this.atoms.keys();for(b=0;b<f.length;++b){for(a=-1,c=0;c<f.length;++c)c!=b&&(e=util.Vec2.dist(this.atoms.get(f[c]).pp,this.atoms.get(f[b]).pp),(0>a||a>e)&&(a=e));d+=a}return f.length>0?d/f.length:-1},chem.Struct.prototype.checkBondExists=function(a,b){var c=!1;return this.bonds.each(function(d,e){(e.begin==a&&e.end==b||e.end==a&&e.begin==b)&&(c=!0)},this),c},chem.Loop=function(a,b,c){this.hbs=a,this.dblBonds=0,this.aromatic=!0,this.convex=c||!1,util.each(a,function(a){var c=b.bonds.get(b.halfBonds.get(a).bid);c.type!=chem.Struct.BOND.TYPE.AROMATIC&&(this.aromatic=!1),c.type==chem.Struct.BOND.TYPE.DOUBLE&&this.dblBonds++},this)},chem.Struct.RxnPlus=function(a){a=a||{},this.pp=a.pp?new util.Vec2(a.pp):new util.Vec2},chem.Struct.RxnPlus.prototype.clone=function(){return new chem.Struct.RxnPlus(this)},chem.Struct.RxnArrow=function(a){a=a||{},this.pp=a.pp?new util.Vec2(a.pp):new util.Vec2},chem.Struct.RxnArrow.prototype.clone=function(){return new chem.Struct.RxnArrow(this)},chem.Struct.prototype.findConnectedComponent=function(a){for(var b={},c=[a],d=util.Set.empty();c.length>0;)(function(){var a=c.pop();b[a]=1,util.Set.add(d,a);for(var e=this.atoms.get(a),f=0;f<e.neighbors.length;++f){var g=this.halfBonds.get(e.neighbors[f]).end;util.Set.contains(d,g)||c.push(g)}}).apply(this);return d},chem.Struct.prototype.findConnectedComponents=function(a){this.halfBonds.count()||(this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()));var b={};this.atoms.each(function(a,c){b[a]=-1},this);var c=[];return this.atoms.each(function(d,e){if((a||e.fragment<0)&&b[d]<0){var f=this.findConnectedComponent(d);c.push(f),util.Set.each(f,function(a){b[a]=1},this)}},this),c},chem.Struct.prototype.markFragment=function(a){var b=this.frags.add(new chem.Struct.Fragment);util.Set.each(a,function(a){this.atoms.get(a).fragment=b},this)},chem.Struct.prototype.markFragmentByAtomId=function(a){this.markFragment(this.findConnectedComponent(a))},chem.Struct.prototype.markFragments=function(){for(var a=this.findConnectedComponents(),b=0;b<a.length;++b)this.markFragment(a[b])},chem.Struct.Fragment=function(){},chem.Struct.Fragment.prototype.clone=function(){return new chem.Struct.Fragment},chem.Struct.Fragment.getAtoms=function(a,b){var c=[];return a.atoms.each(function(a,d){d.fragment==b&&c.push(a)},this),c},chem.Struct.RGroup=function(a){a=a||{},this.frags=new util.Pool,this.resth=a.resth||!1,this.range=a.range||"",this.ifthen=a.ifthen||0},chem.Struct.RGroup.prototype.getAttrs=function(){return{resth:this.resth,range:this.range,ifthen:this.ifthen}},chem.Struct.RGroup.findRGroupByFragment=function(a,b){var c;return a.each(function(a,d){util.isUndefined(d.frags.keyOf(b))||(c=a)}),c},chem.Struct.RGroup.prototype.clone=function(a){var b=new chem.Struct.RGroup(this);return this.frags.each(function(c,d){b.frags.add(a?a[d]:d)}),b},chem.Struct.prototype.scale=function(a){1!=a&&(this.atoms.each(function(b,c){c.pp=c.pp.scaled(a)},this),this.rxnPluses.each(function(b,c){c.pp=c.pp.scaled(a)},this),this.rxnArrows.each(function(b,c){c.pp=c.pp.scaled(a)},this),this.sgroups.each(function(b,c){c.pp=c.pp?c.pp.scaled(a):null},this))},chem.Struct.prototype.rescale=function(){var a=this.getAvgBondLength();0>a&&!this.isReaction&&(a=this.getAvgClosestAtomDistance()),.001>a&&(a=1);var b=1/a;this.scale(b)},chem.Struct.prototype.loopHasSelfIntersections=function(a){for(var b=0;b<a.length;++b)for(var c=this.halfBonds.get(a[b]),d=this.atoms.get(c.begin).pp,e=this.atoms.get(c.end).pp,f=util.Set.fromList([c.begin,c.end]),g=b+2;g<a.length;++g){var h=this.halfBonds.get(a[g]);if(!util.Set.contains(f,h.begin)&&!util.Set.contains(f,h.end)){var i=this.atoms.get(h.begin).pp,j=this.atoms.get(h.end).pp;if(util.Vec2.segmentIntersection(d,e,i,j))return!0}}return!1},chem.Struct.prototype.partitionLoop=function(a){var b=[],c=!0;a:for(;c;){for(var d={},e=0;e<a.length;++e){var f=a[e],g=this.halfBonds.get(f).begin,h=this.halfBonds.get(f).end;if(h in d){var i=d[h],j=a.slice(i,e+1);b.push(j),e<a.length&&a.splice(i,e-i+1);continue a}d[g]=e}c=!1,b.push(a)}return b},chem.Struct.prototype.halfBondAngle=function(a,b){var c=this.halfBonds.get(a),d=this.halfBonds.get(b);return Math.atan2(util.Vec2.cross(c.dir,d.dir),util.Vec2.dot(c.dir,d.dir))},chem.Struct.prototype.loopIsConvex=function(a){for(var b=0;b<a.length;++b){var c=this.halfBondAngle(a[b],a[(b+1)%a.length]);if(c>0)return!1}return!0},chem.Struct.prototype.loopIsInner=function(a){for(var b=2*Math.PI,c=0;c<a.length;++c){var d=a[c],e=a[(c+1)%a.length],f=this.halfBonds.get(e),g=this.halfBondAngle(d,e);b+=f.contra==a[c]?Math.PI:g}return Math.abs(b)<Math.PI},chem.Struct.prototype.findLoops=function(){var a,b,c,d,e=[],f=util.Set.empty();return this.halfBonds.each(function(g,h){if(-1==h.loop)for(a=g,b=0,c=[];b<=this.halfBonds.count();a=this.halfBonds.get(a).next,++b){if(b>0&&a==g){var i=this.partitionLoop(c);util.each(i,function(a){this.loopIsInner(a)&&!this.loopHasSelfIntersections(a)?(d=util.arrayMin(a),this.loops.set(d,new chem.Loop(a,this,this.loopIsConvex(a)))):d=-2,util.each(a,function(a){this.halfBonds.get(a).loop=d,util.Set.add(f,this.halfBonds.get(a).bid)},this),d>=0&&e.push(d)},this);break}c.push(a)}},this),{newLoops:e,bondsToMark:util.Set.list(f)}},chem.Struct.prototype.prepareLoopStructure=function(){this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()),this.findLoops()},chem.Struct.prototype.atomAddToSGroup=function(a,b){chem.SGroup.addAtom(this.sgroups.get(a),b),util.Set.add(this.atoms.get(b).sgs,a)},!window.chem||!util.Vec2||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if("undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")}),isUndefined=function(a){return util.isUndefined(a)},chem.Molfile=function(){},chem.Molfile.loadRGroupFragments=!0,chem.Molfile.parseDecimalInt=function(a){var b=parseInt(a,10);return isNaN(b)?0:b},chem.Molfile.partitionLine=function(a,b,c){for(var d=[],e=0,f=0;e<b.length;++e)d.push(a.slice(f,f+b[e])),c&&f++,f+=b[e];return d},chem.Molfile.partitionLineFixed=function(a,b,c){for(var d=[],e=0;e<a.length;e+=b)d.push(a.slice(e,e+b)),c&&e++;return d},chem.Molfile.parseCTFile=function(a){var b=null;return b=0==a[0].search("\\$RXN")?chem.Molfile.parseRxn(a):chem.Molfile.parseMol(a),b.initHalfBonds(),b.initNeighbors(),b.markFragments(),b},chem.Molfile.fmtInfo={bondTypeMap:{1:chem.Struct.BOND.TYPE.SINGLE,2:chem.Struct.BOND.TYPE.DOUBLE,3:chem.Struct.BOND.TYPE.TRIPLE,4:chem.Struct.BOND.TYPE.AROMATIC,5:chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE,6:chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC,7:chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC,8:chem.Struct.BOND.TYPE.ANY},bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,4:chem.Struct.BOND.STEREO.EITHER,6:chem.Struct.BOND.STEREO.DOWN,3:chem.Struct.BOND.STEREO.CIS_TRANS},v30bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,2:chem.Struct.BOND.STEREO.EITHER,3:chem.Struct.BOND.STEREO.DOWN},bondTopologyMap:{0:chem.Struct.BOND.TOPOLOGY.EITHER,1:chem.Struct.BOND.TOPOLOGY.RING,2:chem.Struct.BOND.TOPOLOGY.CHAIN},countsLinePartition:[3,3,3,3,3,3,3,3,3,3,3,6],atomLinePartition:[10,10,10,1,3,2,3,3,3,3,3,3,3,3,3,3,3],bondLinePartition:[3,3,3,3,3,3,3],atomListHeaderPartition:[3,1,1,4,1,1],atomListHeaderLength:11,atomListHeaderItemLength:4,chargeMap:[0,3,2,1,0,-1,-2,-3],valenceMap:[void 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,0],implicitHydrogenMap:[void 0,0,1,2,3,4],v30atomPropMap:{CHG:"charge",RAD:"radical",MASS:"isotope",VAL:"explicitValence",HCOUNT:"hCount",INVRET:"invRet",SUBST:"substitutionCount",UNSAT:"unsaturatedAtom",RBCNT:"ringBondCount"},rxnItemsPartition:[3,3,3]},chem.Molfile.parseAtomLine=function(a){var b=chem.Molfile,c=b.partitionLine(a,b.fmtInfo.atomLinePartition),d={pp:new util.Vec2(parseFloat(c[0]),-parseFloat(c[1])),label:c[4].trim(),explicitValence:b.fmtInfo.valenceMap[b.parseDecimalInt(c[10])],massDifference:b.parseDecimalInt(c[5]),charge:b.fmtInfo.chargeMap[b.parseDecimalInt(c[6])],hCount:b.parseDecimalInt(b.parseDecimalInt(c[8])),stereoCare:0!=b.parseDecimalInt(c[9]),aam:b.parseDecimalInt(c[14]),invRet:b.parseDecimalInt(c[15]),exactChangeFlag:0!=b.parseDecimalInt(c[16])};return new chem.Struct.Atom(d)},chem.Molfile.stripV30=function(a){if("M  V30 "!=a.slice(0,7))throw Error("Prefix invalid");return a.slice(7)},chem.Molfile.parseAtomLineV3000=function(a){var b,c,d,e,f,g=chem.Molfile;b=g.spaceparsplit(a);var h={pp:new util.Vec2(parseFloat(b[2]),-parseFloat(b[3])),aam:b[5].trim()},i=b[1].trim();if('"'==i.charAt(0)&&'"'==i.charAt(i.length-1)&&(i=i.substr(1,i.length-2)),"]"==i.charAt(i.length-1)){i=i.substr(0,i.length-1);var j={};if(j.notList=!1,"NOT ["==i.substr(0,5))j.notList=!0,i=i.substr(5);else{if("["!=i.charAt(0))throw new Error("Error: atom list expected, found '"+i+"'");i=i.substr(1)}j.ids=g.labelsListToIds(i.split(",")),h.atomList=new chem.Struct.AtomList(j),h.label="L#"}else h.label=i;for(b.splice(0,6),f=0;f<b.length;++f)if(c=g.splitonce(b[f],"="),d=c[0],e=c[1],d in g.fmtInfo.v30atomPropMap){var k=g.parseDecimalInt(e);if("VAL"==d){if(0==k)continue;-1==k&&(k=0)}h[g.fmtInfo.v30atomPropMap[d]]=k}else if("RGROUPS"==d){e=e.trim().substr(1,e.length-2);var l=e.split(" ").slice(1);h.rglabel=0;for(var m=0;m<l.length;++m)h.rglabel|=1<<l[m]-1}else"ATTCHPT"==d&&(h.attpnt=e.trim()-0);return new chem.Struct.Atom(h)},chem.Molfile.parseBondLineV3000=function(a){var b,c,d,e,f,g=chem.Molfile;b=g.spaceparsplit(a);var h={begin:g.parseDecimalInt(b[2])-1,end:g.parseDecimalInt(b[3])-1,type:g.fmtInfo.bondTypeMap[g.parseDecimalInt(b[1])]};for(b.splice(0,4),f=0;f<b.length;++f)c=g.splitonce(b[f],"="),d=c[0],e=c[1],"CFG"==d?(h.stereo=g.fmtInfo.v30bondStereoMap[g.parseDecimalInt(e)],h.type==chem.Struct.BOND.TYPE.DOUBLE&&h.stereo==chem.Struct.BOND.STEREO.EITHER&&(h.stereo=chem.Struct.BOND.STEREO.CIS_TRANS)):"TOPO"==d?h.topology=g.fmtInfo.bondTopologyMap[g.parseDecimalInt(e)]:"RXCTR"==d?h.reactingCenterStatus=g.parseDecimalInt(e):"STBOX"==d&&(h.stereoCare=g.parseDecimalInt(e));return new chem.Struct.Bond(h)},chem.Molfile.parseBondLine=function(a){var b=chem.Molfile,c=b.partitionLine(a,b.fmtInfo.bondLinePartition),d={begin:b.parseDecimalInt(c[0])-1,end:b.parseDecimalInt(c[1])-1,type:b.fmtInfo.bondTypeMap[b.parseDecimalInt(c[2])],stereo:b.fmtInfo.bondStereoMap[b.parseDecimalInt(c[3])],topology:b.fmtInfo.bondTopologyMap[b.parseDecimalInt(c[5])],reactingCenterStatus:b.parseDecimalInt(c[6])};return new chem.Struct.Bond(d)},chem.Molfile.parseAtomListLine=function(a){for(var b=chem.Molfile,c=b.partitionLine(a,b.fmtInfo.atomListHeaderPartition),d=b.parseDecimalInt(c[0])-1,e="T"==c[2].trim(),f=b.parseDecimalInt(c[4].trim()),g=a.slice(b.fmtInfo.atomListHeaderLength),h=[],i=b.fmtInfo.atomListHeaderItemLength,j=0;f>j;++j)h[j]=b.parseDecimalInt(g.slice(j*i,(j+1)*i-1));return{aid:d,atomList:new chem.Struct.AtomList({notList:e,ids:h})}},chem.Molfile.readKeyValuePairs=function(a,b){for(var c=chem.Molfile,d={},e=c.partitionLineFixed(a,3,!0),f=c.parseDecimalInt(e[0]),g=0;f>g;++g)d[c.parseDecimalInt(e[2*g+1])-1]=b?e[2*g+2].trim():c.parseDecimalInt(e[2*g+2]);return d},chem.Molfile.readKeyMultiValuePairs=function(a,b){for(var c=chem.Molfile,d=[],e=c.partitionLineFixed(a,3,!0),f=c.parseDecimalInt(e[0]),g=0;f>g;++g)d.push([c.parseDecimalInt(e[2*g+1])-1,b?e[2*g+2].trim():c.parseDecimalInt(e[2*g+2])]);return d},chem.Molfile.labelsListToIds=function(a){for(var b=[],c=0;c<a.length;++c)b.push(chem.Element.getElementByLabel(a[c].trim()));return b},chem.Molfile.parsePropertyLineAtomList=function(a,b){var c=chem.Molfile,d=c.parseDecimalInt(a[1])-1,e=c.parseDecimalInt(a[2]),f="T"==a[4].trim(),g=c.labelsListToIds(b.slice(0,e)),h={};return h[d]=new chem.Struct.AtomList({notList:f,ids:g}),h},chem.Molfile.initSGroup=function(a,b){var c=chem.Molfile,d=c.readKeyValuePairs(b,!0);for(var e in d){var f=d[e];if(!(f in chem.SGroup.TYPES))throw new Error("Unsupported S-group type");var g=new chem.SGroup(f);g.number=e,a[e]=g}},chem.Molfile.applySGroupProp=function(a,b,c,d,e){var f=chem.Molfile,g=f.readKeyValuePairs(c,!d);for(var h in g)(e?a[h]:a[h].data)[b]=g[h]},chem.Molfile.toIntArray=function(a){for(var b=chem.Molfile,c=[],d=0;d<a.length;++d)c[d]=b.parseDecimalInt(a[d]);return c},chem.Molfile.applySGroupArrayProp=function(a,b,c,d){var e=chem.Molfile,f=e.parseDecimalInt(c.slice(1,4))-1,g=e.parseDecimalInt(c.slice(4,8)),h=e.toIntArray(e.partitionLineFixed(c.slice(8),3,!0));if(h.length!=g)throw new Error("File format invalid");d&&util.apply(h,function(a){return a+d}),a[f][b]=a[f][b].concat(h)},chem.Molfile.applyDataSGroupName=function(a,b){a.data.fieldName=b},chem.Molfile.applyDataSGroupQuery=function(a,b){a.data.query=b},chem.Molfile.applyDataSGroupQueryOp=function(a,b){a.data.queryOp=b},chem.Molfile.applyDataSGroupDesc=function(a,b){var c=chem.Molfile,d=c.partitionLine(b,[4,31,2,20,2,3],!1),e=c.parseDecimalInt(d[0])-1,f=d[1].trim(),g=d[2].trim(),h=d[3].trim(),i=d[4].trim(),j=d[5].trim(),k=a[e];k.data.fieldType=g,k.data.fieldName=f,k.data.units=h,k.data.query=i,k.data.queryOp=j},chem.Molfile.applyDataSGroupInfo=function(a,b){var c=chem.Molfile,d=c.partitionLine(b,[10,10,4,1,1,1,3,3,3,3,2,3,2],!1),e=parseFloat(d[0]),f=parseFloat(d[1]),g="A"==d[3].trim(),h="A"==d[4].trim(),i="U"==d[5].trim(),j=d[7].trim();j="ALL"==j?-1:c.parseDecimalInt(j);var k=d[10].trim(),l=c.parseDecimalInt(d[11].trim());a.pp=new util.Vec2(e,-f),a.data.attached=g,a.data.absolute=h,a.data.showUnits=i,a.data.nCharsToDisplay=j,a.data.tagChar=k,a.data.daspPos=l},chem.Molfile.applyDataSGroupInfoLine=function(a,b){var c=chem.Molfile,d=c.parseDecimalInt(b.substr(0,4))-1,e=a[d];c.applyDataSGroupInfo(e,b.substr(5))},chem.Molfile.applyDataSGroupData=function(a,b,c){a.data.fieldValue=(a.data.fieldValue||"")+b,c&&(a.data.fieldValue=util.stripRight(a.data.fieldValue),a.data.fieldValue.startsWith('"')&&a.data.fieldValue.endsWith('"')&&(a.data.fieldValue=a.data.fieldValue.substr(1,a.data.fieldValue.length-2)),a.data.fieldValue+="\n")},chem.Molfile.applyDataSGroupDataLine=function(a,b,c){var d=chem.Molfile,e=d.parseDecimalInt(b.substr(0,5))-1,f=b.substr(5),g=a[e];d.applyDataSGroupData(g,f,c)},chem.Molfile.parsePropertyLines=function(a,b,c,d,e,f){for(var g=chem.Molfile,h=new util.Map;d>c;){var i=b[c];if("A"==i.charAt(0))h.get("label")||h.set("label",new util.Map),h.get("label").set(g.parseDecimalInt(i.slice(3,6))-1,b[++c]);else if("M"==i.charAt(0)){var j=i.slice(3,6),k=i.slice(6);if("END"==j)break;if("CHG"==j)h.get("charge")||h.set("charge",new util.Map),h.get("charge").update(g.readKeyValuePairs(k));else if("RAD"==j)h.get("radical")||h.set("radical",new util.Map),h.get("radical").update(g.readKeyValuePairs(k));else if("ISO"==j)h.get("isotope")||h.set("isotope",new util.Map),h.get("isotope").update(g.readKeyValuePairs(k));else if("RBC"==j)h.get("ringBondCount")||h.set("ringBondCount",new util.Map),h.get("ringBondCount").update(g.readKeyValuePairs(k));else if("SUB"==j)h.get("substitutionCount")||h.set("substitutionCount",new util.Map),h.get("substitutionCount").update(g.readKeyValuePairs(k));else if("UNS"==j)h.get("unsaturatedAtom")||h.set("unsaturatedAtom",new util.Map),h.get("unsaturatedAtom").update(g.readKeyValuePairs(k));else if("RGP"==j){h.get("rglabel")||h.set("rglabel",new util.Map);for(var l=h.get("rglabel"),m=g.readKeyMultiValuePairs(k),n=0;n<m.length;n++){var o=m[n];l.set(o[0],(l.get(o[0])||0)|1<<o[1]-1)}}else if("LOG"==j){k=k.slice(4);var p=g.parseDecimalInt(k.slice(0,3).trim()),q=g.parseDecimalInt(k.slice(4,7).trim()),r=g.parseDecimalInt(k.slice(8,11).trim()),s=k.slice(12).trim(),t={};q>0&&(t.ifthen=q),t.resth=1==r,t.range=s,f[p]=t}else if("APO"==j)h.get("attpnt")||h.set("attpnt",new util.Map),h.get("attpnt").update(g.readKeyValuePairs(k));else if("ALS"==j){h.get("atomList")||h.set("atomList",new util.Map);var u=g.parsePropertyLineAtomList(g.partitionLine(k,[1,3,3,1,1,1]),g.partitionLineFixed(k.slice(10),4,!1));h.get("atomList").update(u),h.get("label")||h.set("label",new util.Map);for(var v in u)h.get("label").set(v,"L#")}else if("STY"==j)g.initSGroup(e,k);else if("SST"==j)g.applySGroupProp(e,"subtype",k);else if("SLB"==j)g.applySGroupProp(e,"label",k,!0);else if("SPL"==j)g.applySGroupProp(e,"parent",k,!0,!0);else if("SCN"==j)g.applySGroupProp(e,"connectivity",k);else if("SAL"==j)g.applySGroupArrayProp(e,"atoms",k,-1);else if("SBL"==j)g.applySGroupArrayProp(e,"bonds",k,-1);else if("SPA"==j)g.applySGroupArrayProp(e,"patoms",k,-1);else if("SMT"==j){var w=g.parseDecimalInt(k.slice(0,4))-1;e[w].data.subscript=k.slice(4).trim()}else"SDT"==j?g.applyDataSGroupDesc(e,k):"SDD"==j?g.applyDataSGroupInfoLine(e,k):"SCD"==j?g.applyDataSGroupDataLine(e,k,!1):"SED"==j&&g.applyDataSGroupDataLine(e,k,!0)}++c}return h},chem.Molfile.applyAtomProp=function(a,b,c,d){b.each(function(b,d){a.get(b)[c]=d})},chem.Molfile.parseCTabV2000=function(a,b){var c,d=new chem.Struct,e=chem.Molfile,f=e.parseDecimalInt(b[0]),g=e.parseDecimalInt(b[1]),h=e.parseDecimalInt(b[2]);d.isChiral=0!=e.parseDecimalInt(b[4]);var i=e.parseDecimalInt(b[5]),j=e.parseDecimalInt(b[10]),k=0,l=a.slice(k,k+f);k+=f;var m=a.slice(k,k+g);k+=g;var n=a.slice(k,k+h);k+=h+i;var o=l.map(e.parseAtomLine);for(c=0;c<o.length;++c)d.atoms.add(o[c]);var p=m.map(e.parseBondLine);for(c=0;c<p.length;++c)d.bonds.add(p[c]);var q=n.map(e.parseAtomListLine);util.each(q,function(a){d.atoms.get(a.aid).atomList=a.atomList,d.atoms.get(a.aid).label="L#"});var r={},s={},t=e.parsePropertyLines(d,a,k,Math.min(a.length,k+j),r,s);t.each(function(a,b){e.applyAtomProp(d.atoms,b,a)});var u,v={};for(u in r){var w=r[u];if("DAT"===w.type&&0===w.atoms.length){var x=r[u].parent;if(x>=0){var y=r[x-1];"GEN"===y.type&&(w.atoms=util.array(y.atoms))}}}for(u in r)chem.SGroup.addGroup(d,r[u],v);var z=[];for(u in r)chem.SGroup.filter(d,r[u],v),0!=r[u].atoms.length||r[u].allAtoms||z.push(u);for(c=0;c<z.length;++c)d.sGroupForest.remove(z[c]),d.sgroups.remove(z[c]);for(var A in s)d.rgroups.set(A,new chem.Struct.RGroup(s[A]));return d},chem.Molfile.spaceparsplit=function(a){var b,c,d=[],e=0,f=-1,g=a.toArray(),h=!1;for(c=0;c<a.length;++c)b=g[c],"("==b?e++:")"==b&&e--,'"'==b&&(h=!h),h||" "!=g[c]||0!=e||(c>f+1&&d.push(a.slice(f+1,c)),f=c);return c>f+1&&d.push(a.slice(f+1,c)),f=c,d},chem.Molfile.splitonce=function(a,b){var c=a.indexOf(b);return[a.slice(0,c),a.slice(c+1)]},chem.Molfile.splitSGroupDef=function(a){for(var b=[],c=0,d=!1,e=0;e<a.length;++e){var f=a.charAt(e);'"'==f?d=!d:d||("("==f?c++:")"==f?c--:" "==f&&0==c&&(b.push(a.slice(0,e)),a=a.slice(e+1).trim(),e=0))}if(0!=c)throw new Error("Brace balance broken. S-group properies invalid!");return a.length>0&&b.push(a.trim()),b},chem.Molfile.parseBracedNumberList=function(a,b){if(!a)return null;var c=[];a=a.trim(),a=a.substr(1,a.length-2);var d=a.split(" ");b=b||0;for(var e=1;e<d.length;++e)c.push(d[e]-0+b);return c},chem.Molfile.v3000parseCollection=function(a,b,c){for(c++;"M  V30 END COLLECTION"!=b[c].trim();)c++;return c++,c},chem.Molfile.v3000parseSGroup=function(a,b,c,d,e){var f=chem.Molfile,g="";for(e++;e<b.length;){if(g=f.stripV30(b[e++]).trim(),"END SGROUP"==g.trim())return e;for(;"-"==g.charAt(g.length-1);)g=(g.substr(0,g.length-1)+f.stripV30(b[e++])).trim();var h=f.splitSGroupDef(g),i=h[1],j=new chem.SGroup(i);j.number=h[0]-0,j.type=i,j.label=h[2]-0,c[j.number]=j;for(var k={},l=3;l<h.length;++l){var m=f.splitonce(h[l],"=");if(2!=m.length)throw new Error("A record of form AAA=BBB or AAA=(...) expected, got '"+h[l]+"'");var n=m[0];n in k||(k[n]=[]),k[n].push(m[1])}j.atoms=f.parseBracedNumberList(k.ATOMS[0],-1),k.PATOMS&&(j.patoms=f.parseBracedNumberList(k.PATOMS[0],-1)),j.bonds=k.BONDS?f.parseBracedNumberList(k.BONDS[0],-1):[];var o=k.BRKXYZ;if(j.brkxyz=[],o)for(var p=0;p<o.length;++p)j.brkxyz.push(f.parseBracedNumberList(o[p]));k.MULT&&(j.data.subscript=k.MULT[0]-0),k.LABEL&&(j.data.subscript=k.LABEL[0].trim()),k.CONNECT&&(j.data.connectivity=k.CONNECT[0].toLowerCase()),k.FIELDDISP&&f.applyDataSGroupInfo(j,util.stripQuotes(k.FIELDDISP[0])),k.FIELDDATA&&f.applyDataSGroupData(j,k.FIELDDATA[0],!0),k.FIELDNAME&&f.applyDataSGroupName(j,k.FIELDNAME[0]),k.QUERYTYPE&&f.applyDataSGroupQuery(j,k.QUERYTYPE[0]),k.QUERYOP&&f.applyDataSGroupQueryOp(j,k.QUERYOP[0]),chem.SGroup.addGroup(a,j,d)}throw new Error("S-group declaration incomplete.")},chem.Molfile.parseCTabV3000=function(a,b){var c=new chem.Struct,d=chem.Molfile,e=0;if("M  V30 BEGIN CTAB"!=a[e++].trim())throw Error("CTAB V3000 invalid");if("M  V30 COUNTS"!=a[e].slice(0,13))throw Error("CTAB V3000 invalid");var f=a[e].slice(14).split(" ");if(c.isChiral=1==d.parseDecimalInt(f[4]),e++,"M  V30 BEGIN ATOM"==a[e].trim()){e++;for(var g;e<a.length&&(g=d.stripV30(a[e++]).trim(),"END ATOM"!=g);){for(;"-"==g.charAt(g.length-1);)g=(g.substring(0,g.length-1)+d.stripV30(a[e++])).trim();c.atoms.add(d.parseAtomLineV3000(g))}if("M  V30 BEGIN BOND"==a[e].trim())for(e++;e<a.length&&(g=d.stripV30(a[e++]).trim(),"END BOND"!=g);){for(;"-"==g.charAt(g.length-1);)g=(g.substring(0,g.length-1)+d.stripV30(a[e++])).trim();c.bonds.add(d.parseBondLineV3000(g))}for(var h={},i={};"M  V30 END CTAB"!=a[e].trim();)if("M  V30 BEGIN COLLECTION"==a[e].trim())e=d.v3000parseCollection(c,a,e);else{if("M  V30 BEGIN SGROUP"!=a[e].trim())throw Error("CTAB V3000 invalid");e=d.v3000parseSGroup(c,a,h,i,e)}}if("M  V30 END CTAB"!=a[e++].trim())throw Error("CTAB V3000 invalid");return b||d.readRGroups3000(c,a.slice(e)),c},chem.Molfile.readRGroups3000=function(a,b){
for(var c={},d={},e=0,f=chem.Molfile;e<b.length&&0==b[e].search("M  V30 BEGIN RGROUP");){var g=b[e++].split(" ").pop();for(c[g]=[],d[g]={};;){var h=b[e].trim();if(0!=h.search("M  V30 RLOGIC")){if("M  V30 BEGIN CTAB"!=h)throw Error("CTAB V3000 invalid");for(var i=0;i<b.length&&"M  V30 END CTAB"!=b[e+i].trim();++i);var j=b.slice(e,e+i+1),k=this.parseCTabV3000(j,!0);if(c[g].push(k),e=e+i+1,"M  V30 END RGROUP"==b[e].trim()){e++;break}}else{h=h.slice(13);var l=h.trim().split(/\s+/g),m=f.parseDecimalInt(l[0]),n=f.parseDecimalInt(l[1]),o=l.slice(2).join(" "),p={};m>0&&(p.ifthen=m),p.resth=1==n,p.range=o,d[g]=p,e++}}}for(var q in c)for(var r=0;r<c[q].length;++r){var s=c[q][r];s.rgroups.set(q,new chem.Struct.RGroup(d[q]));var t=s.frags.add(new chem.Struct.Fragment);s.rgroups.get(q).frags.add(t),s.atoms.each(function(a,b){b.fragment=t}),s.mergeInto(a)}},chem.Molfile.parseMol=function(a){if(0==a[0].search("\\$MDL"))return this.parseRg2000(a);var b=this.parseCTab(a.slice(3));return b.name=a[0].trim(),b},chem.Molfile.parseCTab=function(a){var b=chem.Molfile,c=b.partitionLine(a[0],b.fmtInfo.countsLinePartition),d=c[11].trim();if(a=a.slice(1),"V2000"==d)return this.parseCTabV2000(a,c);if("V3000"==d)return this.parseCTabV3000(a,!chem.Molfile.loadRGroupFragments);throw Error("Molfile version unknown: "+d)},chem.MolfileSaver=function(a){this.molecule=null,this.molfile=null,this.v3000=a||!1},chem.MolfileSaver.prototype.prepareSGroups=function(a){var b=this.molecule,c=(b.sgroups,[]);if(util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(d){var e=b.sgroups.get(d);try{e.prepareForSaving(b)}catch(f){if(ui.forwardExceptions)throw f;if(!a||"number"!=typeof f.id)throw f;c.push(f.id)}},this),c.length>0)throw new Error(c.length.toString()+" invalid S-groups were detected. They will be omitted.");for(var d=0;d<c.length;++d)b.sGroupDelete(c[d]);return b},chem.MolfileSaver.getComponents=function(a){var b=a.findConnectedComponents(!0),c=[],d=null;a.rxnArrows.each(function(a,b){d=b.pp.x}),a.rxnPluses.each(function(a,b){c.push(b.pp.x)}),null!=d&&c.push(d),c.sort(function(a,b){return a-b});var e,f=[];for(e=0;e<b.length;++e){for(var g=a.getCoordBoundingBox(b[e]),h=util.Vec2.lc2(g.min,.5,g.max,.5),i=0;h.x>c[i];)++i;f[i]=f[i]||{},util.Set.mergeIn(f[i],b[e])}var j=[],k=[],l=[];for(e=0;e<f.length;++e)f[e]?(g=a.getCoordBoundingBox(f[e]),h=util.Vec2.lc2(g.min,.5,g.max,.5),h.x<d?k.push(f[e]):l.push(f[e])):j.push("");return{reactants:k,products:l}},chem.MolfileSaver.prototype.getCTab=function(a,b){return this.molecule=a.clone(),this.molfile="",this.writeCTab2000(b),this.molfile},chem.MolfileSaver.prototype.saveMolecule=function(a,b,c){if(this.reaction=a.rxnArrows.count()>0,a.rxnArrows.count()>1)throw new Error("Reaction may not contain more than one arrow");if(this.molfile="",this.reaction){if(a.rgroups.count()>0)throw new Error("Unable to save the structure - reactions with r-groups are not supported at the moment");var d=chem.MolfileSaver.getComponents(a),e=d.reactants,f=d.products,g=e.concat(f);this.molfile="$RXN\n\n\n\n"+util.paddedInt(e.length,3)+util.paddedInt(f.length,3)+util.paddedInt(0,3)+"\n";for(var h=0;h<g.length;++h){var i=new chem.MolfileSaver(!1),j=a.clone(g[h],null,!0),k=i.saveMolecule(j,!1,!0);this.molfile+="$MOL\n"+k}return this.molfile}if(a.rgroups.count()>0){if(!c){var l=new chem.MolfileSaver(!1).getCTab(a.getScaffold(),a.rgroups);return this.molfile="$MDL  REV  1\n$MOL\n$HDR\n\n\n\n$END HDR\n",this.molfile+="$CTAB\n"+l+"$END CTAB\n",a.rgroups.each(function(b,c){this.molfile+="$RGP\n",this.writePaddedNumber(b,3),this.molfile+="\n",c.frags.each(function(b,c){var d=new chem.MolfileSaver(!1).getCTab(a.getFragment(c));this.molfile+="$CTAB\n"+d+"$END CTAB\n"},this),this.molfile+="$END RGP\n"},this),this.molfile+="$END MOL\n",this.molfile}a=a.getScaffold()}return this.molecule=a.clone(),this.prepareSGroups(b),this.writeHeader(),this.writeCTab2000(),this.molfile},chem.MolfileSaver.prototype.writeHeader=function(){var a=new Date;this.writeCR(),this.writeWhiteSpace(2),this.write("MolView"),this.writeWhiteSpace(),this.writeCR((a.getMonth()+1).toPaddedString(2)+a.getDate().toPaddedString(2)+(a.getFullYear()%100).toPaddedString(2)+a.getHours().toPaddedString(2)+a.getMinutes().toPaddedString(2)+"2D 1   1.00000     0.00000     0"),this.writeCR()},chem.MolfileSaver.prototype.write=function(a){this.molfile+=a},chem.MolfileSaver.prototype.writeCR=function(a){0==arguments.length&&(a=""),this.molfile+=a+"\n"},chem.MolfileSaver.prototype.writeWhiteSpace=function(a){0==arguments.length&&(a=1);for(var b=0;a>b;b++)this.write(" ")},chem.MolfileSaver.prototype.writePadded=function(a,b){this.write(a),this.writeWhiteSpace(b-a.length)},chem.MolfileSaver.prototype.writePaddedNumber=function(a,b){var c=(a-0).toString();this.writeWhiteSpace(b-c.length),this.write(c)},chem.MolfileSaver.prototype.writePaddedFloat=function(a,b,c){this.write(util.paddedFloat(a,b,c))},chem.MolfileSaver.prototype.writeCTab2000Header=function(){this.writePaddedNumber(this.molecule.atoms.count(),3),this.writePaddedNumber(this.molecule.bonds.count(),3),this.writePaddedNumber(0,3),this.writeWhiteSpace(3),this.writePaddedNumber(this.molecule.isChiral?1:0,3),this.writePaddedNumber(0,3),this.writeWhiteSpace(12),this.writePaddedNumber(999,3),this.writeCR(" V2000")},chem.MolfileSaver.prototype.writeCTab2000=function(a){this.writeCTab2000Header(),this.mapping={};var b=1,c=[],d=[];for(this.molecule.atoms.each(function(a,e){this.writePaddedFloat(e.pp.x,10,4),this.writePaddedFloat(-e.pp.y,10,4),this.writePaddedFloat(0,10,4),this.writeWhiteSpace();var f=e.label;null!=e.atomList?(f="L",c.push(a)):null==chem.Element.getElementByLabel(f)&&-1==["A","Q","X","*","R#"].indexOf(f)&&(f="C",d.push(a)),this.writePadded(f,3),this.writePaddedNumber(0,2),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),isUndefined(e.hCount)&&(e.hCount=0),this.writePaddedNumber(e.hCount,3),isUndefined(e.stereoCare)&&(e.stereoCare=0),this.writePaddedNumber(e.stereoCare,3),this.writePaddedNumber(e.explicitValence<0?0:0==e.explicitValence?15:e.explicitValence,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),isUndefined(e.aam)&&(e.aam=0),this.writePaddedNumber(e.aam,3),isUndefined(e.invRet)&&(e.invRet=0),this.writePaddedNumber(e.invRet,3),isUndefined(e.exactChangeFlag)&&(e.exactChangeFlag=0),this.writePaddedNumber(e.exactChangeFlag,3),this.writeCR(),this.mapping[a]=b,b++},this),this.bondMapping={},b=1,this.molecule.bonds.each(function(a,c){this.bondMapping[a]=b++,this.writePaddedNumber(this.mapping[c.begin],3),this.writePaddedNumber(this.mapping[c.end],3),this.writePaddedNumber(c.type,3),isUndefined(c.stereo)&&(c.stereo=0),this.writePaddedNumber(c.stereo,3),this.writeWhiteSpace(3),isUndefined(c.topology)&&(c.topology=0),this.writePaddedNumber(c.topology,3),isUndefined(c.reactingCenterStatus)&&(c.reactingCenterStatus=0),this.writePaddedNumber(c.reactingCenterStatus,3),this.writeCR()},this);d.length>0;)this.write("A  "),this.writePaddedNumber(d[0]+1,3),this.writeCR(),this.writeCR(this.molecule.atoms.get(d[0]).label),d.splice(0,1);var e=new Array,f=new Array,g=new Array,h=new Array,i=new Array,j=new Array,k=new Array,l=new Array,m=new Array;this.molecule.atoms.each(function(a,b){if(0!=b.charge&&e.push([a,b.charge]),0!=b.isotope&&f.push([a,b.isotope]),0!=b.radical&&g.push([a,b.radical]),null!=b.rglabel&&"R#"==b.label)for(var c=0;32>c;c++)b.rglabel&1<<c&&h.push([a,c+1]);null!=b.attpnt&&j.push([a,b.attpnt]),0!=b.ringBondCount&&k.push([a,b.ringBondCount]),0!=b.substitutionCount&&m.push([a,b.substitutionCount]),0!=b.unsaturatedAtom&&l.push([a,b.unsaturatedAtom])}),a&&a.each(function(a,b){if(b.resth||b.ifthen>0||b.range.length>0){var c="  1 "+util.paddedInt(a,3)+" "+util.paddedInt(b.ifthen,3)+" "+util.paddedInt(b.resth?1:0,3)+"   "+b.range;i.push(c)}});var n=function(a,b){for(;b.length>0;){for(var c=new Array;b.length>0&&c.length<8;)c.push(b[0]),b.splice(0,1);this.write(a),this.writePaddedNumber(c.length,3),util.each(c,function(a){this.writeWhiteSpace(),this.writePaddedNumber(this.mapping[a[0]],3),this.writeWhiteSpace(),this.writePaddedNumber(a[1],3)},this),this.writeCR()}};n.call(this,"M  CHG",e),n.call(this,"M  ISO",f),n.call(this,"M  RAD",g),n.call(this,"M  RGP",h);for(var o=0;o<i.length;++o)this.write("M  LOG"+i[o]+"\n");if(n.call(this,"M  APO",j),n.call(this,"M  RBC",k),n.call(this,"M  SUB",m),n.call(this,"M  UNS",l),c.length>0)for(o=0;o<c.length;++o){var p=c[o],q=this.molecule.atoms.get(p).atomList;this.write("M  ALS"),this.writePaddedNumber(p+1,4),this.writePaddedNumber(q.ids.length,3),this.writeWhiteSpace(),this.write(q.notList?"T":"F");for(var r=q.labelList(),s=0;s<r.length;++s)this.writeWhiteSpace(),this.writePadded(r[s],3);this.writeCR()}var t={},u=1,v={},w=this.molecule.sGroupForest.getSGroupsBFS();util.each(w,function(a){v[u]=a,t[a]=u++},this);for(var x=1;u>x;++x){var y=v[x],z=this.molecule.sgroups.get(y);this.write("M  STY"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(x,3),this.writeWhiteSpace(1),this.writePadded(z.type,3),this.writeCR(),this.write("M  SLB"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(x,3),this.writeWhiteSpace(1),this.writePaddedNumber(x,3),this.writeCR();var A=this.molecule.sGroupForest.parent.get(y);if(A>=0&&(this.write("M  SPL"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(x,3),this.writeWhiteSpace(1),this.writePaddedNumber(t[A],3),this.writeCR()),"SRU"==z.type&&z.data.connectivity){var B="";B+=" ",B+=util.stringPadded(x.toString(),3),B+=" ",B+=util.stringPadded(z.data.connectivity,3,!0),this.write("M  SCN"),this.writePaddedNumber(1,3),this.write(B.toUpperCase()),this.writeCR()}"SRU"==z.type&&(this.write("M  SMT "),this.writePaddedNumber(x,3),this.writeWhiteSpace(),this.write(z.data.subscript||"n"),this.writeCR()),this.writeCR(z.saveToMolfile(this.molecule,t,this.mapping,this.bondMapping))}this.writeCR("M  END")},chem.Molfile.parseRxn=function(a){var b=chem.Molfile,c=a[0].trim().split(" ");return c.length>1&&"V3000"==c[1]?b.parseRxn3000(a):b.parseRxn2000(a)},chem.Molfile.parseRxn2000=function(a){var b=chem.Molfile;a=a.slice(4);var c=b.partitionLine(a[0],b.fmtInfo.rxnItemsPartition),d=c[0]-0,e=c[1]-0,f=c[2]-0;a=a.slice(1);for(var g=[];a.length>0&&"$MOL"==a[0].substr(0,4);){a=a.slice(1);for(var h=0;h<a.length&&"$MOL"!=a[h].substr(0,4);)h++;g.push(chem.Molfile.parseMol(a.slice(0,h))),a=a.slice(h)}return b.rxnMerge(g,d,e,f)},chem.Molfile.parseRxn3000=function(a){var b=chem.Molfile;a=a.slice(4);for(var c=a[0].split(/\s+/g).slice(3),d=c[0]-0,e=c[1]-0,f=c.length>2?c[2]-0:0,g=function(a){util.assert(a,"CTab format invalid")},h=function(b){for(var c=b;c<a.length;++c)if("M  V30 END CTAB"==a[c].trim())return c;g(!1)},i=function(b){for(var c=b;c<a.length;++c)if("M  V30 END RGROUP"==a[c].trim())return c;g(!1)},j=[],k=[],l=null,m=[],n=0;n<a.length;++n){var o=a[n].trim();if(o.startsWith("M  V30 COUNTS"));else{if("M  END"==o)break;if("M  V30 BEGIN PRODUCT"==o)g(null==l),l=k;else if("M  V30 END PRODUCT"==o)g(l===k),l=null;else if("M  V30 BEGIN REACTANT"==o)g(null==l),l=j;else if("M  V30 END REACTANT"==o)g(l===j),l=null;else if(o.startsWith("M  V30 BEGIN RGROUP")){g(null==l);var p=i(n);m.push(a.slice(n,p+1)),n=p}else{if("M  V30 BEGIN CTAB"!=o)throw new Error("Line unrecognized: "+o);var p=h(n);l.push(a.slice(n,p+1)),n=p}}}for(var q=[],r=j.concat(k),p=0;p<r.length;++p){var s=chem.Molfile.parseCTabV3000(r[p],c);q.push(s)}var t=b.rxnMerge(q,d,e,f);return b.readRGroups3000(t,function(a){for(var b=[],c=0;c<a.length;++c)b=b.concat(a[c]);return b}(m)),t},chem.Molfile.rxnMerge=function(a,b,c,d){var e,f=(chem.Molfile,new chem.Struct),g=[],h=[],i=[],j=[],k=[],l=[],m={cnt:0,totalLength:0};for(e=0;e<a.length;++e){var n=a[e],o=n.getBondLengthData();m.cnt+=o.cnt,m.totalLength+=o.totalLength}var p=1/(0==m.cnt?1:m.totalLength/m.cnt);for(e=0;e<a.length;++e)n=a[e],n.scale(p);for(e=0;e<a.length;++e){n=a[e];var q=n.getCoordBoundingBoxObj();if(q){var r=b>e?chem.Struct.FRAGMENT.REACTANT:b+c>e?chem.Struct.FRAGMENT.PRODUCT:chem.Struct.FRAGMENT.AGENT;r==chem.Struct.FRAGMENT.REACTANT?(g.push(q),j.push(n)):r==chem.Struct.FRAGMENT.AGENT?(h.push(q),k.push(n)):r==chem.Struct.FRAGMENT.PRODUCT&&(i.push(q),l.push(n)),n.atoms.each(function(a,b){b.rxnFragmentType=r})}}var s=0,t=function(a,b,c,d,e){var f=new util.Vec2(d-c.min.x,e?1-c.min.y:-(c.min.y+c.max.y)/2);return b.atoms.each(function(a,b){b.pp.add_(f)}),b.sgroups.each(function(a,b){b.pp&&b.pp.add_(f)}),c.min.add_(f),c.max.add_(f),b.mergeInto(a),c.max.x-c.min.x};for(e=0;e<j.length;++e)s+=t(f,j[e],g[e],s,!1)+2;for(s+=2,e=0;e<k.length;++e)s+=t(f,k[e],h[e],s,!0)+2;for(s+=2,e=0;e<l.length;++e)s+=t(f,l[e],i[e],s,!1)+2;var u,v,w,x,y=null,z=null;for(e=0;e<g.length-1;++e)u=g[e],v=g[e+1],w=(u.max.x+v.min.x)/2,x=(u.max.y+u.min.y+v.max.y+v.min.y)/4,f.rxnPluses.add(new chem.Struct.RxnPlus({pp:new util.Vec2(w,x)}));for(e=0;e<g.length;++e)0==e?(y={},y.max=new util.Vec2(g[e].max),y.min=new util.Vec2(g[e].min)):(y.max=util.Vec2.max(y.max,g[e].max),y.min=util.Vec2.min(y.min,g[e].min));for(e=0;e<i.length-1;++e)u=i[e],v=i[e+1],w=(u.max.x+v.min.x)/2,x=(u.max.y+u.min.y+v.max.y+v.min.y)/4,f.rxnPluses.add(new chem.Struct.RxnPlus({pp:new util.Vec2(w,x)}));for(e=0;e<i.length;++e)0==e?(z={},z.max=new util.Vec2(i[e].max),z.min=new util.Vec2(i[e].min)):(z.max=util.Vec2.max(z.max,i[e].max),z.min=util.Vec2.min(z.min,i[e].min));if(u=y,v=z,u||v){var A=u?new util.Vec2(u.max.x,(u.max.y+u.min.y)/2):null,B=v?new util.Vec2(v.min.x,(v.max.y+v.min.y)/2):null,C=3;A||(A=new util.Vec2(B.x-C,B.y)),B||(B=new util.Vec2(A.x+C,A.y)),f.rxnArrows.add(new chem.Struct.RxnArrow({pp:util.Vec2.lc2(A,.5,B,.5)}))}else f.rxnArrows.add(new chem.Struct.RxnArrow({pp:new util.Vec2(0,0)}));return f.isReaction=!0,f},chem.Molfile.rgMerge=function(a,b){var c=new chem.Struct;a.mergeInto(c,null,null,!1,!0);for(var d in b)for(var e=0;e<b[d].length;++e){var f=b[d][e];f.rgroups.set(d,new chem.Struct.RGroup);var g=f.frags.add(new chem.Struct.Fragment);f.rgroups.get(d).frags.add(g),f.atoms.each(function(a,b){b.fragment=g}),f.mergeInto(c)}return c},chem.Molfile.parseRg2000=function(a){var b=chem.Molfile;if(a=a.slice(7),"$CTAB"!=a[0].trim())throw new Error("RGFile format invalid");for(var c=1;"$"!=a[c].charAt(0);)c++;if("$END CTAB"!=a[c].trim())throw new Error("RGFile format invalid");var d=a.slice(1,c);a=a.slice(c+1);for(var e={};;){if(0==a.length)throw new Error("Unexpected end of file");var f=a[0].trim();if("$END MOL"==f){a=a.slice(1);break}if("$RGP"!=f)throw new Error("RGFile format invalid");var g=a[1].trim()-0;for(e[g]=[],a=a.slice(2);;){if(0==a.length)throw new Error("Unexpected end of file");if(f=a[0].trim(),"$END RGP"==f){a=a.slice(1);break}if("$CTAB"!=f)throw new Error("RGFile format invalid");for(c=1;"$"!=a[c].charAt(0);)c++;if("$END CTAB"!=a[c].trim())throw new Error("RGFile format invalid");e[g].push(a.slice(1,c)),a=a.slice(c+1)}}var h=chem.Molfile.parseCTab(d),i={};if(chem.Molfile.loadRGroupFragments)for(var j in e){i[j]=[];for(var k=0;k<e[j].length;++k)i[j].push(chem.Molfile.parseCTab(e[j][k]))}return b.rgMerge(h,i)},!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");if(chem.SGroup=function(a){if(!(a&&a in chem.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=a,this.id=-1,chem.SGroup.equip(this,a),this.label=-1,this.bracketBox=null,this.bracketDir=new util.Vec2(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"n",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",fieldValue:"",units:"",query:"",queryOp:""}},chem.SGroup.prototype.getAttr=function(a){return this.data[a]},chem.SGroup.prototype.getAttrs=function(){var a={};for(var b in this.data)a[b]=this.data[b];return a},chem.SGroup.prototype.setAttr=function(a,b){var c=this.data[a];return this.data[a]=b,c},chem.SGroup.prototype.checkAttr=function(a,b){return this.data[a]==b},chem.SGroup.equip=function(a,b){var c=chem.SGroup.TYPES[b];for(var d in c)a[d]=c[d]},chem.SGroup.numberArrayToString=function(a,b){for(var c=util.stringPadded(a.length,3),d=0;d<a.length;++d)c+=" "+util.stringPadded(b[a[d]],3);return c},chem.SGroup.addGroup=function(a,b,c){b.id=a.sgroups.add(b),b.postLoad(a,c);for(var d=0;d<b.atoms.length;++d)a.atoms.has(b.atoms[d])&&util.Set.add(a.atoms.get(b.atoms[d]).sgs,b.id);return a.sGroupForest.insert(b.id),b.id},chem.SGroup.bracketsToMolfile=function(a,b,c){var d=[],e=[],f=util.Set.fromList(b.atoms);chem.SGroup.getCrossBonds(d,e,a,f),chem.SGroup.bracketPos(b,null,a,e);for(var g=b.bracketBox,h=b.bracketDir,i=h.rotateSC(1,0),j=chem.SGroup.getBracketParameters(a,e,f,g,h,i,null,b.id),k=[],l=0;l<j.length;++l){for(var m=j[l],n=m.c.addScaled(m.n,-.5*m.h).yComplement(),o=m.c.addScaled(m.n,.5*m.h).yComplement(),p="M  SDI "+c+util.paddedInt(4,3),q=[n.x,n.y,o.x,o.y],r=0;r<q.length;++r)p+=util.paddedFloat(q[r],10,4);k.push(p)}return k},chem.SGroup.filterAtoms=function(a,b){for(var c=[],d=0;d<a.length;++d){var e=a[d];"number"!=typeof b[e]?c.push(e):b[e]>=0?c.push(b[e]):c.push(-1)}return c},chem.SGroup.removeNegative=function(a){for(var b=[],c=0;c<a.length;++c)a[c]>=0&&b.push(a[c]);return b},chem.SGroup.filter=function(a,b,c){b.atoms=chem.SGroup.removeNegative(chem.SGroup.filterAtoms(b.atoms,c))},chem.SGroup.clone=function(a,b,c){var d=new chem.SGroup(a.type);for(var e in a.data)d.data[e]=a.data[e];return d.atoms=util.mapArray(a.atoms,b),d.pp=a.pp,d.bracketBox=a.bracketBox,d.patoms=null,d.bonds=null,d.allAtoms=a.allAtoms,d},chem.SGroup.addAtom=function(a,b){a.atoms.push(b)},chem.SGroup.removeAtom=function(a,b){for(var c=0;c<a.atoms.length;++c)if(a.atoms[c]===b)return void a.atoms.splice(c,1);throw new Error("The atom is not found in the given s-group")},chem.SGroup.getCrossBonds=function(a,b,c,d){c.bonds.each(function(c,e){util.Set.contains(d,e.begin)&&util.Set.contains(d,e.end)?util.isNull(a)||a.push(c):(util.Set.contains(d,e.begin)||util.Set.contains(d,e.end))&&(util.isNull(b)||b.push(c))},this)},chem.SGroup.bracketPos=function(a,b,c,d){var e=a.atoms;if(d&&2===d.length){var f=c.bonds.get(d[0]),g=c.bonds.get(d[1]),h=f.getCenter(c),i=g.getCenter(c);a.bracketDir=util.Vec2.diff(i,h).normalized()}else a.bracketDir=new util.Vec2(1,0);var j=a.bracketDir,k=j.rotateSC(1,0),l=null,m=[];util.each(e,function(a){var d=c.atoms.get(a),e=b?b.ctab.atoms.get(a).visel.boundingBox:null,f=new util.Vec2(d.pp);if(util.isNull(e)){e=new util.Box2Abs(f,f);var g=new util.Vec2(.05*3,.05*3);e=e.extend(g,g)}else e=e.translate((b.offset||new util.Vec2).negated()).transform(b.scaled2obj,b);m.push(e)},this),util.each(c.sGroupForest.children.get(a.id),function(a){var c=b?b.ctab.sgroups.get(a).visel.boundingBox:null;util.isNull(c)||(c=c.translate((b.offset||new util.Vec2).negated()).transform(b.scaled2obj,b),m.push(c))},this),util.each(m,function(a){var b=null;util.each([a.p0.x,a.p1.x],function(c){util.each([a.p0.y,a.p1.y],function(a){var d=new util.Vec2(c,a),e=new util.Vec2(util.Vec2.dot(d,j),util.Vec2.dot(d,k));b=util.isNull(b)?new util.Box2Abs(e,e):b.include(e)},this)},this),l=util.isNull(l)?b:util.Box2Abs.union(l,b)},this);var n=new util.Vec2(.2,.4);util.isNull(l)||(l=l.extend(n,n)),a.bracketBox=l},chem.SGroup.drawBrackets=function(a,b,c,d,e,f,g,h,i,j,k){for(var l=chem.SGroup.getBracketParameters(b.ctab.molecule,d,e,f,g,h,b,c.id),m=-1,n=0;n<l.length;++n){var o=l[n],p=chem.SGroup.drawBracket(b,b.paper,b.styles,o.d,o.n,o.c,o.w,o.h);a.push(p),(0>m||l[m].d.x<o.d.x||l[m].d.x==o.d.x&&l[m].d.y>o.d.y)&&(m=n)}var q=l[m],r=function(c,d){var e=b.ps(q.c.addScaled(q.n,d*q.h)),f=b.paper.text(e.x,e.y,c).attr({font:b.settings.font,"font-size":b.settings.fontszsub});k&&f.attr(k);var g=util.Box2Abs.fromRelBox(rnd.relBox(f.getBBox())),h=Math.max(util.Vec2.shiftRayBox(e,q.d.negated(),g),3)+2;f.translateAbs(h*q.d.x,h*q.d.y),a.push(f)};i&&r(i,.5),j&&r(j,-.5)},chem.SGroup.drawBracket=function(a,b,c,d,e,f,g,h){g=g||.25,h=h||1;var i=f.addScaled(e,-.5*h),j=f.addScaled(e,.5*h),k=i.addScaled(d,-g),l=j.addScaled(d,-g);return i=a.obj2scaled(i),j=a.obj2scaled(j),k=a.obj2scaled(k),l=a.obj2scaled(l),b.path("M {0}, {1} L {2} , {3} L {4} , {5} L {6} , {7}",k.x,k.y,i.x,i.y,j.x,j.y,l.x,l.y).attr(c.sgroupBracketStyle)},chem.SGroup.getBracketParameters=function(a,b,c,d,e,f,g,h){var i=function(a,b,c,d){this.c=a,this.d=b,this.n=b.rotateSC(1,0),this.w=c,this.h=d},j=[];return b.length<2?!function(){e=e||new util.Vec2(1,0),f=f||e.rotateSC(1,0);var a=Math.min(.25,.3*d.sz().x),b=util.Vec2.lc2(e,d.p0.x,f,.5*(d.p0.y+d.p1.y)),c=util.Vec2.lc2(e,d.p1.x,f,.5*(d.p0.y+d.p1.y)),g=d.sz().y;j.push(new i(b,e.negated(),a,g),new i(c,e,a,g))}():2===b.length?!function(){var c=a.bonds.get(b[0]),d=a.bonds.get(b[1]),e=c.getCenter(a),f=d.getCenter(a),k=-1,l=-1,m=-1,n=-1,o=util.Vec2.centre(e,f),p=util.Vec2.diff(f,e).normalized(),q=p.negated(),r=p.rotateSC(1,0),s=r.negated();util.each(a.sGroupForest.children.get(h),function(a){var b=g?g.ctab.sgroups.get(a).visel.boundingBox:null;util.isNull(b)||(b=b.translate((g.offset||new util.Vec2).negated()).transform(g.scaled2obj,g),k=Math.max(k,util.Vec2.shiftRayBox(e,q,b)),l=Math.max(l,util.Vec2.shiftRayBox(f,p,b)),m=Math.max(m,util.Vec2.shiftRayBox(o,r,b)),n=Math.max(n,util.Vec2.shiftRayBox(o,s,b)))},this),k=Math.max(k+.2,0),l=Math.max(l+.2,0),m=Math.max(Math.max(m,n)+.1,0);var t=.25,u=1.5+m;j.push(new i(e.addScaled(q,k),q,t,u),new i(f.addScaled(p,l),p,t,u))}():!function(){for(var d=0;d<b.length;++d){var e=a.bonds.get(b[d]),f=e.getCenter(a),g=util.Set.contains(c,e.begin)?e.getDir(a):e.getDir(a).negated();j.push(new i(f,g,.2,1))}}(),j},chem.SGroup.getObjBBox=function(a,b){if(0==a.length)throw new Error("Atom list is empty");for(var c=b.atoms.get(a[0]).pp,d=new util.Box2Abs(c,c),e=1;e<a.length;++e){var f=a[e],g=b.atoms.get(f),h=g.pp;d=d.include(h)}return d},chem.SGroup.makeAtomBondLines=function(a,b,c,d){if(!c)return[];for(var e=[],f=0;f<Math.floor((c.length+14)/15);++f){for(var g=Math.min(c.length-15*f,15),h="M  "+a+" "+b+" "+util.paddedInt(g,2),i=0;g>i;++i)h+=" "+util.paddedInt(d[c[15*f+i]],3);e.push(h)}return e},chem.SGroup.getAtoms=function(a,b){if(!b.allAtoms)return b.atoms;var c=[];return a.atoms.each(function(a){c.push(a)}),c},chem.SGroup.getBonds=function(a,b){var c=chem.SGroup.getAtoms(a,b),d=[];return a.bonds.each(function(a,b){c.indexOf(b.begin)>=0&&c.indexOf(b.end)>=0&&d.push(a)}),d},chem.SGroup.GroupMul={draw:function(a){var b=a.render,c=b.paper.set(),d=[],e=[],f=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(d,e,a.molecule,f),chem.SGroup.bracketPos(this,b,a.molecule,e);var g=this.bracketBox,h=this.bracketDir,i=h.rotateSC(1,0);return this.areas=[g],chem.SGroup.drawBrackets(c,b,this,e,f,g,h,i,this.data.mul),c},saveToMolfile:function(a,b,c,d){var e=util.stringPadded(b[this.id],3),f=[];f=f.concat(chem.SGroup.makeAtomBondLines("SAL",e,util.idList(this.atomSet),c)),f=f.concat(chem.SGroup.makeAtomBondLines("SPA",e,util.idList(this.parentAtomSet),c)),f=f.concat(chem.SGroup.makeAtomBondLines("SBL",e,this.bonds,d));var g="M  SMT "+e+" "+this.data.mul;return f.push(g),f=f.concat(chem.SGroup.bracketsToMolfile(a,this,e)),f.join("\n")},prepareForSaving:function(a){var b;this.atoms.sort(),this.atomSet=util.Set.fromList(this.atoms),this.parentAtomSet=util.Set.clone(this.atomSet);var c=[],d=[];if(a.bonds.each(function(a,b){util.Set.contains(this.parentAtomSet,b.begin)&&util.Set.contains(this.parentAtomSet,b.end)?c.push(a):(util.Set.contains(this.parentAtomSet,b.begin)||util.Set.contains(this.parentAtomSet,b.end))&&d.push(a)},this),0!=d.length&&2!=d.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var e=-1,f=-1,g=null;if(2==d.length){var h=a.bonds.get(d[0]);e=util.Set.contains(this.parentAtomSet,h.begin)?h.begin:h.end;var i=a.bonds.get(d[1]);f=util.Set.contains(this.parentAtomSet,i.begin)?i.begin:i.end,g=i}var j=null,k=e,l=[];for(b=0;b<this.data.mul-1;++b)if(j={},util.each(this.atoms,function(b){var c=a.atoms.get(b),d=a.atoms.add(new chem.Struct.Atom(c));l.push(d),this.atomSet[d]=1,j[b]=d},this),util.each(c,function(b){var c=a.bonds.get(b),d=new chem.Struct.Bond(c);d.begin=j[d.begin],d.end=j[d.end],a.bonds.add(d)},this),null!=g){var m=new chem.Struct.Bond(g);m.begin=k,m.end=j[f],a.bonds.add(m),k=j[e]}if(util.each(l,function(b){util.each(a.sGroupForest.getPathToRoot(this.id).reverse(),function(c){a.atomAddToSGroup(c,b)},this)},this),k>=0){var n=a.bonds.get(d[0]);n.begin==e?n.begin=k:n.end=k}this.bonds=d},postLoad:function(a,b){this.data.mul=this.data.subscript-0;var c={};this.atoms=chem.SGroup.filterAtoms(this.atoms,b),this.patoms=chem.SGroup.filterAtoms(this.patoms,b);for(var d=1;d<this.data.mul;++d)for(var e=0;e<this.patoms.length;++e){var f=this.atoms[d*this.patoms.length+e];if(!(0>f)){if(this.patoms[e]<0)throw new Error("parent atom missing");c[f]=this.patoms[e]}}this.patoms=chem.SGroup.removeNegative(this.patoms);var g=util.identityMap(this.patoms),h=[];a.bonds.each(function(a,b){var d=b.begin in c,e=b.end in c;d&&e||d&&b.end in g||e&&b.begin in g?h.push(a):d?b.begin=c[b.begin]:e&&(b.end=c[b.end])},this);for(var i=0;i<h.length;++i)a.bonds.remove(h[i]);for(var j in c)a.atoms.remove(j),b[j]=-1;this.atoms=this.patoms,this.patoms=null}},chem.SGroup.GroupSru={draw:function(a){var b=a.render,c=b.paper.set(),d=[],e=[],f=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(d,e,a.molecule,f),chem.SGroup.bracketPos(this,b,a.molecule,e);var g=this.bracketBox,h=this.bracketDir,i=h.rotateSC(1,0);this.areas=[g];var j=this.data.connectivity||"eu";"ht"==j&&(j="");var k=this.data.subscript||"n";return chem.SGroup.drawBrackets(c,b,this,e,f,g,h,i,k,j),c},saveToMolfile:function(a,b,c,d){var e=util.stringPadded(b[this.id],3),f=[];return f=f.concat(chem.SGroup.makeAtomBondLines("SAL",e,this.atoms,c)),f=f.concat(chem.SGroup.makeAtomBondLines("SBL",e,this.bonds,d)),f=f.concat(chem.SGroup.bracketsToMolfile(a,this,e)),f.join("\n")},prepareForSaving:function(a){var b=[];if(a.bonds.each(function(c,d){var e=a.atoms.get(d.begin),f=a.atoms.get(d.end);(util.Set.contains(e.sgs,this.id)&&!util.Set.contains(f.sgs,this.id)||util.Set.contains(f.sgs,this.id)&&!util.Set.contains(e.sgs,this.id))&&b.push(c)},this),0!=b.length&&2!=b.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};this.bonds=b},postLoad:function(a,b){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},chem.SGroup.GroupSup={draw:function(a){var b=a.render,c=b.paper.set(),d=[],e=[],f=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(d,e,a.molecule,f),chem.SGroup.bracketPos(this,b,a.molecule,e);var g=this.bracketBox,h=this.bracketDir,i=h.rotateSC(1,0);return this.areas=[g],chem.SGroup.drawBrackets(c,b,this,e,f,g,h,i,this.data.name,null,{"font-style":"italic"}),c},saveToMolfile:function(a,b,c,d){var e=util.stringPadded(b[this.id],3),f=[];return f=f.concat(chem.SGroup.makeAtomBondLines("SAL",e,this.atoms,c)),f=f.concat(chem.SGroup.makeAtomBondLines("SBL",e,this.bonds,d)),this.data.name&&""!=this.data.name&&f.push("M  SMT "+e+" "+this.data.name),f.join("\n")},prepareForSaving:function(a){var b=[];a.bonds.each(function(c,d){var e=a.atoms.get(d.begin),f=a.atoms.get(d.end);(util.Set.contains(e.sgs,this.id)&&!util.Set.contains(f.sgs,this.id)||util.Set.contains(f.sgs,this.id)&&!util.Set.contains(e.sgs,this.id))&&b.push(c)},this),this.bonds=b},postLoad:function(a,b){this.data.name=(this.data.subscript||"").strip(),this.data.subscript=""}},chem.SGroup.GroupGen={draw:function(a){var b=a.render,c=(b.settings,b.styles,b.paper),d=c.set(),e=[],f=[],g=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(e,f,a.molecule,g),chem.SGroup.bracketPos(this,b,a.molecule,f);var h=this.bracketBox,i=this.bracketDir,j=i.rotateSC(1,0);return this.areas=[h],chem.SGroup.drawBrackets(d,b,this,f,g,h,i,j),d},saveToMolfile:function(a,b,c,d){var e=util.stringPadded(b[this.id],3),f=[];return f=f.concat(chem.SGroup.makeAtomBondLines("SAL",e,this.atoms,c)),f=f.concat(chem.SGroup.makeAtomBondLines("SBL",e,this.bonds,d)),f=f.concat(chem.SGroup.bracketsToMolfile(a,this,e)),f.join("\n")},prepareForSaving:function(a){},postLoad:function(a,b){}},chem.SGroup.getMassCentre=function(a,b){for(var c=new util.Vec2,d=0;d<b.length;++d)c=c.addScaled(a.atoms.get(b[d]).pp,1/b.length);return c},chem.SGroup.setPos=function(a,b,c){b.pp=c},chem.SGroup.GroupDat={showValue:function(a,b,c,d){var e=a.text(b.x,b.y,c.data.fieldValue).attr({font:d.font,"font-size":d.fontsz});return e},draw:function(a){var b,c=a.render,d=c.settings,e=c.paper,f=e.set(),g=chem.SGroup.getAtoms(a,this);chem.SGroup.bracketPos(this,c,a.molecule),this.areas=this.bracketBox?[this.bracketBox]:[],null==this.pp&&chem.SGroup.setPos(a,this,this.bracketBox.p1.add(new util.Vec2(.5,.5)));var h=this.pp.scaled(d.scaleFactor);if(this.data.attached)for(b=0;b<g.length;++b){var i=a.atoms.get(g[b]),j=c.ps(i.a.pp),k=i.visel.boundingBox;null!=k&&(j.x=Math.max(j.x,k.p1.x)),j.x+=d.lineWidth;var l=this.showValue(e,j,this,d),m=rnd.relBox(l.getBBox());l.translateAbs(.5*m.width,-.3*m.height),f.push(l);var n=util.Box2Abs.fromRelBox(rnd.relBox(l.getBBox()));n=n.transform(c.scaled2obj,c),this.areas.push(n)}else{var o=this.showValue(e,h,this,d),p=rnd.relBox(o.getBBox());o.translateAbs(.5*p.width,-.5*p.height),f.push(o);var q=util.Box2Abs.fromRelBox(rnd.relBox(o.getBBox()));this.dataArea=q.transform(c.scaled2obj,c),a.sgroupData.has(this.id)||a.sgroupData.set(this.id,new rnd.ReDataSGroupData(this))}return f},saveToMolfile:function(a,b,c,d){var e=util.stringPadded(b[this.id],3),f=this.data,g=this.pp;f.absolute||(g=g.sub(chem.SGroup.getMassCentre(a,this.atoms)));var h=[];h=h.concat(chem.SGroup.makeAtomBondLines("SAL",e,this.atoms,c));var i="M  SDT "+e+" "+util.stringPadded(f.fieldName,30,!0)+util.stringPadded(f.fieldType,2)+util.stringPadded(f.units,20,!0)+util.stringPadded(f.query,2)+util.stringPadded(f.queryOp,3);h.push(i);var j="M  SDD "+e+" "+util.paddedFloat(g.x,10,4)+util.paddedFloat(-g.y,10,4)+"    "+(f.attached?"A":"D")+(f.absolute?"A":"R")+(f.showUnits?"U":" ")+"   "+(f.nCharnCharsToDisplay>=0?util.paddedInt(f.nCharnCharsToDisplay,3):"ALL")+"  1   "+util.stringPadded(f.tagChar,1)+"  "+util.paddedInt(f.daspPos,1)+"  ";return h.push(j),f.fieldValue.replace(/[\r\n|\n|\r]*$/,"").split(/\r\n|\n|\r/).each(function(a){for(var b=69;a.length>b;)h.push("M  SCD "+e+" "+a.slice(0,b)),a=a.slice(69);h.push("M  SED "+e+" "+util.stringPadded(a,b,!0))},this),h.join("\n")},prepareForSaving:function(a){this.atoms=chem.SGroup.getAtoms(a,this)},postLoad:function(a,b){var c=this.atoms.length==a.atoms.count();this.data.absolute||(this.pp=this.pp.add(chem.SGroup.getMassCentre(a,this.atoms))),!c||"MDLBG_FRAGMENT_STEREO"!=this.data.fieldName&&"MDLBG_FRAGMENT_COEFFICIENT"!=this.data.fieldName&&"MDLBG_FRAGMENT_CHARGE"!=this.data.fieldName||(this.atoms=[],this.allAtoms=!0)}},chem.SGroup.TYPES={MUL:chem.SGroup.GroupMul,SRU:chem.SGroup.GroupSru,SUP:chem.SGroup.GroupSup,DAT:chem.SGroup.GroupDat,GEN:chem.SGroup.GroupGen},chem.SGroupForest=function(a){this.parent=new util.Map,this.children=new util.Map,this.children.set(-1,[]),this.molecule=a},chem.SGroupForest.prototype.getSGroupsBFS=function(){var a=[],b=[],c=-1;for(b=util.array(this.children.get(-1));b.length>0;){var c=b.shift();b=b.concat(this.children.get(c)),a.push(c)}return a},chem.SGroupForest.prototype.getAtomSets=function(){return this.molecule.sgroups.map(function(a,b){return util.Set.fromList(b.atoms)})},chem.SGroupForest.prototype.getAtomSetRelations=function(a,b,c){var d=new util.Map,e=new util.Map,c=this.getAtomSets();c.unset(a),c.each(function(a,c){e.set(a,util.Set.subset(b,c)),d.set(a,util.Set.subset(c,b)&&!util.Set.eq(c,b))},this);var f=c.findAll(function(a){return e.get(a)?!(util.find(this.children.get(a),function(a){return e.get(a)},this)>=0):!1},this);util.assert(f.length<=1);var g=c.findAll(function(a,b){
return d.get(a)&&!d.get(this.parent.get(a))},this);return{children:g,parent:0===f.length?-1:f[0]}},chem.SGroupForest.prototype.getPathToRoot=function(a){for(var b=[],c=a;c>=0;c=this.parent.get(c))util.assert(b.indexOf(c)<0,"SGroupForest: loop detected"),b.push(c);return b},chem.SGroupForest.prototype.validate=function(){var a=this.getAtomSets();this.molecule.sgroups.each(function(a){this.getPathToRoot(a)},this);var b=!0;return this.parent.each(function(c,d){d>=0&&!util.Set.subset(a.get(c),a.get(d))&&(b=!1)},this),this.children.each(function(c){for(var d=this.children.get(c),e=0;e<d.length;++e)for(var f=e+1;f<d.length;++f)util.Set.disjoint(a.get(d[e]),a.get(d[f]))||(b=!1)},this),b},chem.SGroupForest.prototype.insert=function(a,b,c){util.assert(!this.parent.has(a),"sgid already present in the forest"),util.assert(!this.children.has(a),"sgid already present in the forest"),util.assert(this.validate(),"s-group forest invalid");var d=this.getAtomSets(),e=util.Set.fromList(this.molecule.sgroups.get(a).atoms);if(util.isUndefined(b)||util.isUndefined(c)){var f=this.getAtomSetRelations(a,e,d);b=f.parent,c=f.children}return util.each(c,function(b){util.assert(1===util.arrayRemoveByValue(this.children.get(this.parent.get(b)),b)),this.parent.set(b,a)},this),this.children.set(a,c),this.parent.set(a,b),this.children.get(b).push(a),util.assert(this.validate(),"s-group forest invalid"),{parent:b,children:c}},chem.SGroupForest.prototype.remove=function(a){util.assert(this.parent.has(a),"sgid is not in the forest"),util.assert(this.children.has(a),"sgid is not in the forest"),util.assert(this.validate(),"s-group forest invalid");var b=this.parent.get(a);util.each(this.children.get(a),function(a){this.parent.set(a,b),this.children.get(b).push(a)},this),util.assert(1===util.arrayRemoveByValue(this.children.get(b),a)),this.children.unset(a),this.parent.unset(a),util.assert(this.validate(),"s-group forest invalid")},!window.chem||!chem.Struct)throw new Error("Include MolData.js first");if(chem.Struct.prototype.calcConn=function(a){for(var b=0,c=this.atoms.get(a),d=!1,e=0;e<c.neighbors.length;++e){var f=this.halfBonds.get(c.neighbors[e]),g=this.bonds.get(f.bid);switch(g.type){case chem.Struct.BOND.TYPE.SINGLE:b+=1;break;case chem.Struct.BOND.TYPE.DOUBLE:b+=2;break;case chem.Struct.BOND.TYPE.TRIPLE:b+=3;break;case chem.Struct.BOND.TYPE.AROMATIC:b+=1,d=!0;break;default:return-1}}return d&&(b+=1),b},chem.Struct.Atom.prototype.calcValence=function(a){var b=this,c=b.charge,d=b.label;if(b.isQuery())return this.implicitH=0,!0;var e=chem.Element.getElementByLabel(d);if(null==e)return this.implicitH=0,!0;var f=chem.Element.elements.get(e).group,g=chem.Struct.radicalElectrons(b.radical),h=a,i=0,j=Math.abs(c);return 1==f?"H"!=d&&"Li"!=d&&"Na"!=d&&"K"!=d&&"Rb"!=d&&"Cs"!=d&&"Fr"!=d||(h=1,i=1-g-a-j):3==f?"B"==d||"Al"==d||"Ga"==d||"In"==d?-1==c?(h=4,i=4-g-a):(h=3,i=3-g-a-j):"Tl"==d&&(-1==c?2>=g+a?(h=2,i=2-g-a):(h=4,i=4-g-a):-2==c?3>=g+a?(h=3,i=3-g-a):(h=5,i=5-g-a):1>=g+a+j?(h=1,i=1-g-a-j):(h=3,i=3-g-a-j)):4==f?"C"==d||"Si"==d||"Ge"==d?(h=4,i=4-g-a-j):"Sn"!=d&&"Pb"!=d||(2>=a+g+j?(h=2,i=2-g-a-j):(h=4,i=4-g-a-j)):5==f?"N"==d||"P"==d?1==c?(h=4,i=4-g-a):2==c?(h=3,i=3-g-a):"N"==d||3>=g+a+j?(h=3,i=3-g-a-j):(h=5,i=5-g-a-j):"Bi"!=d&&"Sb"!=d&&"As"!=d||(1==c?2>=g+a&&"As"!=d?(h=2,i=2-g-a):(h=4,i=4-g-a):2==c?(h=3,i=3-g-a):3>=g+a?(h=3,i=3-g-a-j):(h=5,i=5-g-a-j)):6==f?"O"==d?c>=1?(h=3,i=3-g-a):(h=2,i=2-g-a-j):"S"==d||"Se"==d||"Po"==d?1==c?3>=a?(h=3,i=3-g-a):(h=5,i=5-g-a):2>=a+g+j?(h=2,i=2-g-a-j):4>=a+g+j?(h=4,i=4-g-a-j):(h=6,i=6-g-a-j):"Te"==d&&(-1==c?2>=a&&(h=2,i=2-g-a-j):0!=c&&2!=c||(2>=a?(h=2,i=2-g-a-j):4>=a?(h=4,i=4-g-a-j):0==c&&6>=a?(h=6,i=6-g-a-j):i=-1)):7==f&&("F"==d?(h=1,i=1-g-a-j):"Cl"!=d&&"Br"!=d&&"I"!=d&&"At"!=d||(1==c?2>=a?(h=2,i=2-g-a):(3==a||5==a||a>=7)&&(i=-1):0==c&&(1>=a?(h=1,i=1-g-a):2==a||4==a||6==a?1==g?(h=a,i=0):i=-1:a>7&&(i=-1)))),this.valence=h,this.implicitH=i,this.implicitH<0?(this.valence=a,this.implicitH=0,this.badConn=!0,!1):!0},chem.Struct.Atom.prototype.calcValenceMinusHyd=function(a){var b=this,c=b.charge,d=b.label,e=chem.Element.getElementByLabel(d);if(null==e)throw new Error("Element "+d+" unknown");if(0>e)return this.implicitH=0,null;var f=chem.Element.elements.get(e).group,g=chem.Struct.radicalElectrons(b.radical);if(3==f){if(("B"==d||"Al"==d||"Ga"==d||"In"==d)&&-1==c&&4>=g+a)return g+a}else if(5==f){if("N"==d||"P"==d){if(1==c)return g+a;if(2==c)return g+a}else if("Sb"==d||"Bi"==d||"As"==d){if(1==c)return g+a;if(2==c)return g+a}}else if(6==f){if("O"==d){if(c>=1)return g+a}else if(("S"==d||"Se"==d||"Po"==d)&&1==c)return g+a}else if(7==f&&("Cl"==d||"Br"==d||"I"==d||"At"==d)&&1==c)return g+a;return g+a+Math.abs(c)},chem.Struct.prototype.calcImplicitHydrogen=function(a){var b=this.calcConn(a),c=this.atoms.get(a);if(c.badConn=!1,0>b||c.isQuery())return void(c.implicitH=0);if(c.explicitValence>=0){var d=chem.Element.getElementByLabel(c.label);c.implicitH=0,null!=d&&(c.implicitH=c.explicitValence-c.calcValenceMinusHyd(b),c.implicitH<0&&(c.implicitH=0,c.badConn=!0))}else c.calcValence(b)},!window.chem||!chem.Struct)throw new Error("Molecule should be defined first");if(chem.Dfs=function(a,b,c,d){this.molecule=a,this.atom_data=b,this.components=c,this.nComponentsInReactants=-1,this.nReactants=d,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(a){this.vertices[a]=new chem.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(a){this.edges[a]=new chem.Dfs.EdgeDesc},this),this.v_seq=new Array},chem.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},chem.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},chem.Dfs.SeqElem=function(a,b,c){this.idx=a,this.parent_vertex=b,this.parent_edge=c},chem.Dfs.prototype.walk=function(){for(var a,b,c=new Array,d=0,e=0;;){if(c.length<1){for(var f=-1,g=function(a){return 0==this.vertices[a].dfs_state?(f=a,!0):!1};d<this.components.length&&-1==f;)f=util.Set.find(this.components[d],g,this),null===f&&(f=-1,d++,d==this.nReactants&&(this.nComponentsInReactants=e));if(-1>f&&this.molecule.atoms.find(g,this),-1==f)break;this.vertices[f].parent_vertex=-1,this.vertices[f].parent_edge=-1,c.push(f),e++}var h=c.pop(),i=this.vertices[h].parent_vertex,j=new chem.Dfs.SeqElem(h,i,this.vertices[h].parent_edge);this.v_seq.push(j),this.vertices[h].dfs_state=2;var k=this.atom_data[h];for(a=0;a<k.neighbours.length;a++){var l=k.neighbours[a].aid,m=k.neighbours[a].bid;if(l!=i)if(2==this.vertices[l].dfs_state){for(this.edges[m].closing_cycle=1,b=h;-1!=b&&this.vertices[b].parent_vertex!=l;)b=this.vertices[b].parent_vertex;if(-1==b)throw new Error("Cycle unwind error");this.edges[this.vertices[b].parent_edge].opening_cycles++,this.vertices[h].branches++,j=new chem.Dfs.SeqElem(l,h,m),this.v_seq.push(j)}else{if(1==this.vertices[l].dfs_state){if(b=c.indexOf(l),-1==b)throw new Error("Internal: removing vertex from stack");c.splice(b,1);var n=this.vertices[l].parent_vertex;n>=0&&this.vertices[n].branches--}this.vertices[h].branches++,this.vertices[l].parent_vertex=h,this.vertices[l].parent_edge=m,this.vertices[l].dfs_state=1,c.push(l)}}}},chem.Dfs.prototype.edgeClosingCycle=function(a){return 0!=this.edges[a].closing_cycle},chem.Dfs.prototype.numBranches=function(a){return this.vertices[a].branches},chem.Dfs.prototype.numOpeningCycles=function(a){return this.edges[a].opening_cycles},chem.Dfs.prototype.toString=function(){var a="";return this.v_seq.each(function(b){a+=b.idx+" -> "}),a+="*"},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.CisTrans=function(a,b,c){this.molecule=a,this.bonds=new util.Map,this.getNeighbors=b,this.context=c},chem.CisTrans.PARITY={NONE:0,CIS:1,TRANS:2},chem.CisTrans.prototype.each=function(a,b){this.bonds.each(a,b)},chem.CisTrans.prototype.getParity=function(a){return this.bonds.get(a).parity},chem.CisTrans.prototype.getSubstituents=function(a){return this.bonds.get(a).substituents},chem.CisTrans.prototype.sameside=function(a,b,c,d){var e=util.Vec2.diff(a,b),f=new util.Vec2(-e.y,e.x);if(!f.normalize())return 0;var g=util.Vec2.diff(c,a),h=util.Vec2.diff(d,b);if(!g.normalize())return 0;if(!h.normalize())return 0;var i=util.Vec2.dot(g,f),j=util.Vec2.dot(h,f);return Math.abs(i)<.001||Math.abs(j)<.001?0:i*j>0?1:-1},chem.CisTrans.prototype._sameside=function(a,b,c,d){return this.sameside(this.molecule.atoms.get(a).pp,this.molecule.atoms.get(b).pp,this.molecule.atoms.get(c).pp,this.molecule.atoms.get(d).pp)},chem.CisTrans.prototype._sortSubstituents=function(a){var b=this.molecule.atoms.get(a[0]).pureHydrogen(),c=a[1]<0||this.molecule.atoms.get(a[1]).pureHydrogen(),d=this.molecule.atoms.get(a[2]).pureHydrogen(),e=a[3]<0||this.molecule.atoms.get(a[3]).pureHydrogen();return b&&c?!1:d&&e?!1:(c?a[1]=-1:b?(a[0]=a[1],a[1]=-1):a[0]>a[1]&&a.swap(0,1),e?a[3]=-1:d?(a[2]=a[3],a[3]=-1):a[2]>a[3]&&a.swap(2,3),!0)},chem.CisTrans.prototype.isGeomStereoBond=function(a,b){var c=this.molecule.bonds.get(a);if(c.type!=chem.Struct.BOND.TYPE.DOUBLE)return!1;var d=this.molecule.atoms.get(c.begin).label,e=this.molecule.atoms.get(c.end).label;if("C"!=d&&"N"!=d&&"Si"!=d&&"Ge"!=d)return!1;if("C"!=e&&"N"!=e&&"Si"!=e&&"Ge"!=e)return!1;var f=this.getNeighbors.call(this.context,c.begin),g=this.getNeighbors.call(this.context,c.end);if(f.length<2||f.length>3||g.length<2||g.length>3)return!1;b[0]=-1,b[1]=-1,b[2]=-1,b[3]=-1;var h,i;for(h=0;h<f.length;h++)if(i=f[h],i.bid!=a){if(this.molecule.bonds.get(i.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==b[0]?b[0]=i.aid:b[1]=i.aid}for(h=0;h<g.length;h++)if(i=g[h],i.bid!=a){if(this.molecule.bonds.get(i.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==b[2]?b[2]=i.aid:b[3]=i.aid}return-1!=b[1]&&-1!=this._sameside(c.begin,c.end,b[0],b[1])?!1:-1==b[3]||-1==this._sameside(c.begin,c.end,b[2],b[3])},chem.CisTrans.prototype.build=function(a){this.molecule.bonds.each(function(b,c){var d=this.bonds.set(b,{parity:0,substituents:new Array(4)});if((!util.isArray(a)||!a[b])&&this.isGeomStereoBond(b,d.substituents)){var e=this._sameside(c.begin,c.end,d.substituents[0],d.substituents[2]);1==e?d.parity=chem.CisTrans.PARITY.CIS:-1==e&&(d.parity=chem.CisTrans.PARITY.TRANS)}},this)},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.Stereocenters=function(a,b,c){this.molecule=a,this.atoms=new util.Map,this.getNeighbors=b,this.context=c},chem.Stereocenters.prototype.each=function(a,b){this.atoms.each(a,b)},chem.Stereocenters.prototype.buildFromBonds=function(a){var b=this.molecule.atoms,c=this.molecule.bonds,d=util.Set.empty();if(b.each(function(a,e){var f=this.getNeighbors.call(this.context,a);if(2!=f.length)return!1;var g=f[0],h=f[1];if(util.find([a,g.aid,h.aid],function(a){return["C","Si"].indexOf(b.get(a).label)<0},this)>=0)return!1;if(util.find([g.bid,h.bid],function(a){return c.get(a).type!=chem.Struct.BOND.TYPE.DOUBLE},this)>=0)return!1;var i=util.findAll(this.getNeighbors.call(this.context,g.aid),function(b){return b.aid!=a},this),j=util.findAll(this.getNeighbors.call(this.context,h.aid),function(b){return b.aid!=a},this);return i.length<1||i.length>2||j.length<1||j.length>2?!1:util.find(i.concat(j),function(a){return c.get(a.bid).type!=chem.Struct.BOND.TYPE.SINGLE},this)>=0?!1:util.find(i.concat(j),function(a){return c.get(a.bid).stereo==chem.Struct.BOND.STEREO.EITHER},this)>=0?!1:(util.Set.add(d,g.aid),void util.Set.add(d,h.aid))},this),util.Set.size(d)>0)throw new Error("This structure may contain allenes, which cannot be represented in the SMILES notation. Relevant stereo-information will be discarded.");b.each(function(b){if(!util.Set.contains(d,b)){var c=this.getNeighbors.call(this.context,b),e=!1;util.find(c,function(a){var c=this.molecule.bonds.get(a.bid);return c.type!=chem.Struct.BOND.TYPE.SINGLE||c.begin!=b||c.stereo!=chem.Struct.BOND.STEREO.UP&&c.stereo!=chem.Struct.BOND.STEREO.DOWN?!1:(e=!0,!0)},this),e&&(a?this._buildOneCenter(b):this._buildOneCenter(b))}},this)},chem.Stereocenters.allowed_stereocenters=[{elem:"C",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"C",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:4,n_double_bonds:2,implicit_degree:4},{elem:"S",charge:1,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:3,n_double_bonds:1,implicit_degree:3},{elem:"P",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"P",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"P",charge:0,degree:4,n_double_bonds:1,implicit_degree:4}],chem.Stereocenters.prototype._buildOneCenter=function(a){var b=this.molecule.atoms.get(a),c=this.getNeighbors.call(this.context,a),d=c.length,e=-1,f={group:0,type:0,pyramid:new Array(4)},g=0,h=new Array(4),i=0,j=0;f.pyramid[0]=-1,f.pyramid[1]=-1,f.pyramid[2]=-1,f.pyramid[3]=-1;var k=0;if(d>4)throw new Error("Stereocenter with "+d+" bonds are not supported");if(c.each(function(a){var c=this.molecule.atoms.get(a.aid),d=this.molecule.bonds.get(a.bid);if(h[g]={edge_idx:a.bid,nei_idx:a.aid,rank:a.aid,vec:util.Vec2.diff(c.pp,b.pp).yComplement()},c.pureHydrogen()?(k++,h[g].rank=1e4):"H"==c.label&&(h[g].rank=5e3),!h[g].vec.normalize())throw new Error("Zero bond length");if(d.type==chem.Struct.BOND.TYPE.TRIPLE)throw new Error("Non-single bonds not allowed near stereocenter");if(d.type==chem.Struct.BOND.TYPE.AROMATIC)throw new Error("Aromatic bonds not allowed near stereocenter");d.type==chem.Struct.BOND.TYPE.DOUBLE&&j++,g++},this),util.find(chem.Stereocenters.allowed_stereocenters,function(a){return a.elem==b.label&&a.charge==b.charge&&a.degree==d&&a.n_double_bonds==j?(e=a.implicit_degree,!0):!1},this),-1==e)throw new Error("Unknown stereocenter configuration: "+b.label+", charge "+b.charge+", "+d+" bonds ("+j+" double)");if(4==d&&k>1)throw new Error(k+" hydrogens near stereocenter");if(3==d&&4==e&&k>0)throw new Error("Has hydrogen(s) besides implicit hydrogen near stereocenter");if(4==d){h[0].rank>h[1].rank&&h.swap(0,1),h[1].rank>h[2].rank&&h.swap(1,2),h[2].rank>h[3].rank&&h.swap(2,3),h[1].rank>h[2].rank&&h.swap(1,2),h[0].rank>h[1].rank&&h.swap(0,1),h[1].rank>h[2].rank&&h.swap(1,2);var l=-1,m=-1,n=-1,o=-1,p=0;for(g=0;4>g;g++){var q=this._getBondStereo(a,h[g].edge_idx);if(q==chem.Struct.BOND.STEREO.UP||q==chem.Struct.BOND.STEREO.DOWN){l=g,p=q;break}}if(-1==l)throw new Error("None of 4 bonds going from stereocenter is stereobond");var r,s;if(-1==m&&(r=chem.Stereocenters._xyzzy(h[l].vec,h[(l+1)%4].vec,h[(l+2)%4].vec),s=chem.Stereocenters._xyzzy(h[l].vec,h[(l+1)%4].vec,h[(l+3)%4].vec),r+s!=3&&r+s!=12||(m=(l+1)%4,n=(l+2)%4,o=(l+3)%4)),-1==m&&(r=chem.Stereocenters._xyzzy(h[l].vec,h[(l+2)%4].vec,h[(l+1)%4].vec),s=chem.Stereocenters._xyzzy(h[l].vec,h[(l+2)%4].vec,h[(l+3)%4].vec),r+s!=3&&r+s!=12||(m=(l+2)%4,n=(l+1)%4,o=(l+3)%4)),-1==m&&(r=chem.Stereocenters._xyzzy(h[l].vec,h[(l+3)%4].vec,h[(l+1)%4].vec),s=chem.Stereocenters._xyzzy(h[l].vec,h[(l+3)%4].vec,h[(l+2)%4].vec),r+s!=3&&r+s!=12||(m=(l+3)%4,n=(l+2)%4,o=(l+1)%4)),-1==m)throw new Error("Internal error: can not find opposite bond");if(p==chem.Struct.BOND.STEREO.UP&&this._getBondStereo(a,h[m].edge_idx)==chem.Struct.BOND.STEREO.DOWN)throw new Error("Stereo types of the opposite bonds mismatch");if(p==chem.Struct.BOND.STEREO.DOWN&&this._getBondStereo(a,h[m].edge_idx)==chem.Struct.BOND.STEREO.UP)throw new Error("Stereo types of the opposite bonds mismatch");if(p==this._getBondStereo(a,h[n].edge_idx))throw new Error("Stereo types of non-opposite bonds match");if(p==this._getBondStereo(a,h[o].edge_idx))throw new Error("Stereo types of non-opposite bonds match");i=3==l||3==m?p:p==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP,z=chem.Stereocenters._sign(h[0].vec,h[1].vec,h[2].vec),i==chem.Struct.BOND.STEREO.UP&&z>0||i==chem.Struct.BOND.STEREO.DOWN&&0>z?(f.pyramid[0]=h[0].nei_idx,f.pyramid[1]=h[1].nei_idx,f.pyramid[2]=h[2].nei_idx):(f.pyramid[0]=h[0].nei_idx,f.pyramid[1]=h[2].nei_idx,f.pyramid[2]=h[1].nei_idx),f.pyramid[3]=h[3].nei_idx}else if(3==d){h[0].rank>h[1].rank&&h.swap(0,1),h[1].rank>h[2].rank&&h.swap(1,2),h[0].rank>h[1].rank&&h.swap(0,1);var t=this._getBondStereo(a,h[0].edge_idx),u=this._getBondStereo(a,h[1].edge_idx),v=this._getBondStereo(a,h[2].edge_idx),w=0,x=0;if(w+=t==chem.Struct.BOND.STEREO.UP?1:0,w+=u==chem.Struct.BOND.STEREO.UP?1:0,w+=v==chem.Struct.BOND.STEREO.UP?1:0,x+=t==chem.Struct.BOND.STEREO.DOWN?1:0,x+=u==chem.Struct.BOND.STEREO.DOWN?1:0,x+=v==chem.Struct.BOND.STEREO.DOWN?1:0,4==e){if(3==w)throw new Error("All 3 bonds up near stereoatom");if(3==x)throw new Error("All 3 bonds down near stereoatom");if(0==w&&0==x)throw new Error("No up/down bonds near stereoatom -- indefinite case");if(1==w&&1==x)throw new Error("One bond up, one bond down -- indefinite case");if(p=0,2==w)i=chem.Struct.BOND.STEREO.DOWN;else if(2==x)i=chem.Struct.BOND.STEREO.UP;else{for(l=-1,n=-1,o=-1,g=0;3>g;g++)if(A=this._getBondStereo(a,h[g].edge_idx),A==chem.Struct.BOND.STEREO.UP||A==chem.Struct.BOND.STEREO.DOWN){l=g,p=A,n=(g+1)%3,o=(g+2)%3;break}if(-1==l)throw new Error("Internal error: can not find up or down bond");var y=chem.Stereocenters._xyzzy(h[n].vec,h[o].vec,h[l].vec);if(3==y||4==y)throw new Error("Degenerate case for 3 bonds near stereoatom");i=1==y?p:p==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP}var z=chem.Stereocenters._sign(h[0].vec,h[1].vec,h[2].vec);i==chem.Struct.BOND.STEREO.UP&&z>0||i==chem.Struct.BOND.STEREO.DOWN&&0>z?(f.pyramid[0]=h[0].nei_idx,f.pyramid[1]=h[1].nei_idx,f.pyramid[2]=h[2].nei_idx):(f.pyramid[0]=h[0].nei_idx,f.pyramid[1]=h[2].nei_idx,f.pyramid[2]=h[1].nei_idx),f.pyramid[3]=-1}else{var A;if(x>0&&w>0)throw new Error("One bond up, one bond down -- indefinite case");if(0==x&&0==w)throw new Error("No up-down bonds attached to stereocenter");A=w>0?1:-1,1!=chem.Stereocenters._xyzzy(h[0].vec,h[1].vec,h[2].vec)&&1!=chem.Stereocenters._xyzzy(h[0].vec,h[2].vec,h[1].vec)&&1!=chem.Stereocenters._xyzzy(h[2].vec,h[1].vec,h[0].vec)||(A=-A),z=chem.Stereocenters._sign(h[0].vec,h[1].vec,h[2].vec),z==A?(f.pyramid[0]=h[0].nei_idx,f.pyramid[1]=h[2].nei_idx,f.pyramid[2]=h[1].nei_idx):(f.pyramid[0]=h[0].nei_idx,f.pyramid[1]=h[1].nei_idx,f.pyramid[2]=h[2].nei_idx),f.pyramid[3]=-1}}this.atoms.set(a,f)},chem.Stereocenters.prototype._getBondStereo=function(a,b){var c=this.molecule.bonds.get(b);return a!=c.begin?0:c.stereo},chem.Stereocenters._xyzzy=function(a,b,c){var d=.001,e=util.Vec2.cross(a,b),f=util.Vec2.dot(a,b),g=util.Vec2.cross(a,c),h=util.Vec2.dot(a,c);if(Math.abs(e)<d){if(Math.abs(g)<d)throw new Error("Degenerate case -- bonds overlap");return g>0?4:8}return-d*d>e*g?2:f>h?2:1},chem.Stereocenters._sign=function(a,b,c){var d=(a.x-c.x)*(b.y-c.y)-(a.y-c.y)*(b.x-c.x),e=.001;if(d>e)return 1;if(-e>d)return-1;throw new Error("Degenerate triangle")},chem.Stereocenters.isPyramidMappingRigid=function(a){var b=a.clone(),c=!0;return b[0]>b[1]&&(b.swap(0,1),c=!c),b[1]>b[2]&&(b.swap(1,2),c=!c),b[2]>b[3]&&(b.swap(2,3),c=!c),b[1]>b[2]&&(b.swap(1,2),c=!c),b[0]>b[1]&&(b.swap(0,1),c=!c),b[1]>b[2]&&(b.swap(1,2),c=!c),c},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");chem.SmilesSaver=function(){this.smiles="",this._written_atoms=new Array,this._written_components=0,this.ignore_errors=!1},chem.SmilesSaver._Atom=function(a){this.neighbours=new Array,this.aromatic=!1,this.lowercase=!1,this.chirality=0,this.branch_cnt=0,this.paren_written=!1,this.h_count=a,this.parent=-1},chem.SmilesSaver.prototype.isBondInRing=function(a){if(util.isUndefined(this.inLoop)||util.isNull(this.inLoop))throw new Error("Init this.inLoop prior to calling this method");return this.inLoop[a]},chem.SmilesSaver.prototype.saveMolecule=function(a,b){var c,d,e;util.isUndefined(b)||(this.ignore_errors=b),a=a.clone(),a.sgroups.each(function(b,c){if("MUL"==c.type)try{c.prepareForSaving(a)}catch(d){throw{message:"Bad s-group ("+d.message+")"}}else if(!this.ignore_errors)throw new Error("SMILES data format doesn't support s-groups")},this),this.atoms=new Array(a.atoms.count()),a.atoms.each(function(a,b){this.atoms[a]=new chem.SmilesSaver._Atom(b.implicitH)},this);var f=["B","C","N","O","P","S","Se","As"];a.bonds.each(function(b,c){c.type==chem.Struct.BOND.TYPE.AROMATIC&&(this.atoms[c.begin].aromatic=!0,-1!=f.indexOf(a.atoms.get(c.begin).label)&&(this.atoms[c.begin].lowercase=!0),this.atoms[c.end].aromatic=!0,-1!=f.indexOf(a.atoms.get(c.end).label)&&(this.atoms[c.end].lowercase=!0)),this.atoms[c.begin].neighbours.push({aid:c.end,bid:b}),this.atoms[c.end].neighbours.push({aid:c.begin,bid:b})},this),this.inLoop=function(){a.prepareLoopStructure();var b=util.Set.empty();a.loops.each(function(c,d){d.hbs.length<=6&&util.Set.mergeIn(b,util.Set.fromList(util.map(d.hbs,function(b){return a.halfBonds.get(b).bid},this)))},this);var c={};return util.Set.each(b,function(a){c[a]=1},this),c}(),this._touched_cistransbonds=0,this._markCisTrans(a);var g=chem.MolfileSaver.getComponents(a),h=g.reactants.concat(g.products),i=new chem.Dfs(a,this.atoms,h,g.reactants.length);for(i.walk(),util.each(this.atoms,function(a){a.neighbours=[]},this),c=0;c<i.v_seq.length;c++){var j=i.v_seq[c],k=j.idx,l=j.parent_edge,m=j.parent_vertex;if(l>=0){var n=this.atoms[k],o=i.numOpeningCycles(l);for(d=0;o>d;d++)this.atoms[m].neighbours.push({aid:-1,bid:-1});if(i.edgeClosingCycle(l)){for(e=0;e<n.neighbours.length;e++)if(-1==n.neighbours[e].aid){n.neighbours[e].aid=m,n.neighbours[e].bid=l;break}if(e==n.neighbours.length)throw new Error("Internal: can not put closing bond to its place")}else n.neighbours.push({aid:m,bid:l}),n.parent=m;this.atoms[m].neighbours.push({aid:k,bid:l})}}try{var p=new chem.Stereocenters(a,function(a){return this.atoms[a].neighbours},this);p.buildFromBonds(this.ignore_errors),p.each(function(a,b){var c=-1;-1==b.pyramid[3]&&(c=3);var f=new Array(4),g=0,h=this.atoms[a];if(-1!=h.parent)for(e=0;4>e;e++)if(b.pyramid[e]==h.parent){f[g++]=e;break}for(-1!=c&&(f[g++]=c),d=0;d!=h.neighbours.length;d++)if(h.neighbours[d].aid!=h.parent)for(e=0;4>e;e++)if(h.neighbours[d].aid==b.pyramid[e]){if(g>=4)throw new Error("Internal: pyramid overflow");f[g++]=e;break}if(4==g)g=f[0],f[0]=f[1],f[1]=f[2],f[2]=f[3],f[3]=g;else if(3!=g)throw new Error("Cannot calculate chirality");chem.Stereocenters.isPyramidMappingRigid(f)?this.atoms[a].chirality=1:this.atoms[a].chirality=2},this)}catch(q){throw new Error(q.message)}var r=new Array;r.push(0);var s=!0;for(c=0;c<i.v_seq.length;c++){j=i.v_seq[c],k=j.idx,l=j.parent_edge,m=j.parent_vertex;var t=!0;if(m>=0){for(i.numBranches(m)>1&&this.atoms[m].branch_cnt>0&&this.atoms[m].paren_written&&(this.smiles+=")"),o=i.numOpeningCycles(l),d=0;o>d;d++){for(e=1;e<r.length&&-1!=r[e];e++);e==r.length?r.push(m):r[e]=m,this._writeCycleNumber(e)}if(m>=0){var u=i.numBranches(m);if(u>1&&this.atoms[m].branch_cnt<u-1&&(i.edgeClosingCycle(l)?this.atoms[m].paren_written=!1:(this.smiles+="(",this.atoms[m].paren_written=!0)),this.atoms[m].branch_cnt++,this.atoms[m].branch_cnt>u)throw new Error("Unexpected branch")}var v=a.bonds.get(l),w=!0,x=0;if(v.type==chem.Struct.BOND.TYPE.SINGLE&&(x=this._calcBondDirection(a,l,m)),1==x&&k==v.end||2==x&&k==v.begin?this.smiles+="/":2==x&&k==v.end||1==x&&k==v.begin?this.smiles+="\\":v.type==chem.Struct.BOND.TYPE.ANY?this.smiles+="~":v.type==chem.Struct.BOND.TYPE.DOUBLE?this.smiles+="=":v.type==chem.Struct.BOND.TYPE.TRIPLE?this.smiles+="#":v.type!=chem.Struct.BOND.TYPE.AROMATIC||this.atoms[v.begin].lowercase&&this.atoms[v.end].lowercase&&this.isBondInRing(l)?v.type==chem.Struct.BOND.TYPE.SINGLE&&this.atoms[v.begin].aromatic&&this.atoms[v.end].aromatic?this.smiles+="-":w=!1:this.smiles+=":",i.edgeClosingCycle(l)){for(d=1;d<r.length&&r[d]!=k;d++);if(d==r.length)throw new Error("Cycle number not found");this._writeCycleNumber(d),r[d]=-1,t=!1}}else s||(this.smiles+=this._written_components==i.nComponentsInReactants?">>":"."),s=!1,this._written_components++;t&&(this._writeAtom(a,k,this.atoms[k].aromatic,this.atoms[k].lowercase,this.atoms[k].chirality),this._written_atoms.push(j.idx))}return this.comma=!1,this._writeRadicals(a),this.comma&&(this.smiles+="|"),this.smiles},chem.SmilesSaver.prototype._writeCycleNumber=function(a){if(a>0&&10>a)this.smiles+=a;else if(a>=10&&100>a)this.smiles+="%"+a;else{if(!(a>=100&&1e3>a))throw new Error("Bad cycle number: "+a);this.smiles+="%%"+a}},chem.SmilesSaver.prototype._writeAtom=function(a,b,c,d,e){var f=a.atoms.get(b),g=!1,h=-1,i=0;if("A"==f.label)return void(this.smiles+="*");if("R"==f.label||"R#"==f.label)return void(this.smiles+="[*]");i=f.aam,"C"!=f.label&&"P"!=f.label&&"N"!=f.label&&"S"!=f.label&&"O"!=f.label&&"Cl"!=f.label&&"F"!=f.label&&"Br"!=f.label&&"B"!=f.label&&"I"!=f.label&&(g=!0),(f.explicitValence>=0||0!=f.radical||e>0||c&&"C"!=f.label&&"O"!=f.label||c&&"C"==f.label&&this.atoms[b].neighbours.length<3&&0==this.atoms[b].h_count)&&(h=this.atoms[b].h_count);var j=f.label;if(f.atomList&&!f.atomList.notList?(j=f.atomList.label(),g=!1):f.isPseudo()||f.atomList&&f.atomList.notList?(j="*",g=!0):(e||0!=f.charge||f.isotope>0||h>=0||i>0)&&(g=!0),g&&(-1==h&&(h=this.atoms[b].h_count),this.smiles+="["),f.isotope>0&&(this.smiles+=f.isotope),d?this.smiles+=j.toLowerCase():this.smiles+=j,e>0&&(1==e?this.smiles+="@":this.smiles+="@@",f.implicitH>1))throw new Error(f.implicitH+" implicit H near stereocenter");"H"!=f.label&&(h>1||0==h&&!g?this.smiles+="H"+h:1==h&&(this.smiles+="H")),f.charge>1?this.smiles+="+"+f.charge:f.charge<-1?this.smiles+=f.charge:1==f.charge?this.smiles+="+":-1==f.charge&&(this.smiles+="-"),i>0&&(this.smiles+=":"+i),g&&(this.smiles+="]")},chem.SmilesSaver.prototype._markCisTrans=function(a){this.cis_trans=new chem.CisTrans(a,function(a){return this.atoms[a].neighbours},this),this.cis_trans.build(),this._dbonds=new Array(a.bonds.count()),a.bonds.each(function(a){this._dbonds[a]={ctbond_beg:-1,ctbond_end:-1,saved:0}},this),this.cis_trans.each(function(b,c){var d=a.bonds.get(b);if(0!=c.parity&&!this.isBondInRing(b)){var e=this.atoms[d.begin].neighbours,f=this.atoms[d.end].neighbours,g=!0,h=!0;if(util.each(e,function(c){c.bid!=b&&a.bonds.get(c.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(g=!1)},this),util.each(f,function(c){c.bid!=b&&a.bonds.get(c.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(h=!1)},this),g||h)return;util.each(e,function(c){c.bid!=b&&(a.bonds.get(c.bid).begin==d.begin?this._dbonds[c.bid].ctbond_beg=b:this._dbonds[c.bid].ctbond_end=b)},this),util.each(f,function(c){c.bid!=b&&(a.bonds.get(c.bid).begin==d.end?this._dbonds[c.bid].ctbond_beg=b:this._dbonds[c.bid].ctbond_end=b)},this)}},this)},chem.SmilesSaver.prototype._updateSideBonds=function(a,b){var c=a.bonds.get(b),d=this.cis_trans.getSubstituents(b),e=this.cis_trans.getParity(b),f=[-1,-1,-1,-1];f[0]=a.findBondId(d[0],c.begin),-1!=d[1]&&(f[1]=a.findBondId(d[1],c.begin)),f[2]=a.findBondId(d[2],c.end),-1!=d[3]&&(f[3]=a.findBondId(d[3],c.end));var g=0,h=0,i=0,j=0;if(0!=this._dbonds[f[0]].saved&&(1==this._dbonds[f[0]].saved&&a.bonds.get(f[0]).begin==c.begin||2==this._dbonds[f[0]].saved&&a.bonds.get(f[0]).end==c.begin?g++:h++),-1!=f[1]&&0!=this._dbonds[f[1]].saved&&(2==this._dbonds[f[1]].saved&&a.bonds.get(f[1]).begin==c.begin||1==this._dbonds[f[1]].saved&&a.bonds.get(f[1]).end==c.begin?g++:h++),0!=this._dbonds[f[2]].saved&&(1==this._dbonds[f[2]].saved&&a.bonds.get(f[2]).begin==c.end||2==this._dbonds[f[2]].saved&&a.bonds.get(f[2]).end==c.end?i++:j++),-1!=f[3]&&0!=this._dbonds[f[3]].saved&&(2==this._dbonds[f[3]].saved&&a.bonds.get(f[3]).begin==c.end||1==this._dbonds[f[3]].saved&&a.bonds.get(f[3]).end==c.end?i++:j++),e==chem.CisTrans.PARITY.CIS?(g+=i,h+=j):(g+=j,h+=i),g>0&&h>0)throw new Error("Incompatible cis-trans configuration");return 0==g&&0==h?!1:(g>0&&(this._dbonds[f[0]].saved=a.bonds.get(f[0]).begin==c.begin?1:2,-1!=f[1]&&(this._dbonds[f[1]].saved=a.bonds.get(f[1]).begin==c.begin?2:1),this._dbonds[f[2]].saved=a.bonds.get(f[2]).begin==c.end==(e==chem.CisTrans.PARITY.CIS)?1:2,-1!=f[3]&&(this._dbonds[f[3]].saved=a.bonds.get(f[3]).begin==c.end==(e==chem.CisTrans.PARITY.CIS)?2:1)),h>0&&(this._dbonds[f[0]].saved=a.bonds.get(f[0]).begin==c.begin?2:1,-1!=f[1]&&(this._dbonds[f[1]].saved=a.bonds.get(f[1]).begin==c.begin?1:2),this._dbonds[f[2]].saved=a.bonds.get(f[2]).begin==c.end==(e==chem.CisTrans.PARITY.CIS)?2:1,-1!=f[3]&&(this._dbonds[f[3]].saved=a.bonds.get(f[3]).begin==c.end==(e==chem.CisTrans.PARITY.CIS)?1:2)),!0)},chem.SmilesSaver.prototype._calcBondDirection=function(a,b,c){var d;if(-1==this._dbonds[b].ctbond_beg&&-1==this._dbonds[b].ctbond_end)return 0;if(a.bonds.get(b).type!=chem.Struct.BOND.TYPE.SINGLE)throw new Error("Internal: directed bond type "+a.bonds.get(b).type);for(;;){if(d=0,this.cis_trans.each(function(b,c){0==c.parity||this.isBondInRing(b)||this._updateSideBonds(a,b)&&d++},this),d==this._touched_cistransbonds)break;this._touched_cistransbonds=d}return 0==this._dbonds[b].saved&&(c==a.bonds.get(b).begin?this._dbonds[b].saved=1:this._dbonds[b].saved=2),this._dbonds[b].saved},chem.SmilesSaver.prototype._writeRadicals=function(a){var b,c,d=new Array(this._written_atoms.length);for(b=0;b<this._written_atoms.length;b++)if(!d[b]){var e=a.atoms.get(this._written_atoms[b]).radical;if(0!=e)for(this.comma?this.smiles+=",":(this.smiles+=" |",this.comma=!0),e==chem.Struct.ATOM.RADICAL.SINGLET?this.smiles+="^3:":e==chem.Struct.ATOM.RADICAL.DOUPLET?this.smiles+="^1:":this.smiles+="^4:",this.smiles+=b,c=b+1;c<this._written_atoms.length;c++)a.atoms.get(this._written_atoms[c]).radical==e&&(d[c]=!0,this.smiles+=","+c)}};